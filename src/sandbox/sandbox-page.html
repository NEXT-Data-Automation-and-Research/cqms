<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sandbox - Conversation | QMS</title>
  <meta name="description" content="Sandbox page to view conversation and chat messages">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
  
  <!-- Global Styles -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/theme.css">
  
  <!-- Import map for npm packages in browser -->
  <script type="importmap">
  {
    "imports": {
      "loglevel": "https://cdn.jsdelivr.net/npm/loglevel@1.9.1/+esm",
      "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm",
      "dompurify": "https://cdn.jsdelivr.net/npm/dompurify@3.3.1/+esm"
    }
  }
  </script>
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      background: var(--background-color);
      color: var(--text-color);
    }
    
    .conversation-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--background-white);
      box-shadow: var(--shadow-lg);
    }
    
    .chat-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-light);
      background: var(--background-white);
    }
    
    .chat-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .chat-client-info {
      flex: 1;
    }
    
    .chat-client-name {
      font-size: var(--font-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-color);
      margin-bottom: 0.25rem;
    }
    
    .chat-client-email {
      font-size: var(--font-base);
      color: var(--text-secondary);
    }
    
    .chat-attributes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    
    .attribute-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--gray-50);
      border-radius: 0.5rem;
      font-size: var(--font-sm);
      border: 1px solid var(--border-light);
    }
    
    .attribute-label {
      color: var(--text-secondary);
      font-weight: var(--font-weight-medium);
    }
    
    .attribute-value {
      color: var(--text-color);
      font-weight: var(--font-weight-semibold);
    }
    
    .csat-badge {
      background: var(--success-color);
      color: var(--white);
      border-color: var(--success-color);
    }
    
    .csat-badge .attribute-label,
    .csat-badge .attribute-value {
      color: var(--white);
    }
    
    .channel-badge {
      background: var(--info-color);
      color: var(--white);
      border-color: var(--info-color);
    }
    
    .channel-badge .attribute-label,
    .channel-badge .attribute-value {
      color: var(--white);
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      background: var(--background-color);
    }
    
    .message {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.client {
      flex-direction: row;
    }
    
    .message.agent {
      flex-direction: row-reverse;
    }
    
    .message-avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-sm);
      flex-shrink: 0;
    }
    
    .message.client .message-avatar {
      background: var(--info-color);
      color: var(--white);
    }
    
    .message.agent .message-avatar {
      background: var(--primary-color);
      color: var(--white);
    }
    
    .message-content {
      flex: 1;
      max-width: 70%;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    
    .message-sender {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-sm);
      color: var(--text-color);
    }
    
    .message-time {
      font-size: var(--font-xs);
      color: var(--text-muted);
    }
    
    .message-bubble {
      padding: 0.875rem 1rem;
      border-radius: 1rem;
      line-height: var(--line-height-normal);
      font-size: var(--font-base);
      word-wrap: break-word;
    }
    
    .message.client .message-bubble {
      background: var(--background-white);
      color: var(--text-color);
      border: 1px solid var(--border-light);
      border-bottom-left-radius: 0.25rem;
      box-shadow: var(--shadow-sm);
    }
    
    .message.agent .message-bubble {
      background: var(--primary-color);
      color: var(--white);
      border-bottom-right-radius: 0.25rem;
      box-shadow: var(--shadow-md);
    }
    
    .message-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: var(--font-xs);
      color: var(--text-muted);
    }
    
    .message-status {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .loading-state, .error-state, .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--text-secondary);
      height: 100%;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 2rem;
      height: 2rem;
      border: 3px solid var(--border-light);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-state {
      color: var(--error-color);
    }
    
    .empty-state {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="conversation-container">
    <div id="chatHeader" class="chat-header">
      <div class="chat-header-top">
        <div class="chat-client-info">
          <div class="chat-client-name" id="chatClientName">John Doe</div>
          <div class="chat-client-email" id="chatClientEmail">john.doe@example.com</div>
        </div>
      </div>
      <div class="chat-attributes" id="chatAttributes"></div>
    </div>
    <div id="messagesContainer" class="messages-container">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p style="margin-top: 1rem;">Loading conversation...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { getAuthenticatedSupabase } from '/js/utils/authenticated-supabase.js';
    import { initSupabase } from '/js/utils/supabase-init.js';
    
    // Initialize Supabase first
    await initSupabase();
    
    const chatHeader = document.getElementById('chatHeader');
    const messagesContainer = document.getElementById('messagesContainer');
    const chatClientName = document.getElementById('chatClientName');
    const chatClientEmail = document.getElementById('chatClientEmail');
    const chatAttributes = document.getElementById('chatAttributes');
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
    
    function formatTime(timestamp) {
      if (!timestamp) return '';
      try {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch {
        return '';
      }
    }
    
    function formatFullDate(timestamp) {
      if (!timestamp) return '';
      try {
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch {
        return '';
      }
    }
    
    // Generate realistic dummy conversation data with simulated timing
    function generateDummyConversation() {
      const baseTime = Date.now() - (3 * 60 * 60 * 1000); // 3 hours ago
      let currentTime = baseTime;
      
      // Helper to add time and get timestamp
      const addTime = (minutes) => {
        currentTime += minutes * 60 * 1000;
        return new Date(currentTime).toISOString();
      };
      
      const conversation = {
        id: 'conv_' + Math.random().toString(36).substr(2, 9),
        clientName: 'Emily Rodriguez',
        clientEmail: 'emily.rodriguez@techcorp.com',
        subject: 'Billing inquiry - Unexpected charge on subscription',
        tags: ['billing', 'subscription', 'urgent'],
        csat: 4,
        cxScore: 88,
        channel: 'chat',
        length: 3240, // 54 minutes in seconds
        errorsDetected: 0,
        created: new Date(baseTime).toISOString(),
        messages: [
          {
            id: 'msg_1',
            sender: 'client',
            senderName: 'Emily Rodriguez',
            content: 'Hello, I noticed an unexpected charge on my credit card today. Can someone help me understand what this is for?',
            timestamp: addTime(0),
            status: 'delivered'
          },
          {
            id: 'msg_2',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'Hi Emily! I\'m Michael, and I\'d be happy to help you with that. Let me pull up your account to review the recent charges.',
            timestamp: addTime(2),
            status: 'read'
          },
          {
            id: 'msg_3',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'I can see that you have a monthly subscription for our Premium plan that was renewed yesterday. The charge amount is $49.99. Is this the charge you\'re referring to?',
            timestamp: addTime(1),
            status: 'read'
          },
          {
            id: 'msg_4',
            sender: 'client',
            senderName: 'Emily Rodriguez',
            content: 'Yes, that\'s the one. But I thought I cancelled my subscription last month. I sent an email about it.',
            timestamp: addTime(3),
            status: 'delivered'
          },
          {
            id: 'msg_5',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'I understand your concern. Let me check the cancellation status in your account history.',
            timestamp: addTime(2),
            status: 'read'
          },
          {
            id: 'msg_6',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'I can see that you did initiate a cancellation request on March 15th, but it looks like the cancellation didn\'t complete because there was an issue with the final payment processing. The system attempted to charge your card before the cancellation could be finalized.',
            timestamp: addTime(4),
            status: 'read'
          },
          {
            id: 'msg_7',
            sender: 'client',
            senderName: 'Emily Rodriguez',
            content: 'Oh, I see. So what happens now? Will I be refunded?',
            timestamp: addTime(2),
            status: 'delivered'
          },
          {
            id: 'msg_8',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'Absolutely! Since the cancellation was initiated before the renewal, I can process a full refund for you right now. You\'ll see the refund in your account within 5-7 business days.',
            timestamp: addTime(3),
            status: 'read'
          },
          {
            id: 'msg_9',
            sender: 'client',
            senderName: 'Emily Rodriguez',
            content: 'That would be great, thank you! And just to confirm, my subscription is now cancelled, right?',
            timestamp: addTime(1),
            status: 'delivered'
          },
          {
            id: 'msg_10',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'Yes, I\'ve confirmed the cancellation is now complete. You won\'t be charged again, and you\'ll continue to have access to Premium features until the end of your current billing period (April 30th).',
            timestamp: addTime(2),
            status: 'read'
          },
          {
            id: 'msg_11',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'I\'ve also processed the refund. You should receive a confirmation email shortly. Is there anything else I can help you with today?',
            timestamp: addTime(1),
            status: 'read'
          },
          {
            id: 'msg_12',
            sender: 'client',
            senderName: 'Emily Rodriguez',
            content: 'No, that\'s perfect! Thank you so much for your help, Michael. I really appreciate it.',
            timestamp: addTime(2),
            status: 'delivered'
          },
          {
            id: 'msg_13',
            sender: 'agent',
            senderName: 'Michael Chen',
            content: 'You\'re very welcome, Emily! I\'m glad I could help resolve this for you. If you have any other questions or decide you\'d like to reactivate your subscription in the future, feel free to reach out. Have a wonderful day!',
            timestamp: addTime(1),
            status: 'read'
          }
        ]
      };
      
      return conversation;
    }
    
    const conversation = generateDummyConversation();
    
    function renderConversation() {
      // Update chat header
      chatClientName.textContent = conversation.clientName;
      chatClientEmail.textContent = conversation.clientEmail;
      
      // Render attributes
      const attributes = [];
      if (conversation.csat) {
        attributes.push(`
          <div class="attribute-item csat-badge">
            <span class="attribute-label">CSAT:</span>
            <span class="attribute-value">${conversation.csat}/5</span>
          </div>
        `);
      }
      if (conversation.cxScore !== undefined) {
        attributes.push(`
          <div class="attribute-item">
            <span class="attribute-label">CX Score:</span>
            <span class="attribute-value">${conversation.cxScore}</span>
          </div>
        `);
      }
      attributes.push(`
        <div class="attribute-item channel-badge">
          <span class="attribute-label">Channel:</span>
          <span class="attribute-value">${escapeHtml(conversation.channel || 'chat')}</span>
        </div>
      `);
      if (conversation.length) {
        const minutes = Math.floor(conversation.length / 60);
        attributes.push(`
          <div class="attribute-item">
            <span class="attribute-label">Duration:</span>
            <span class="attribute-value">${minutes}m</span>
          </div>
        `);
      }
      if (conversation.errorsDetected !== undefined) {
        attributes.push(`
          <div class="attribute-item">
            <span class="attribute-label">Errors:</span>
            <span class="attribute-value">${conversation.errorsDetected}</span>
          </div>
        `);
      }
      if (conversation.tags && conversation.tags.length > 0) {
        attributes.push(`
          <div class="attribute-item">
            <span class="attribute-label">Tags:</span>
            <span class="attribute-value">${conversation.tags.map(t => escapeHtml(t)).join(', ')}</span>
          </div>
        `);
      }
      
      chatAttributes.innerHTML = attributes.join('');
      
      // Render messages
      renderMessages(conversation.messages || []);
    }
    
    function renderMessages(messages) {
      if (!messages || messages.length === 0) {
        messagesContainer.innerHTML = `
          <div class="empty-state">
            <p>No messages in this conversation</p>
          </div>
        `;
        return;
      }
      
      const html = messages.map(msg => {
        const isClient = msg.sender === 'client';
        const initials = getInitials(msg.senderName);
        const time = formatTime(msg.timestamp);
        const fullTime = formatFullDate(msg.timestamp);
        
        return `
          <div class="message ${isClient ? 'client' : 'agent'}">
            <div class="message-avatar">${initials}</div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-sender">${escapeHtml(msg.senderName)}</span>
                <span class="message-time" title="${fullTime}">${time}</span>
              </div>
              <div class="message-bubble">${escapeHtml(msg.content)}</div>
              ${!isClient ? `
                <div class="message-meta">
                  <span class="message-status">
                    ${msg.status === 'read' ? '✓✓ Read' : msg.status === 'delivered' ? '✓✓ Delivered' : '✓ Sent'}
                  </span>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      messagesContainer.innerHTML = html;
      
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Simulate loading conversation with delay for realism
    async function loadConversation() {
      // Show loading state
      messagesContainer.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p style="margin-top: 1rem;">Loading conversation...</p>
        </div>
      `;
      
      // Simulate network delay
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // Render the conversation
      renderConversation();
    }
    
    // Load conversation when page loads
    loadConversation();
  </script>
</body>
</html>
