<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/js/console-stub.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in | QMS</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
    <link rel="stylesheet" href="/styles.css">
    <script type="importmap">
    {"imports":{"loglevel":"https://cdn.jsdelivr.net/npm/loglevel@1.9.1/+esm","@supabase/supabase-js":"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm","dompurify":"https://cdn.jsdelivr.net/npm/dompurify@3.3.1/+esm"}}
    </script>
    <style>
        /* Typewriter cursor */
        #typewriterCursor { animation: blink 0.8s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        /* Display typography: Poppins everywhere */
        .font-display { font-family: 'Poppins', var(--font-family-primary, sans-serif), sans-serif; }
        /* Scroll indicator: gentle bounce down */
        #scrollIndicator { animation: scrollBounce 2s ease-in-out infinite; }
        @keyframes scrollBounce {
            0%, 100% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(8px); opacity: 0.85; }
        }
        /* First section: exactly one viewport so scroll icon is always visible at 100% zoom */
        .auth-viewport {
            height: 100vh;
            height: 100dvh;
            max-height: 100vh;
            max-height: 100dvh;
        }
        /* Hero "Every Detail Matters." – explicit font-size so it applies (avoids Tailwind purge/build issues) */
        #typewriterHeading {
            font-size: 5rem;
        }
        @media (min-width: 640px) {
            #typewriterHeading { font-size: 5rem; }
        }
        @media (min-width: 1280px) {
            #typewriterHeading { font-size: 5rem; }
        }
        /* Easter egg: animate in when visible */
        #cqmsBrand.egg-visible,
        #cqmsFooter.egg-visible {
            animation: eggReveal 0.5s ease-out forwards;
        }
        @keyframes eggReveal {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(4px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        /* Easter egg video overlay */
        #eggVideoOverlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            background: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.35s ease, visibility 0.35s ease;
        }
        #eggVideoOverlay.show {
            opacity: 1;
            visibility: visible;
        }
        /* Visible frame around the video + "Made with love" (no recommendations bleed) */
        #eggVideoOverlay .egg-frame {
            width: min(90vw, 560px);
            border: 3px solid #1A733E;
            border-radius: 0.5rem;
            overflow: hidden;
            background: #0d0d0d;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        #eggVideoOverlay .egg-video-wrap {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
        }
        #eggVideoOverlay .egg-video-wrap iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* "Made with love" inside the frame, below the video */
        #eggVideoOverlay .egg-overlay-text {
            display: block;
            padding: 0.75rem 1rem;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #E0FFB3;
            text-align: center;
            background: #1A733E;
            pointer-events: none;
        }
        #eggVideoOverlay .egg-close-hint {
            font-family: 'Poppins', sans-serif;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen antialiased">
    <!-- Fixed viewport: only login visible on load; height = viewport so scroll icon is visible at 100% zoom -->
    <section class="auth-viewport relative flex overflow-hidden shrink-0" aria-label="Sign in">
    <div class="min-h-0 flex-1 w-full flex overflow-hidden">
        <!-- Left: Brand -->
        <div class="hidden lg:flex lg:w-[70%] lg:min-w-0 flex-col justify-between bg-[#1A733E] p-6 lg:p-10 xl:p-14 overflow-hidden">
            <div class="min-h-0 flex-shrink">
                <h1 id="typewriterHeading" class="font-extrabold tracking-tight text-[#E0FFB3] leading-[1.1] min-h-[1.2em]">
                    <span id="typewriterText"></span><span id="typewriterCursor" aria-hidden="true">|</span>
                </h1>
                <p id="typewriterSubline" class="mt-3 text-[#E0FFB3] text-base opacity-0 translate-y-4 transition-all duration-700 ease-out">The art of perfection begins here.</p>
            </div>
            <div class="flex flex-col gap-1 items-start flex-shrink-0">
                <img src="https://careers.recruiteecdn.com/image/upload/production/images/BpRN/wCefCTnrj5fG.png" alt="NEXT Ventures" class="h-8 w-auto object-contain object-left opacity-90 -ml-[0.4rem]" width="160" height="32" loading="lazy">
                <p id="cqmsBrand" class="text-[#E0FFB3] text-base lg:text-lg xl:text-xl font-bold">Communications Quality Management System</p>
            </div>
        </div>

        <!-- Right: Sign in (full width on mobile, left panel hidden) -->
        <div class="flex-1 min-w-0 min-h-0 flex flex-col lg:flex-row lg:items-center lg:justify-center bg-[#F6F5F0] p-4 sm:p-6 lg:p-10 overflow-auto">
            <!-- Mobile: minimal brand -->
            <div class="lg:hidden mb-4 sm:mb-6 flex justify-start flex-shrink-0">
                <img src="https://careers.recruiteecdn.com/image/upload/production/images/BpRN/wCefCTnrj5fG.png" alt="NEXT Ventures" class="h-7 w-auto object-contain object-left opacity-80" width="140" height="28" loading="eager">
            </div>
            <div class="w-full max-w-[360px] lg:mx-0 mx-auto text-center flex-shrink-0">
                <h2 class="text-xl sm:text-2xl font-semibold text-slate-900 tracking-tight">Sign in</h2>
                <p class="mt-1 text-slate-500 text-sm">Use your work account to continue.</p>

                <form id="loginForm" class="mt-4 sm:mt-6 lg:mt-8">
                    <div class="space-y-3 flex flex-col items-center">
                        <button
                            type="button"
                            id="googleSignInButton"
                            class="w-auto min-w-[240px] flex items-center justify-center gap-3 rounded-full border border-[#dadce0] bg-white py-2.5 px-5 text-sm font-bold text-black transition hover:bg-[#f8f9fa] focus:outline-none focus:ring-2 focus:ring-[#1a73e8]/30 disabled:opacity-60">
                            <svg id="googleIcon" class="h-5 w-5 flex-shrink-0" viewBox="0 0 18 18" fill="none" aria-hidden="true">
                                <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                                <path d="M9 18c2.43 0 4.467-.806 5.965-2.184l-2.908-2.258c-.806.54-1.837.86-3.057.86-2.35 0-4.34-1.587-5.053-3.72H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                                <path d="M3.947 10.698c-.18-.54-.282-1.117-.282-1.698s.102-1.158.282-1.698V4.97H.957C.348 6.175 0 7.55 0 9s.348 2.825.957 4.03l2.99-2.332z" fill="#FBBC05"/>
                                <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.97L3.947 7.302C4.66 5.167 6.65 3.58 9 3.58z" fill="#EA4335"/>
                            </svg>
                            <span id="googleButtonContent" class="flex flex-col items-start leading-tight">
                                <span id="googleButtonText">Sign in with Google</span>
                            </span>
                        </button>
                        <p id="googleError" class="text-sm text-red-600 empty:hidden text-center"></p>

                        <!-- Sign out link (shown only when already signed in) -->
                        <button type="button" id="signOutButton" class="hidden text-xs text-slate-500 hover:text-slate-700 underline underline-offset-2 transition-colors">
                            Sign out
                        </button>
                    </div>
                </form>

                <!-- Dev bypass (shown only in dev) -->
                <div id="devBypassSection" class="mt-8 hidden rounded-lg border border-dashed border-slate-300 bg-slate-100/50 p-4">
                    <p class="text-xs font-medium text-slate-500">Dev: Bypass auth</p>
                    <input type="email" id="devEmailInput" value="dev@test.com" class="mt-2 w-full rounded border border-slate-200 px-3 py-2 text-sm" placeholder="Email">
                    <button type="button" id="devBypassButton" class="mt-2 w-full rounded-lg bg-slate-700 px-3 py-2 text-sm font-medium text-white hover:bg-slate-800">Bypass (dev only)</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Scroll indicator: overlay layer at bottom center; always visible because section height = viewport -->
    <div class="absolute inset-0 pointer-events-none z-10 flex items-end justify-center pb-4 flex-shrink-0" aria-hidden="true">
        <a href="#features" id="scrollIndicator" class="pointer-events-auto flex flex-col items-center text-black/50 hover:text-black/60 focus:outline-none focus-visible:ring-2 focus-visible:ring-black/30 focus-visible:ring-offset-2 focus-visible:ring-offset-[#F6F5F0] rounded-full transition-colors shrink-0" aria-label="Scroll down to learn more">
            <svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48" fill="currentColor" class="w-9 h-9 sm:w-10 sm:h-10 lg:w-12 lg:h-12" aria-hidden="true"><path d="M481-350q-8 0-14.5-2.5T455-361L255-561q-11-10-10.5-25.5T256-613q11-10 26-10t26 10l173 174 173-174q11-10 25.5-9.5T705-612q11 11 11 26.5T705-560L506-361q-5 6-11.5 8.5T481-350Z"/></svg>
        </a>
    </div>
    </section>

    <!-- Easter egg: YouTube in a frame with "Made with love"; click outside to close -->
    <div id="eggVideoOverlay" aria-hidden="true" role="dialog" aria-label="Easter egg video">
        <div class="egg-frame">
            <div class="egg-video-wrap">
                <iframe id="eggYouTubeIframe" width="560" height="315" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
            <p class="egg-overlay-text">Made with ❤️ by Team DAR | 2026</p>
        </div>
        <p class="egg-close-hint">Click outside the frame to close</p>
    </div>

    <!-- Features: luxury showcase below the fold (theme: cream + green) -->
    <section id="features" class="relative bg-[#F6F5F0] text-slate-900 overflow-hidden" aria-label="Platform features">
        <!-- Subtle grid texture -->
        <div class="absolute inset-0 opacity-[0.04]" style="background-image: linear-gradient(#1A733E 1px, transparent 1px), linear-gradient(90deg, #1A733E 1px, transparent 1px); background-size: 64px 64px;"></div>

        <div class="relative max-w-7xl mx-auto px-6 sm:px-10 py-24 lg:py-32">
            <!-- Section label -->
            <p class="font-display text-[#1A733E] text-sm uppercase tracking-[0.35em] mb-4">Why QMS</p>
            <h2 class="font-display text-4xl sm:text-5xl lg:text-6xl font-normal tracking-tight text-slate-900 max-w-3xl leading-[1.15]">
                Where quality meets clarity.
            </h2>
            <p class="mt-6 text-lg text-slate-600 max-w-xl leading-relaxed">
                One platform to audit, measure, and elevate every communication. Built for teams that refuse to compromise.
            </p>

            <!-- Feature blocks -->
            <div class="mt-20 lg:mt-28 grid gap-px sm:grid-cols-2 lg:grid-cols-3 bg-[#1A733E]/10 rounded-2xl overflow-hidden border border-[#1A733E]/20">
                <article class="group bg-white hover:bg-[#1A733E] p-8 lg:p-10 flex flex-col border border-slate-200/80 hover:border-[#1A733E] transition-colors duration-300">
                    <div class="w-12 h-12 rounded-xl bg-[#1A733E]/15 group-hover:bg-white/20 flex items-center justify-center mb-6 transition-colors duration-300">
                        <svg class="w-6 h-6 text-[#1A733E] group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                    </div>
                    <h3 class="font-display text-xl lg:text-2xl text-slate-900 group-hover:text-white font-medium transition-colors duration-300">Quality Audits</h3>
                    <p class="mt-3 text-slate-600 group-hover:text-white text-sm lg:text-base leading-relaxed transition-colors duration-300">Structured evaluations with clear criteria. Score calls, emails, and interactions—then act on what matters.</p>
                </article>
                <article class="group bg-white hover:bg-[#1A733E] p-8 lg:p-10 flex flex-col border border-slate-200/80 hover:border-[#1A733E] transition-colors duration-300">
                    <div class="w-12 h-12 rounded-xl bg-[#1A733E]/15 group-hover:bg-white/20 flex items-center justify-center mb-6 transition-colors duration-300">
                        <svg class="w-6 h-6 text-[#1A733E] group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    </div>
                    <h3 class="font-display text-xl lg:text-2xl text-slate-900 group-hover:text-white font-medium transition-colors duration-300">Reporting & Analytics</h3>
                    <p class="mt-3 text-slate-600 group-hover:text-white text-sm lg:text-base leading-relaxed transition-colors duration-300">Dashboards and trends at a glance. From team performance to compliance—decisions backed by data.</p>
                </article>
                <article class="group bg-white hover:bg-[#1A733E] p-8 lg:p-10 flex flex-col sm:col-span-2 lg:col-span-1 border border-slate-200/80 hover:border-[#1A733E] transition-colors duration-300">
                    <div class="w-12 h-12 rounded-xl bg-[#1A733E]/15 group-hover:bg-white/20 flex items-center justify-center mb-6 transition-colors duration-300">
                        <svg class="w-6 h-6 text-[#1A733E] group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <h3 class="font-display text-xl lg:text-2xl text-slate-900 group-hover:text-white font-medium transition-colors duration-300">Communications Hub</h3>
                    <p class="mt-3 text-slate-600 group-hover:text-white text-sm lg:text-base leading-relaxed transition-colors duration-300">Centralize every channel. Review, tag, and improve how your team communicates—internally and with customers.</p>
                </article>
            </div>

            <!-- Bottom line -->
            <div class="mt-20 lg:mt-24 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6 pt-12 border-t border-[#1A733E]/20">
                <p class="font-display text-2xl sm:text-3xl text-[#1A733E]">Every detail matters.</p>
                <p id="cqmsFooter" class="text-slate-600 text-sm max-w-md">NEXT Ventures · Communications Quality Management System</p>
            </div>
        </div>
    </section>

    <!-- Hidden forms for script compatibility -->
    <form id="resetForm" class="hidden" aria-hidden="true">
        <div id="messageContainer"></div>
        <input type="email" id="resetEmail" placeholder="Email">
        <button type="submit" id="submitReset">Send reset link</button>
        <a href="#" id="backToLogin">Back to login</a>
    </form>

    <script type="module">
        /* Typewriter: "Every detail" then "matters." – one letter at a time */
        (function runTypewriter() {
            const textEl = document.getElementById('typewriterText');
            const cursorEl = document.getElementById('typewriterCursor');
            if (!textEl || !cursorEl) return;
            const line1 = 'Every Detail';
            const line2 = 'Matters.';
            const full = line1 + '\n' + line2;
            let i = 0;
            const ms = 85;
            function type() {
                if (i < full.length) {
                    textEl.innerHTML += full[i] === '\n' ? '<br>' : full[i];
                    i++;
                    setTimeout(type, ms);
                } else {
                    cursorEl.style.display = 'none';
                    const sub = document.getElementById('typewriterSubline');
                    if (sub) sub.classList.add('opacity-100', 'translate-y-0');
                }
            }
            setTimeout(type, 400);
        })();

        /* Easter egg: type D-A-R → YouTube plays with sound, text on overlay; video stays until you close it */
        (function initEasterEgg() {
            const EGG_TEXT = 'Made with ❤️ by Team DAR | 2026';
            const GO_AWAY_TEXT = 'Go away';
            const YOUTUBE_EMBED = 'https://www.youtube.com/embed/Aq5WXmQQooo?si=hD5brYF2voyo6asZ&autoplay=1&rel=0&modestbranding=1';
            const brandEl = document.getElementById('cqmsBrand');
            const footerEl = document.getElementById('cqmsFooter');
            const overlayEl = document.getElementById('eggVideoOverlay');
            const iframeEl = document.getElementById('eggYouTubeIframe');
            const brandOriginal = brandEl ? brandEl.textContent : '';
            const footerOriginal = footerEl ? footerEl.textContent : '';
            var eggTimeout = null;
            function setText(el, text, addClass) {
                if (!el) return;
                el.textContent = text;
                if (addClass) el.classList.add('egg-visible'); else el.classList.remove('egg-visible');
            }
            function showVideo() {
                if (overlayEl) overlayEl.classList.add('show');
                if (iframeEl) iframeEl.src = YOUTUBE_EMBED;
            }
            function hideVideo() {
                if (overlayEl) overlayEl.classList.remove('show');
                if (iframeEl) iframeEl.src = '';
                setText(brandEl, brandOriginal, false);
                setText(footerEl, footerOriginal, false);
                if (eggTimeout) {
                    clearTimeout(eggTimeout);
                    eggTimeout = null;
                }
            }
            function runEgg() {
                if (overlayEl && overlayEl.classList.contains('show')) {
                    hideVideo();
                    return;
                }
                if (eggTimeout) {
                    clearTimeout(eggTimeout);
                    eggTimeout = null;
                }
                setText(brandEl, EGG_TEXT, true);
                setText(footerEl, EGG_TEXT, true);
                showVideo();
                eggTimeout = setTimeout(function () {
                    setText(brandEl, GO_AWAY_TEXT, false);
                    setText(footerEl, GO_AWAY_TEXT, false);
                    eggTimeout = setTimeout(function () {
                        setText(brandEl, brandOriginal, false);
                        setText(footerEl, footerOriginal, false);
                        eggTimeout = null;
                    }, 2000);
                }, 3500);
            }
            if (overlayEl) {
                overlayEl.addEventListener('click', function (e) {
                    if (e.target === overlayEl || e.target.closest('.egg-close-hint')) hideVideo();
                });
            }
            var keySeq = '';
            var keySeqReset = null;
            document.addEventListener('keydown', function (e) {
                keySeq += e.key.toLowerCase();
                if (keySeq.length > 3) keySeq = keySeq.slice(-3);
                if (keySeq === 'dar') {
                    keySeq = '';
                    runEgg();
                }
                clearTimeout(keySeqReset);
                keySeqReset = setTimeout(function () { keySeq = ''; }, 1500);
            });
        })();

        import { initSupabase, getSupabase } from '/js/utils/supabase-init.js';
        import { signInWithGoogle, handleGoogleOAuthCallback, enableDevBypassAuthentication, signOut } from '/js/utils/auth.js';

        function isDevModeEnabled() {
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.endsWith('.local');
            const urlParams = new URLSearchParams(window.location.search);
            const isDevMode = isLocalhost && (urlParams.get('dev') === 'true' || localStorage.getItem('isDev') === 'true' || (typeof window.DEV_MODE !== 'undefined' && window.DEV_MODE === true));
            if (isDevMode) console.log('[Auth] Dev mode enabled');
            return isDevMode;
        }

        const isDev = isDevModeEnabled();
        if (isDev) {
            const el = document.getElementById('devBypassSection');
            if (el) el.classList.remove('hidden');
        }

        let supabaseInitialized = false;
        async function initializeSupabase() {
            try {
                await initSupabase();
                supabaseInitialized = true;
            } catch (e) {
                console.error('Supabase init failed:', e);
            }
        }
        await initializeSupabase();

        // Do not redirect localhost OAuth callbacks to production — keep local dev on localhost after login

        let callbackHandlingInProgress = false;
        let callbackHandled = false;
        
        // ✅ FIX: Detect OAuth params immediately (synchronously) and set flag BEFORE any async work
        // This prevents auth-checker from racing and causing double redirects
        (function setOAuthFlagImmediately() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlHash = window.location.hash;
            const hasOAuthParams = urlParams.get('code') || urlParams.get('access_token') || urlHash.includes('access_token') || urlHash.includes('code');
            if (hasOAuthParams) {
                // Set flag immediately so auth-checker knows OAuth is being handled
                sessionStorage.setItem('oauthCallbackInProgress', 'true');
                window.__oauthCallbackInProgress = true;
                console.log('[Auth] OAuth params detected, flag set to prevent auth-checker race');
            }
        })();
        
        async function checkAndHandleCallback() {
            if (callbackHandlingInProgress || callbackHandled) return false;
            if (!supabaseInitialized) await initializeSupabase();
            const supabase = getSupabase();
            if (!supabase) return false;
            const urlParams = new URLSearchParams(window.location.search);
            const urlHash = window.location.hash;
            const hasOAuthParams = urlParams.get('code') || urlParams.get('access_token') || urlHash.includes('access_token') || urlHash.includes('code');
            if (!hasOAuthParams) return false;
            callbackHandlingInProgress = true;
            try {
                await handleGoogleOAuthCallback();
                callbackHandled = true;
                return true;
            } catch (e) {
                console.error('OAuth callback error:', e);
                // Clear the flag on error so user can try again
                sessionStorage.removeItem('oauthCallbackInProgress');
                delete window.__oauthCallbackInProgress;
                return false;
            } finally {
                callbackHandlingInProgress = false;
            }
        }

        const handled = await checkAndHandleCallback();
        if (!handled) {
            function setGoogleButtonLabel(text) {
                const el = document.getElementById('googleButtonText');
                if (el) el.textContent = text;
            }

            const btn = document.getElementById('googleSignInButton');
            const errEl = document.getElementById('googleError');
            if (btn) {
                btn.addEventListener('click', async () => {
                    // If in continue mode, just redirect to home
                    if (btn.dataset.continueMode === 'true') {
                        window.location.replace('/home');
                        return;
                    }
                    
                    if (!supabaseInitialized) await initializeSupabase();
                    // Allow switching accounts even if an existing session is present.
                    // If a session exists, sign out first (without redirect) and then start OAuth.
                    try {
                        const supabase = getSupabase();
                        if (supabase) {
                            const { data: { session } } = await supabase.auth.getSession();
                            if (session?.user) {
                                try {
                                    await supabase.auth.signOut({ scope: 'local' });
                                } catch (_) {
                                    // Ignore sign out errors and continue to OAuth
                                }
                                try {
                                    localStorage.removeItem('userInfo');
                                } catch (_) {}
                            }
                        }
                    } catch (_) {
                        // Ignore session check errors and continue
                    }
                    if (errEl) errEl.textContent = '';
                    btn.disabled = true;
                    setGoogleButtonLabel('Redirecting…');
                    try {
                        await signInWithGoogle();
                    } catch (e) {
                        if (errEl) errEl.textContent = e.message || 'Sign in failed. Try again.';
                        btn.disabled = false;
                        setGoogleButtonLabel('Sign in with Google');
                    }
                });
            }

            if (isDev) {
                const bypassBtn = document.getElementById('devBypassButton');
                const emailInput = document.getElementById('devEmailInput');
                if (bypassBtn && emailInput) {
                    bypassBtn.addEventListener('click', () => {
                        enableDevBypassAuthentication(emailInput.value.trim() || 'dev@test.com');
                        window.location.href = '/src/features/home/presentation/home-page.html';
                    });
                }
            }

            // If user is already authenticated, transform the sign-in button into a "Continue as" button.
            // This avoids the multi-tab case where a second tab can't reach the login page to switch accounts.
            try {
                const supabase = getSupabase();
                if (supabase) {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session?.user?.email) {
                        const googleBtn = document.getElementById('googleSignInButton');
                        const googleIcon = document.getElementById('googleIcon');
                        const googleButtonContent = document.getElementById('googleButtonContent');
                        const googleButtonText = document.getElementById('googleButtonText');
                        const signOutBtn = document.getElementById('signOutButton');

                        if (googleBtn && googleButtonContent && googleButtonText) {
                            // Transform button to "Continue as" style - white with shadow for contrast
                            googleBtn.classList.remove('py-2.5', 'px-5', 'min-w-[240px]');
                            googleBtn.classList.add('py-3', 'px-5', 'min-w-[280px]', 'shadow-lg', 'shadow-black/10', 'hover:shadow-xl', 'hover:shadow-black/15', 'hover:-translate-y-0.5', 'active:translate-y-0', 'border-slate-200');
                            
                            // Hide the Google icon
                            if (googleIcon) googleIcon.classList.add('hidden');
                            
                            // Get user avatar (from Google OAuth metadata)
                            const avatarUrl = session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture || '';
                            const userName = session.user.user_metadata?.full_name || session.user.user_metadata?.name || '';
                            
                            // Update button content to show profile picture, name/email, and continue
                            googleButtonContent.innerHTML = `
                                <span class="flex items-center gap-3 w-full">
                                    ${avatarUrl 
                                        ? `<img src="${avatarUrl}" alt="" class="w-10 h-10 rounded-full object-cover flex-shrink-0 ring-2 ring-slate-100" referrerpolicy="no-referrer">`
                                        : `<span class="w-10 h-10 rounded-full bg-[#1A733E] flex items-center justify-center flex-shrink-0 text-white font-semibold text-sm">${(userName || session.user.email || '?').charAt(0).toUpperCase()}</span>`
                                    }
                                    <span class="flex flex-col items-start text-left flex-1 min-w-0">
                                        <span class="text-slate-500 text-xs font-normal">Continue as</span>
                                        <span class="text-slate-900 font-semibold text-sm truncate w-full">${userName || session.user.email}</span>
                                    </span>
                                    <svg class="w-5 h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </span>
                            `;
                            
                            // Mark button as continue mode
                            googleBtn.dataset.continueMode = 'true';
                        }
                        
                        // Show sign out link
                        if (signOutBtn) {
                            signOutBtn.classList.remove('hidden');
                            signOutBtn.addEventListener('click', async () => {
                                try { await signOut(); } catch (_) { window.location.href = '/src/auth/presentation/auth-page.html'; }
                            });
                        }
                    }
                }
            } catch (_) {
                // Ignore - login UI still works
            }
        }
    </script>
    <script type="module">
        async function checkForUpdates() {
            try {
                const r = await fetch('/api/version');
                const { hash } = await r.json();
                const cur = document.querySelector('meta[name="app-version"]')?.getAttribute('content');
                if (cur && hash && hash !== cur && confirm('A new version is available. Reload?')) window.location.reload();
            } catch (_) {}
        }
        setInterval(checkForUpdates, 5 * 60 * 1000);
        document.addEventListener('visibilitychange', () => { if (!document.hidden) checkForUpdates(); });
        
        // ✅ FIX: Handle back button navigation to auth page when already authenticated
        // This addresses Scenario 59: Back button after login
        window.addEventListener('popstate', async (event) => {
            // Check if user is authenticated
            try {
                const supabase = getSupabase?.();
                if (supabase) {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session?.user) {
                        // User is authenticated but navigated back to auth page
                        // Redirect them to home instead of showing login
                        console.log('[Auth Page] Authenticated user pressed back button - redirecting to home');
                        window.history.replaceState({}, '', '/home');
                        window.location.replace('/home');
                    }
                }
            } catch (e) {
                // Ignore errors
            }
        });
        
        // Also check on page load if this was a back navigation
        if (window.performance?.navigation?.type === 2 || 
            window.performance?.getEntriesByType?.('navigation')?.[0]?.type === 'back_forward') {
            // This was a back/forward navigation
            (async () => {
                try {
                    const supabase = getSupabase?.();
                    if (supabase) {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session?.user) {
                            console.log('[Auth Page] Back navigation detected with valid session - redirecting to home');
                            window.location.replace('/home');
                        }
                    }
                } catch (e) {}
            })();
        }
    </script>
</body>
</html>
