<!DOCTYPE html>
<html lang="en">
<head>
  <script src="/js/console-stub.js"></script>
  <meta charset="UTF-8">
  <title>My activity | QMS</title>
  <meta name="description" content="Your usage and activity log">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/theme.css">
  <link rel="stylesheet" href="/sidebar.css">
</head>
<body class="home-page">
  <main class="main-content" role="main">
    <div id="header-container"></div>
    <div class="px-4 py-4 max-w-7xl mx-auto w-full">
      <h1 class="page-heading-global">My activity</h1>
      <p class="text-gray-600 mb-6">View your usage and activity log: pages you visited and time spent on each.</p>

      <!-- Summary cards -->
      <div id="summary-cards" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
          <div class="text-sm font-medium text-gray-500 uppercase tracking-wide">Page views</div>
          <div id="summary-views" class="text-2xl font-semibold text-gray-900 mt-1">—</div>
          <div class="text-xs text-gray-500 mt-1">in selected period</div>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
          <div class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total time on pages</div>
          <div id="summary-total-seconds" class="text-2xl font-semibold text-gray-900 mt-1">—</div>
          <div class="text-xs text-gray-500 mt-1">in selected period</div>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
          <div class="text-sm font-medium text-gray-500 uppercase tracking-wide">Date range</div>
          <div id="summary-range" class="text-sm font-medium text-gray-900 mt-1">—</div>
          <div class="text-xs text-gray-500 mt-1">last <span id="summary-days">7</span> days</div>
        </div>
      </div>

      <!-- Date range -->
      <div class="mb-4 flex flex-wrap items-center gap-3">
        <label for="days-select" class="text-sm font-medium text-gray-700">Show activity for:</label>
        <select id="days-select" class="rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
          <option value="7" selected>Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
        <button id="refresh-btn" type="button" class="rounded-md bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
          Refresh
        </button>
      </div>

      <!-- Activity log table -->
      <section class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900">Activity log</h2>
          <p class="text-sm text-gray-600 mt-0.5">Pages you visited, with start and end time and duration.</p>
        </div>
        <div id="activity-loading" class="px-4 py-8 text-center text-gray-500">Loading your activity…</div>
        <div id="activity-error" class="hidden px-4 py-4 text-red-600"></div>
        <div id="activity-empty" class="hidden px-4 py-8 text-center text-gray-500">
          No activity recorded for this period. Your page views will appear here as you use the app.
        </div>
        <div id="activity-table-wrap" class="hidden overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Page</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Path</th>
                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Time on page</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Started</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ended</th>
              </tr>
            </thead>
            <tbody id="activity-tbody" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script type="module" src="/js/auth-checker.js"></script>
  <script type="module" src="/js/load-sidebar.js" defer></script>
  <script type="module">
    import { apiClient } from '/js/utils/api-client.js';

    const limit = 500;
    let currentDays = 7;

    function formatDate(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleString();
    }

    function formatDuration(seconds) {
      if (seconds == null || seconds === '') return '—';
      const s = Number(seconds);
      if (s < 60) return s + ' s';
      const m = Math.floor(s / 60);
      const sec = s % 60;
      if (m < 60) return sec > 0 ? m + ' m ' + sec + ' s' : m + ' m';
      const h = Math.floor(m / 60);
      const min = m % 60;
      return (min > 0 ? h + ' h ' + min + ' m' : h + ' h');
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function loadActivity() {
      const loading = document.getElementById('activity-loading');
      const errEl = document.getElementById('activity-error');
      const wrap = document.getElementById('activity-table-wrap');
      const tbody = document.getElementById('activity-tbody');
      const empty = document.getElementById('activity-empty');
      const summaryCards = document.getElementById('summary-cards');
      const summaryViews = document.getElementById('summary-views');
      const summaryTotalSeconds = document.getElementById('summary-total-seconds');
      const summaryRange = document.getElementById('summary-range');
      const summaryDays = document.getElementById('summary-days');

      errEl.classList.add('hidden');
      wrap.classList.add('hidden');
      empty.classList.add('hidden');
      loading.classList.remove('hidden');

      try {
        const data = await apiClient.analytics.getMe({ days: currentDays, limit });
        loading.classList.add('hidden');
        const list = data.page_views || [];

        if (list.length === 0) {
          empty.classList.remove('hidden');
          summaryCards.classList.add('hidden');
          return;
        }

        summaryCards.classList.remove('hidden');
        const totalSeconds = list.reduce((sum, row) => sum + (Number(row.time_on_page_seconds) || 0), 0);
        summaryViews.textContent = list.length;
        summaryTotalSeconds.textContent = formatDuration(Math.round(totalSeconds));
        summaryDays.textContent = currentDays;
        if (data.from && data.to) {
          summaryRange.textContent = new Date(data.from).toLocaleDateString() + ' – ' + new Date(data.to).toLocaleDateString();
        } else {
          summaryRange.textContent = '—';
        }

        tbody.innerHTML = list.map((row) => `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-medium text-gray-900">${escapeHtml(row.page_slug || '—')}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(row.page_path || '—')}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${formatDuration(row.time_on_page_seconds)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${formatDate(row.view_started_at)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${formatDate(row.view_ended_at)}</td>
          </tr>
        `).join('');
        wrap.classList.remove('hidden');
      } catch (e) {
        loading.classList.add('hidden');
        errEl.textContent = e?.message || 'Failed to load your activity. Please try again.';
        errEl.classList.remove('hidden');
        summaryCards.classList.add('hidden');
      }
    }

    function init() {
      document.getElementById('days-select').addEventListener('change', (e) => {
        currentDays = Math.min(90, Math.max(1, parseInt(e.target.value, 10) || 7));
        loadActivity();
      });
      document.getElementById('refresh-btn').addEventListener('click', () => loadActivity());
      loadActivity();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
