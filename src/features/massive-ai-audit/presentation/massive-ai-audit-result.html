<!DOCTYPE html>
<html lang="en">
<head>
  <script src="/js/console-stub.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Massive AI Audit | CQMS</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/theme.css">
  <link rel="stylesheet" href="/sidebar.css">
  <link rel="stylesheet" href="/home-page.css">
  <style>
    /* ═══════════════════════════════════════════════════════════
       MASSIVE AI AUDIT — Production Styles
       ═══════════════════════════════════════════════════════════ */

    /* ── Reset & Base ────────────────────────────────────────── */
    .maar-page {
      width: 100%;
      padding: 1.5rem 2rem 3rem;
      font-family: var(--font-family, 'Poppins', sans-serif);
      box-sizing: border-box;
    }

    /* ── Sticky Navigation Bar ────────────────────────────────── */
    .maar-nav-bar {
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid #e5e7eb;
      margin: -1.5rem -2rem 1.25rem; padding: 0.75rem 2rem;
      display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;
      background: #fff;
      transition: box-shadow 0.2s ease;
    }
    [data-theme="dark"] .maar-nav-bar {
      background: rgba(17,24,39,0.92);
      border-bottom-color: var(--color-border-light, #374151);
    }
    .maar-nav-bar.scrolled {
      box-shadow: 0 4px 16px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
    }
    .maar-back-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: var(--radius-md, 0.375rem);
      border: 1px solid var(--color-border-light, #e5e7eb);
      background: var(--color-background, #ffffff);
      color: var(--color-text-secondary, #6b7280);
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
      padding: 0;
    }
    .maar-back-btn:hover {
      background: var(--color-background-secondary, #f9fafb);
      color: var(--color-text-primary, #1f2937);
      border-color: var(--maar-green-500, #059669);
    }
    .maar-back-btn.visible { display: flex; }
    .maar-back-btn svg { width: 1rem; height: 1rem; }

    /* ── Breadcrumb ──────────────────────────────────────────── */
    .maar-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8125rem;
      color: var(--color-text-secondary, #6b7280);
      flex-wrap: wrap;
      min-height: 1.25rem;
      flex: 1;
      min-width: 0;
    }
    .maar-bc-btn {
      cursor: pointer;
      color: var(--maar-green-500, #059669);
      font-weight: 600;
      background: none;
      border: none;
      padding: 0.15rem 0;
      font-family: inherit;
      font-size: inherit;
      transition: color 0.15s;
    }
    .maar-bc-btn:hover { color: var(--maar-green-700, #047857); text-decoration: underline; }
    .maar-bc-sep { color: var(--color-text-tertiary, #9ca3af); user-select: none; font-size: 0.75rem; }
    .maar-bc-current { color: var(--color-text-primary, #1f2937); font-weight: 600; }

    /* ── Page Header ─────────────────────────────────────────── */
    .maar-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .maar-header-left { flex: 1; min-width: 0; }
    .maar-header-title-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .maar-header h1 {
      margin: 0; font-size: 1.375rem; font-weight: 700;
      color: #111827; line-height: 1.3; letter-spacing: -0.02em;
    }
    .maar-header-pill {
      display: inline-flex; align-items: center;
      padding: 0.2rem 0.5rem; font-size: 0.6875rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.04em; border-radius: 4px;
    }
    .maar-header-pill.completed { background: #d1fae5; color: #065f46; }
    .maar-header-pill.running { background: #dbeafe; color: #1e40af; }
    .maar-header-pill.queued { background: #f3f4f6; color: #4b5563; }
    .maar-header-pill.scheduled { background: #fef3c7; color: #92400e; }
    .maar-header-pill.failed { background: #fee2e2; color: #991b1b; }
    .maar-header-pill.cancelled { background: #f3f4f6; color: #6b7280; }
    .maar-header-desc {
      margin: 0.375rem 0 0;
      font-size: 0.8125rem;
      color: var(--color-text-secondary, #6b7280);
      line-height: 1.5;
    }
    .maar-header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 1.5rem;
      margin-top: 0.375rem;
      font-size: 0.8125rem;
      color: var(--color-text-secondary, #6b7280);
    }
    .maar-header-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .maar-header-meta-item strong {
      font-weight: 600;
      color: var(--color-text-primary, #374151);
    }

    /* ── Global Error ────────────────────────────────────────── */
    .maar-error-banner {
      padding: 0.75rem 1rem;
      background: var(--color-error-light, #fee2e2);
      border: 1px solid #fecaca;
      border-radius: var(--radius-lg, 0.5rem);
      font-size: 0.875rem;
      color: var(--color-error-dark, #991b1b);
      font-weight: 500;
      margin-bottom: 1.25rem;
      display: none;
    }

    /* ── KPI Grid ────────────────────────────────────────────── */
    .maar-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(13rem, 1fr));
      gap: 0.875rem;
      margin-bottom: 1.5rem;
      width: 100%;
    }
    @media (min-width: 1200px) { .maar-kpi-grid { grid-template-columns: repeat(6, 1fr); } }
    @media (max-width: 1199px) and (min-width: 769px) { .maar-kpi-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .maar-kpi-grid { grid-template-columns: repeat(2, 1fr); } }

    .maar-kpi {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; padding: 1rem 1.15rem;
      position: relative; overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .maar-kpi::before {
      content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
    }
    .maar-kpi:nth-child(1)::before { background: #6366f1; }
    .maar-kpi:nth-child(2)::before { background: #10b981; }
    .maar-kpi:nth-child(3)::before { background: #0ea5e9; }
    .maar-kpi:nth-child(4)::before { background: #f59e0b; }
    .maar-kpi:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .maar-kpi-accent { display: none; }
    .maar-kpi-icon { display: none; }
    .maar-kpi-label {
      font-size: 0.675rem; font-weight: 600; color: #6b7280;
      text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.25rem;
    }
    .maar-kpi-value, .maar-kpi-val {
      font-size: 1.5rem; font-weight: 700; color: #111827;
      line-height: 1.15; margin-bottom: 0.1rem;
      font-variant-numeric: tabular-nums;
    }
    .maar-kpi-sublabel, .maar-kpi-sub {
      font-size: 0.72rem; color: #9ca3af; line-height: 1.35;
    }
    .maar-kpi-delta {
      display: inline-flex; align-items: center; gap: 0.2rem;
      font-size: 0.7rem; font-weight: 600; margin-top: 0.2rem;
      padding: 0.1rem 0.4rem; border-radius: 4px;
    }
    .maar-kpi-delta.up { color: #059669; background: #ecfdf5; }
    .maar-kpi-delta.down { color: #dc2626; background: #fef2f2; }
    .maar-kpi-delta.neutral { color: #6b7280; background: #f3f4f6; }

    /* ── Status Pill ──────────────────────────────────────────── */
    .maar-pill {
      display: inline-flex; align-items: center;
      padding: 0.2rem 0.65rem; border-radius: 9999px;
      font-size: 0.6875rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.04em; white-space: nowrap;
    }
    .maar-pill-queued    { background: #f3f4f6; color: #6b7280; }
    .maar-pill-running   { background: #dbeafe; color: #1e40af; }
    .maar-pill-completed { background: #d1fae5; color: #065f46; }
    .maar-pill-failed    { background: #fee2e2; color: #991b1b; }
    .maar-pill-cancelled { background: #f3f4f6; color: #9ca3af; }
    .maar-pill-scheduled { background: #fef3c7; color: #92400e; }
    .maar-pill-passed    { background: #d1fae5; color: #065f46; }
    .maar-pill-failed-pf { background: #fee2e2; color: #991b1b; }
    .maar-pill-na        { background: #f3f4f6; color: #9ca3af; }

    /* ── Score Badge ──────────────────────────────────────────── */
    .maar-score {
      display: inline-flex; align-items: center; justify-content: center;
      min-width: 2.75rem; padding: 0.25rem 0.6rem;
      font-size: 0.8125rem; font-weight: 800; border-radius: 8px;
    }
    .maar-score-high { background: #dcfce7; color: #166534; }
    .maar-score-mid  { background: #fef9c3; color: #854d0e; }
    .maar-score-low  { background: #fee2e2; color: #b91c1c; }

    /* ── Progress Bar ────────────────────────────────────────── */
    .maar-progress {
      height: 0.375rem; background: #e5e7eb;
      border-radius: 9999px; overflow: hidden;
    }
    .maar-progress-fill {
      height: 100%;
      background: #059669; border-radius: 9999px;
      transition: width 0.5s ease;
    }
    .maar-progress-fill.active {
      background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
      background-size: 200% 100%;
      animation: maar-progress-pulse 2s ease-in-out infinite;
    }
    @keyframes maar-progress-pulse {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* ═══════ VIEW 1: Batch Cards ═══════════════════════════ */
    /* ── Tab bar ─────────────────────────────────────────────── */
    .maar-tab-bar {
      display: flex; gap: 0;
      margin-bottom: 1rem;
      border-bottom: 2px solid #e5e7eb;
    }
    .maar-tab {
      padding: 0.5rem 1rem;
      font-size: 0.8125rem; font-weight: 600;
      color: #6b7280; background: none;
      border: none; border-bottom: 2px solid transparent;
      margin-bottom: -2px; cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      font-family: inherit;
    }
    .maar-tab:hover { color: #111827; }
    .maar-tab.active {
      color: #059669;
      border-bottom-color: #059669;
    }

    /* ── Insights / Analytics ─────────────────────────────────── */
    .maar-insights {
      margin: 0 0 1.5rem; padding: 0;
      display: none;
    }
    .maar-insights.visible { display: block; }
    .maar-insights .maar-chart-row > * { min-width: 0; }
    .maar-insights-title {
      font-size: 1rem; font-weight: 700;
      color: #111827; margin: 0 0 0.75rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .maar-insights-summary {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem; margin-bottom: 1.25rem;
    }
    @media (max-width: 768px) { .maar-insights-summary { grid-template-columns: repeat(2, 1fr); } }

    /* ── Smart Insights Panel ── */
    .maar-smart-insights {
      background: #fffbeb; border: 1px solid #fef3c7; border-radius: 10px;
      padding: 1rem 1.25rem; margin-bottom: 1.25rem; overflow: hidden;
    }
    .maar-smart-insights-title {
      font-size: 0.8125rem; font-weight: 700; color: #92400e;
      margin: 0 0 0.5rem; display: flex; align-items: center; gap: 0.4rem;
      min-width: 0;
    }
    .maar-smart-insights-title .si-icon {
      flex-shrink: 0; width: 1rem; height: 1rem; min-width: 1rem; max-width: 1rem; max-height: 1rem;
    }
    .maar-smart-insights-list {
      list-style: none; padding: 0; margin: 0;
    }
    .maar-smart-insights-list li {
      font-size: 0.8rem; color: #78350f; line-height: 1.5;
      padding: 0.3rem 0; border-bottom: 1px solid #fef3c7;
      display: flex; gap: 0.5rem; align-items: flex-start;
    }
    .maar-smart-insights-list li:last-child { border-bottom: none; }
    .si-icon {
      flex-shrink: 0; width: 1rem; height: 1rem; min-width: 1rem; min-height: 1rem;
    }
    .maar-smart-insights-list .si-icon {
      margin-top: 2px;
    }
    .maar-smart-insights.type-positive { background: #ecfdf5; border-color: #d1fae5; }
    .maar-smart-insights.type-positive .maar-smart-insights-title { color: #065f46; }
    .maar-smart-insights.type-positive .maar-smart-insights-list li { color: #064e3b; border-bottom-color: #d1fae5; }

    /* ── Team Health Bar ── */
    .maar-team-health {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
      padding: 1rem 1.25rem; margin-bottom: 1.25rem; overflow: hidden;
    }
    .maar-team-health h4 {
      font-size: 0.8125rem; font-weight: 700; color: #111827; margin: 0 0 0.75rem;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .maar-team-bar {
      display: flex; height: 28px; border-radius: 6px; overflow: hidden;
      margin-bottom: 0.6rem; background: #f3f4f6;
    }
    .maar-team-bar-seg { display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; color: #fff; min-width: 0;
      transition: width 0.4s ease;
    }
    .maar-team-bar-seg.top { background: #059669; }
    .maar-team-bar-seg.avg { background: #f59e0b; }
    .maar-team-bar-seg.low { background: #ef4444; }
    .maar-team-bar-legend {
      display: flex; gap: 1.25rem; font-size: 0.75rem; color: #6b7280;
    }
    .maar-team-bar-legend span {
      display: inline-flex; align-items: center; gap: 0.35rem;
    }
    .maar-team-bar-legend .dot {
      width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0;
    }

    /* ── Compliance Dashboard ── */
    .maar-compliance {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
      padding: 1rem 1.25rem; margin-bottom: 1.25rem; overflow: hidden;
    }
    .maar-compliance h4 {
      font-size: 0.8125rem; font-weight: 700; color: #111827; margin: 0 0 0.5rem;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .maar-compliance-stats {
      display: flex; gap: 1.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;
    }
    .maar-compliance-stat {
      display: flex; flex-direction: column;
    }
    .maar-compliance-stat-val {
      font-size: 1.25rem; font-weight: 700; color: #111827;
      font-variant-numeric: tabular-nums;
    }
    .maar-compliance-stat-label {
      font-size: 0.675rem; color: #6b7280; font-weight: 500;
      text-transform: uppercase; letter-spacing: 0.03em;
    }
    .maar-compliance-list {
      list-style: none; padding: 0; margin: 0;
    }
    .maar-compliance-list li {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.4rem 0; border-bottom: 1px solid #f3f4f6;
      font-size: 0.8rem;
    }
    .maar-compliance-list li:last-child { border-bottom: none; }
    .maar-compliance-list .c-name { color: #374151; font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .maar-compliance-list .c-count { font-weight: 700; color: #dc2626; font-variant-numeric: tabular-nums; }

    /* ── Focus Areas ── */
    .maar-focus-areas {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
      padding: 1rem 1.25rem; margin-bottom: 1.25rem;
    }
    .maar-focus-areas h4 {
      font-size: 0.8125rem; font-weight: 700; color: #111827; margin: 0 0 0.5rem;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .maar-focus-areas-desc {
      font-size: 0.78rem; color: #6b7280; margin: 0 0 0.75rem; line-height: 1.45;
    }
    .maar-focus-item {
      display: flex; gap: 0.75rem; padding: 0.65rem 0;
      border-bottom: 1px solid #f3f4f6; align-items: flex-start;
    }
    .maar-focus-item:last-child { border-bottom: none; }
    .maar-focus-num {
      width: 24px; height: 24px; border-radius: 6px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; color: #fff; background: #ef4444;
    }
    .maar-focus-num.n2 { background: #f59e0b; }
    .maar-focus-num.n3 { background: #6b7280; }
    .maar-focus-body { flex: 1; min-width: 0; }
    .maar-focus-name { font-size: 0.8125rem; font-weight: 600; color: #111827; }
    .maar-focus-detail { font-size: 0.75rem; color: #6b7280; margin-top: 0.1rem; line-height: 1.4; }
    .maar-focus-bar { height: 4px; border-radius: 2px; background: #f3f4f6; margin-top: 0.35rem; }
    .maar-focus-bar-fill { height: 100%; border-radius: 2px; }
    .maar-trend-card {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.25rem;
    }
    .maar-trend-card h4 {
      margin: 0 0 0.15rem; font-size: 0.875rem; font-weight: 700; color: #111827;
    }
    .maar-trend-chart { width: 100%; height: 240px; min-height: 200px; }
    .maar-trend-legend {
      display: flex; flex-wrap: wrap; gap: 0.5rem 1rem;
      margin-top: 0.75rem; padding-top: 0.5rem;
      border-top: 1px solid #f3f4f6; font-size: 0.75rem; color: #6b7280;
    }
    .maar-trend-legend span { display: inline-flex; align-items: center; gap: 0.35rem; font-weight: 500; }
    .maar-top-params-card {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; padding: 1rem 1.25rem;
    }
    .maar-top-params-card h4 {
      margin: 0 0 0.75rem; font-size: 0.875rem; font-weight: 700; color: #111827;
    }
    .maar-top-params-table {
      width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8125rem;
    }
    .maar-top-params-table th,
    .maar-top-params-table td {
      padding: 0.55rem 0.85rem; text-align: left; border-bottom: 1px solid #f1f5f9;
    }
    .maar-top-params-table th {
      font-weight: 600; color: #64748b; background: #f8fafc; font-size: 0.7rem;
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .maar-top-params-table th:first-child { border-radius: 8px 0 0 0; }
    .maar-top-params-table th:last-child { border-radius: 0 8px 0 0; }
    .maar-top-params-table tr:last-child td { border-bottom: none; }
    .maar-top-params-table .maar-param-sev { font-weight: 700; color: #dc2626; }

    /* ── Tooltip ───────────────────────────────────────────── */
    #maar-tooltip {
      position: fixed; z-index: 9999; pointer-events: none;
      background: #1e293b; color: #f1f5f9;
      font-size: 0.75rem; line-height: 1.5;
      padding: 0.5rem 0.75rem; border-radius: 6px; max-width: 280px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0; transform: translateY(4px);
      transition: opacity 0.15s, transform 0.15s;
    }
    #maar-tooltip.visible { opacity: 1; transform: translateY(0); }
    #maar-tooltip .tip-title { font-weight: 700; font-size: 0.8rem; margin-bottom: 0.15rem; color: #fff; }
    #maar-tooltip .tip-val { font-weight: 700; color: #34d399; font-size: 0.85rem; }
    #maar-tooltip .tip-sub { color: #94a3b8; margin-top: 0.1rem; font-size: 0.7rem; }

    /* ── Info button ─────────────────────────────────────────── */
    .maar-chart-hdr { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.15rem; }
    .maar-chart-hdr h4 { margin: 0; font-size: 0.8125rem; font-weight: 700; color: #111827; }
    .maar-info-btn {
      display: inline-flex; align-items: center; justify-content: center;
      width: 16px; height: 16px; border-radius: 50%;
      background: #f3f4f6; border: none;
      color: #9ca3af; font-size: 9px; font-weight: 700;
      cursor: help; padding: 0; transition: all 0.15s; flex-shrink: 0;
    }
    .maar-info-btn:hover { background: #e5e7eb; color: #6b7280; }

    /* ── Chart layout ────────────────────────────────────────── */
    .maar-chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; min-width: 0; }
    .maar-chart-row > * { min-width: 0; }
    @media (max-width: 768px) { .maar-chart-row { grid-template-columns: 1fr; } }
    .maar-chart-card, .maar-chart-card-full {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; padding: 1.25rem; overflow: hidden;
    }
    .maar-chart-card-full { margin-bottom: 1.25rem; }
    .maar-trend-desc { font-size: 0.78rem; color: #9ca3af; line-height: 1.4; margin: 0.1rem 0 0.6rem; }

    /* ── SVG hover ────────────────────────────────────────────── */
    svg rect[data-tip], svg path[data-tip], svg circle[data-tip] {
      cursor: pointer; transition: opacity 0.15s;
    }
    svg rect[data-tip]:hover { opacity: 0.8; }
    svg path[data-tip]:hover { opacity: 0.8; }
    svg circle[data-tip]:hover { opacity: 0.8; }
    svg .maar-hover-dot { opacity: 0; transition: opacity 0.15s; }
    svg .maar-hover-dot:hover { opacity: 1; }

    /* ── (animations removed for cleaner feel) ── */

    /* ── Health summary card ──────────────────────────────────── */
    .maar-health-card {
      display: flex; align-items: center; gap: 1.5rem;
      border-radius: 10px; padding: 1.25rem 1.5rem;
      margin-bottom: 1.25rem; border: 1px solid #e5e7eb;
      background: #fff;
    }
    .maar-health-card.health-strong { border-left: 4px solid #059669; }
    .maar-health-card.health-moderate { border-left: 4px solid #f59e0b; }
    .maar-health-card.health-developing { border-left: 4px solid #6366f1; }
    .maar-health-left { flex-shrink: 0; text-align: center; min-width: 80px; }
    .maar-health-gauge { width: 72px; height: 72px; }
    .maar-health-center { flex: 1; min-width: 0; }
    .maar-health-title { font-size: 1.125rem; font-weight: 700; color: #111827; margin: 0 0 0.15rem; }
    .maar-health-subtitle { font-size: 0.8rem; color: #6b7280; line-height: 1.5; margin: 0; }
    .maar-health-metrics { display: flex; gap: 1.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
    .maar-health-metric { display: flex; flex-direction: column; }
    .maar-health-metric-val { font-size: 1rem; font-weight: 700; color: #111827; font-variant-numeric: tabular-nums; }
    .maar-health-metric-label { font-size: 0.65rem; color: #6b7280; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em; }

    /* ── Sortable table (refined) ─────────────────────────────── */
    .maar-sortable-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
    .maar-sortable-table th, .maar-sortable-table td {
      padding: 0.55rem 0.75rem; text-align: left;
      border-bottom: 1px solid #f3f4f6;
    }
    .maar-sortable-table th {
      font-weight: 600; color: #6b7280; cursor: pointer;
      user-select: none; white-space: nowrap; font-size: 0.7rem;
      letter-spacing: 0.03em; text-transform: uppercase;
      border-bottom-color: #e5e7eb;
    }
    .maar-sortable-table th:hover { color: #374151; }
    .maar-sortable-table th .maar-sort-arrow {
      display: inline-block; margin-left: 0.2rem; font-size: 0.6rem; color: #d1d5db;
    }
    .maar-sortable-table th .maar-sort-arrow.active { color: #059669; }
    .maar-sortable-table tbody tr { transition: background 0.1s; }
    .maar-sortable-table tbody tr:hover { background: #f9fafb; }
    .maar-sortable-table tr:last-child td { border-bottom: none; }
    .maar-sortable-table .maar-cell-bar-wrap { display: inline-flex; align-items: center; gap: 0.35rem; }
    .maar-sortable-table .maar-cell-minibar { display: inline-block; height: 5px; border-radius: 3px; min-width: 2px; }
    .maar-sortable-table .maar-cell-num { font-variant-numeric: tabular-nums; }
    .maar-sortable-table .maar-cell-lo { color: #ef4444; font-weight: 600; }
    .maar-sortable-table .maar-cell-mid { color: #d97706; font-weight: 600; }
    .maar-sortable-table .maar-cell-hi { color: #059669; font-weight: 600; }
    .maar-sortable-table .maar-cell-flag { color: #ef4444; font-weight: 600; }
    .maar-table-scroll { overflow-x: auto; }

    /* ── Collapsible panels ──────────────────────────────────── */
    .maar-detail-panel {
      border: 1px solid #e5e7eb;
      border-radius: 10px; margin-bottom: 0.75rem;
      background: #fff; overflow: hidden;
    }
    .maar-detail-panel summary {
      display: flex; align-items: center; gap: 0.6rem;
      padding: 0.85rem 1.25rem; cursor: pointer;
      font-size: 0.8125rem; font-weight: 700; color: #111827;
      list-style: none; user-select: none;
      transition: background 0.1s;
    }
    .maar-detail-panel summary::-webkit-details-marker { display: none; }
    .maar-detail-panel summary .maar-chevron {
      width: 16px; height: 16px; flex-shrink: 0;
      color: #9ca3af; transition: transform 0.2s;
    }
    .maar-detail-panel[open] summary .maar-chevron { transform: rotate(90deg); color: #6366f1; }
    .maar-detail-panel summary:hover { background: #f9fafb; }
    .maar-detail-panel summary .maar-panel-badge {
      margin-left: auto; font-size: 0.675rem; font-weight: 600;
      padding: 0.15rem 0.5rem; border-radius: 4px;
      background: #f3f4f6; color: #6b7280;
    }
    .maar-detail-panel summary .maar-panel-desc {
      font-size: 0.75rem; font-weight: 400; color: #9ca3af;
    }
    .maar-detail-panel .maar-panel-body {
      padding: 0.5rem 1.25rem 1.25rem;
      border-top: 1px solid #f3f4f6;
    }

    /* ── Quick insights row ───────────────────────────────────── */
    .maar-quick-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem; }
    @media (max-width: 768px) { .maar-quick-row { grid-template-columns: 1fr; } }
    .maar-quick-box {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; padding: 1rem 1.25rem; overflow: hidden;
    }
    .maar-quick-box h4 { margin: 0 0 0.6rem; font-size: 0.8125rem; font-weight: 700; color: #111827; }
    .maar-top5-list { list-style: none; padding: 0; margin: 0; }
    .maar-top5-list li {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.45rem 0;
      border-bottom: 1px solid #f3f4f6; font-size: 0.8125rem;
    }
    .maar-top5-list li:last-child { border-bottom: none; }
    .maar-top5-rank {
      width: 20px; height: 20px; border-radius: 4px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.65rem; font-weight: 700; flex-shrink: 0;
      background: #f3f4f6; color: #374151;
    }
    .maar-top5-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #374151; font-weight: 500; }
    .maar-top5-val { font-weight: 700; font-variant-numeric: tabular-nums; flex-shrink: 0; color: #dc2626; font-size: 0.8125rem; }

    .maar-bar-chart-wrap { width: 100%; min-height: 200px; }

    .maar-batch-list {
      display: flex;
      flex-direction: column;
      gap: 0.875rem;
    }
    .maar-batch {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; overflow: hidden; cursor: pointer;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .maar-batch:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-color: #d1d5db;
    }
    .maar-batch-accent {
      height: 4px; width: 100%;
    }
    .maar-batch-accent-completed { background: #10b981; }
    .maar-batch-accent-running   { background: #3b82f6; }
    .maar-batch-accent-queued    { background: #9ca3af; }
    .maar-batch-accent-failed    { background: #ef4444; }
    .maar-batch-accent-cancelled { background: #9ca3af; }
    .maar-batch-accent-scheduled { background: #f59e0b; }
    .maar-batch-body {
      padding: 1.25rem 1.5rem;
    }
    .maar-batch-top {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    .maar-batch-top-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    .maar-batch-title {
      margin: 0;
      font-size: 1.0625rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      flex: 1;
      min-width: 0;
    }
    .maar-batch-meta {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      font-size: 0.8125rem;
      color: var(--color-text-secondary, #6b7280);
      margin-bottom: 0.75rem;
    }
    .maar-batch-meta-item { display: flex; align-items: center; gap: 0.35rem; }
    .maar-batch-meta-item svg { width: 0.9375rem; height: 0.9375rem; flex-shrink: 0; opacity: 0.55; }
    .maar-cancel-btn {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0;
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--color-text-tertiary, #9ca3af);
      background: none;
      border: none;
      border-radius: 0;
      cursor: pointer;
      transition: color 0.15s;
    }
    .maar-cancel-btn:hover {
      color: var(--color-text-secondary, #6b7280);
    }
    .maar-complete-btn {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.5rem;
      font-size: 0.6875rem;
      font-weight: 600;
      color: #059669;
      background: #d1fae5;
      border: 1px solid #10b981;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .maar-complete-btn:hover {
      background: #a7f3d0;
      color: #047857;
    }
    .maar-batch-top .maar-cancel-btn { margin-top: 0; }
    .maar-batch-progress-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .maar-batch-progress-bar { flex: 1; }
    .maar-batch-progress-pct {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      min-width: 3rem;
      text-align: right;
    }
    .maar-cancel-bar-compact {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      margin-bottom: 0.75rem;
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 6px;
      font-size: 0.8125rem;
      color: #78350f;
      min-height: 2rem;
    }
    .maar-cancel-bar-compact .maar-cancel-bar-text { flex: 1; min-width: 0; }
    .maar-cancel-bar-compact .maar-cancel-bar-btn {
      flex-shrink: 0;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid #fca5a5;
      border-radius: 4px;
      background: #fff;
      color: #dc2626;
      cursor: pointer;
      white-space: nowrap;
    }
    .maar-cancel-bar-compact .maar-cancel-bar-btn:hover { background: #fef2f2; }
    .maar-cancel-bar-compact .maar-complete-bar-btn {
      flex-shrink: 0;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid #10b981;
      border-radius: 4px;
      background: #d1fae5;
      color: #059669;
      cursor: pointer;
      white-space: nowrap;
    }
    .maar-cancel-bar-compact .maar-complete-bar-btn:hover { background: #a7f3d0; }
    .maar-batch-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
      gap: 0.625rem;
    }
    .maar-batch-kpi {
      background: var(--color-background-secondary, #f9fafb);
      border-radius: var(--radius-lg, 0.5rem);
      padding: 0.625rem 0.875rem;
      text-align: center;
    }
    .maar-batch-kpi-val {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      line-height: 1.25;
    }
    .maar-batch-kpi-lbl {
      font-size: 0.625rem;
      color: var(--color-text-secondary, #6b7280);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
      margin-top: 0.15rem;
    }

    /* ── Page Summary ──────────────────────────────────────── */
    .maar-page-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(13rem, 1fr));
      gap: 0.875rem;
      margin-bottom: 2rem;
    }
    @media (min-width: 960px) { .maar-page-summary { grid-template-columns: repeat(4, 1fr); } }

    /* ── Batch Card 2-Column Layout ────────────────────────── */
    .maar-batch-layout {
      display: flex;
      gap: 1.75rem;
      align-items: stretch;
    }
    .maar-batch-main { flex: 1; min-width: 0; }
    .maar-batch-score-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 7.5rem;
      padding: 0.25rem 0.5rem 0.25rem 0;
      border-left: 1px solid var(--color-border-light, #e5e7eb);
      margin-left: auto;
    }
    .maar-batch-lg-ring {
      width: 5.5rem;
      height: 5.5rem;
      position: relative;
    }
    .maar-batch-lg-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .maar-batch-lg-ring-bg { fill: none; stroke: var(--color-border-light, #e5e7eb); stroke-width: 5; }
    .maar-batch-lg-ring-fg { fill: none; stroke-width: 5; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; }
    .maar-batch-lg-ring-label {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .maar-batch-lg-ring-val {
      font-size: 1.375rem;
      font-weight: 800;
      line-height: 1;
      color: var(--color-text-primary, #1f2937);
    }
    .maar-batch-lg-ring-lbl {
      font-size: 0.5625rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
      color: var(--color-text-secondary, #6b7280);
      margin-top: 0.2rem;
    }
    .maar-batch-score-range {
      font-size: 0.6875rem;
      color: var(--color-text-tertiary, #9ca3af);
      margin-top: 0.5rem;
      text-align: center;
      white-space: nowrap;
    }

    /* ── Batch Metrics Row ──────────────────────────────────── */
    .maar-batch-metrics {
      display: flex;
      gap: 0.5rem;
      margin: 0.875rem 0;
      flex-wrap: wrap;
    }
    .maar-bm {
      background: var(--color-background-secondary, #f9fafb);
      border-radius: var(--radius-lg, 0.5rem);
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      min-width: 7rem;
    }
    .maar-bm-icon {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: var(--radius-md, 0.375rem);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .maar-bm-icon svg { width: 0.875rem; height: 0.875rem; }
    .maar-bm-text { display: flex; flex-direction: column; }
    .maar-bm-val {
      font-size: 1.0625rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      line-height: 1.2;
    }
    .maar-bm-lbl {
      font-size: 0.5625rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
      color: var(--color-text-secondary, #6b7280);
    }

    /* ── Pass/Fail Distribution Bar ────────────────────────── */
    .maar-pf-section { margin-top: 0.875rem; }
    .maar-pf-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.375rem;
    }
    .maar-pf-title {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--color-text-secondary, #6b7280);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .maar-pf-rate {
      font-size: 0.8125rem;
      font-weight: 700;
    }
    .maar-pf-track {
      height: 0.5rem;
      border-radius: var(--radius-full, 9999px);
      overflow: hidden;
      display: flex;
      background: var(--color-border-light, #e5e7eb);
    }
    .maar-pf-seg-passed {
      background: linear-gradient(90deg, #10b981, #34d399);
      transition: width 0.5s ease;
    }
    .maar-pf-seg-failed {
      background: linear-gradient(90deg, #ef4444, #f87171);
      transition: width 0.5s ease;
    }
    .maar-pf-legend {
      display: flex;
      justify-content: space-between;
      margin-top: 0.35rem;
      font-size: 0.6875rem;
      font-weight: 600;
    }
    .maar-pf-legend-passed { color: #10b981; display: flex; align-items: center; gap: 0.25rem; }
    .maar-pf-legend-failed { color: #ef4444; display: flex; align-items: center; gap: 0.25rem; }
    .maar-pf-legend-dot {
      width: 0.375rem;
      height: 0.375rem;
      border-radius: 50%;
      display: inline-block;
    }

    /* ── Error Summary Row in Batch Card ───────────────────── */
    .maar-batch-error-row {
      display: flex;
      gap: 0.375rem;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 0.875rem;
      padding-top: 0.875rem;
      border-top: 1px solid var(--color-border-light, #e5e7eb);
    }
    .maar-batch-err-title {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--color-text-secondary, #6b7280);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-right: 0.375rem;
    }
    .maar-batch-err-title svg { width: 0.875rem; height: 0.875rem; color: var(--color-text-tertiary, #9ca3af); }

    /* ── Batch Status Indicator ─────────────────────────────── */
    .maar-batch-status-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }
    .maar-batch-status-info {
      font-size: 0.75rem;
      color: var(--color-text-tertiary, #9ca3af);
      font-weight: 500;
    }

    @media (max-width: 640px) {
      .maar-batch-layout { flex-direction: column; gap: 1rem; }
      .maar-batch-score-col { flex-direction: row; gap: 1rem; min-width: 0; border-left: none; border-top: 1px solid var(--color-border-light, #e5e7eb); padding: 1rem 0 0; }
      .maar-batch-metrics { flex-direction: column; }
    }

    /* ═══════ VIEW 2: Agent Cards ══════════════════════════ */
    .maar-section-title {
      font-size: 0.9375rem; font-weight: 700;
      color: #1e293b; margin: 0 0 1rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .maar-section-title svg { width: 1.125rem; height: 1.125rem; color: #6366f1; }

    .maar-agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(22rem, 1fr));
      gap: 0.875rem;
    }
    @media (max-width: 640px) { .maar-agents-grid { grid-template-columns: 1fr; } }

    .maar-agent {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; padding: 1.25rem;
      cursor: pointer; transition: box-shadow 0.2s, border-color 0.2s;
      display: flex; flex-direction: column; gap: 0.875rem;
    }
    .maar-agent:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-color: #d1d5db;
    }
    .maar-agent-top {
      display: flex;
      align-items: center;
      gap: 0.875rem;
    }
    .maar-agent-avatar {
      width: 2.75rem;
      height: 2.75rem;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--maar-green-500, #059669), var(--maar-green-400, #34d399));
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 700;
      flex-shrink: 0;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(100, 92, 254, 0.25);
    }
    .maar-agent-info { flex: 1; min-width: 0; }
    .maar-agent-name {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .maar-agent-email {
      font-size: 0.75rem;
      color: var(--color-text-tertiary, #9ca3af);
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .maar-agent-alias {
      font-size: 0.6875rem;
      color: var(--maar-green-600, #047857);
      margin: 0.15rem 0 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .maar-agent-score-ring {
      width: 3rem;
      height: 3rem;
      flex-shrink: 0;
      position: relative;
    }
    .maar-agent-score-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .maar-agent-score-ring-bg { fill: none; stroke: var(--color-border-light, #e5e7eb); stroke-width: 4; }
    .maar-agent-score-ring-fg { fill: none; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; }
    .maar-agent-score-label {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6875rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
    }
    .maar-agent-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
    .maar-agent-stat {
      background: #f9fafb;
      border-radius: 6px;
      padding: 0.5rem 0.375rem;
      text-align: center;
    }
    .maar-agent-stat-val {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      line-height: 1.2;
    }
    .maar-agent-stat-lbl {
      font-size: 0.5625rem;
      color: var(--color-text-secondary, #6b7280);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      font-weight: 600;
      margin-top: 0.1rem;
    }
    .maar-agent-pills {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }
    .maar-error-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.15rem 0.45rem;
      border-radius: var(--radius-full, 9999px);
      font-size: 0.625rem;
      font-weight: 700;
      white-space: nowrap;
    }
    .maar-ep-cfail { background: #7f1d1d; color: #fff; }
    .maar-ep-crit  { background: #991b1b; color: #fff; }
    .maar-ep-sig   { background: #c2410c; color: #fff; }
    .maar-ep-maj   { background: #b45309; color: #fff; }
    .maar-ep-min   { background: #ca8a04; color: #fff; }
    .maar-agent-pf-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    /* ── Error Distribution Bar ────────────────────────────── */
    .maar-error-bar-wrap {
      background: var(--color-background, #ffffff);
      border: 1px solid var(--color-border-light, #e5e7eb);
      border-radius: var(--radius-xl, 0.75rem);
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    .maar-error-bar-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      margin: 0 0 1rem;
    }
    .maar-error-bar-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.625rem;
    }
    .maar-error-bar-label {
      width: 6.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-secondary, #6b7280);
      text-align: right;
      flex-shrink: 0;
    }
    .maar-error-bar-track {
      flex: 1;
      height: 1.375rem;
      background: var(--color-background-tertiary, #f3f4f6);
      border-radius: var(--radius-md, 0.375rem);
      overflow: hidden;
      position: relative;
    }
    .maar-error-bar-fill {
      height: 100%;
      border-radius: var(--radius-md, 0.375rem);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      padding-left: 0.5rem;
      font-size: 0.6875rem;
      font-weight: 700;
      color: #fff;
      min-width: 1.5rem;
    }
    .maar-error-bar-count {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
      min-width: 2rem;
      text-align: left;
      flex-shrink: 0;
    }

    /* ═══════ VIEW 3: Conversations Table ══════════════════ */
    .maar-toolbar {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .maar-search {
      flex: 1;
      min-width: 14rem;
      padding: 0.55rem 0.875rem 0.55rem 2.25rem;
      border: 1px solid var(--color-border-light, #e5e7eb);
      border-radius: var(--radius-lg, 0.5rem);
      font-size: 0.8125rem;
      font-family: inherit;
      background: var(--color-background, #ffffff) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E") 0.75rem center no-repeat;
      color: var(--color-text-primary, #1f2937);
      outline: none;
      transition: border-color 0.15s;
    }
    .maar-search:focus { border-color: var(--maar-green-500, #059669); box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.12); }
    .maar-select {
      padding: 0.5rem 0.75rem;
      border: 1px solid #e5e7eb; border-radius: 6px;
      font-size: 0.8125rem; font-family: inherit;
      background: #fff; color: #1f2937;
      outline: none; transition: border-color 0.15s;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    .maar-select:focus { border-color: #059669; }
    .maar-filters-wrap {
      margin-bottom: 0.75rem; padding: 0.5rem 0.75rem;
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;
    }
    .maar-filters-bar {
      display: flex;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
    }
    .maar-filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .maar-filter-group-dates .maar-input-date { min-width: 8rem; }
    .maar-filter-lbl {
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--color-text-secondary, #6b7280);
      white-space: nowrap;
    }
    .maar-input-date { min-width: 8rem; }
    .maar-filter-actions {
      display: flex;
      align-items: flex-end;
      gap: 0.35rem;
      margin-left: 0.15rem;
    }
    .maar-filter-btn {
      padding: 0.35rem 0.75rem; border-radius: 6px;
      font-size: 0.8125rem; font-weight: 600; border: none;
      cursor: pointer; background: #059669; color: #fff;
      transition: background 0.15s;
    }
    .maar-filter-btn:hover:not(:disabled) { background: #047857; }
    .maar-filter-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .maar-filter-btn { display: inline-flex; align-items: center; justify-content: center; }
    .maar-filter-btn .maar-btn-spinner { display: none; width: 0.875rem; height: 0.875rem; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: maar-spin 0.6s linear infinite; flex-shrink: 0; }
    .maar-filter-btn.is-loading .maar-btn-spinner { display: inline-block; }
    .maar-filter-btn .maar-btn-text { margin-left: 0; }
    .maar-filter-btn.is-loading .maar-btn-text { margin-left: 0.35rem; }
    .maar-filter-btn-secondary { background: #fff; color: #6b7280; border: 1px solid #e5e7eb; }
    .maar-filter-btn-secondary:hover:not(:disabled) { background: #f9fafb; border-color: #d1d5db; }
    .maar-filters-bar .maar-select { padding: 0.4rem 0.6rem; font-size: 0.75rem; min-height: 0; }
    .maar-filters-bar .maar-filter-btn { font-size: 0.75rem; }

    .maar-table-card {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 10px; overflow: hidden;
    }
    .maar-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }
    .maar-table thead {
      background: var(--color-background-secondary, #f9fafb);
    }
    .maar-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-text-secondary, #6b7280);
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      white-space: nowrap;
      border-bottom: 2px solid var(--color-border-light, #e5e7eb);
    }
    .maar-table td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--color-border-light, #e5e7eb);
      color: var(--color-text-primary, #1f2937);
      vertical-align: middle;
    }
    .maar-table tbody tr {
      cursor: pointer;
      transition: background 0.12s ease;
    }
    .maar-table tbody tr:hover { background: var(--color-background-secondary, #f9fafb); }
    .maar-table tbody tr:last-child td { border-bottom: none; }
    .maar-table a {
      color: var(--maar-green-500, #059669);
      text-decoration: none;
      font-weight: 600;
    }
    .maar-table a:hover { text-decoration: underline; }

    .maar-conv-id {
      font-weight: 600;
      color: var(--maar-green-500, #059669);
      font-family: var(--font-family-mono, monospace);
      font-size: 0.8125rem;
    }
    .maar-err-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.5rem;
      padding: 0.15rem 0.4rem;
      border-radius: var(--radius-md, 0.375rem);
      font-size: 0.75rem;
      font-weight: 700;
    }
    .maar-err-zero { background: var(--color-success-light, #d1fae5); color: var(--color-success-dark, #065f46); }
    .maar-err-some { background: var(--color-error-light, #fee2e2); color: var(--color-error-dark, #991b1b); }
    .maar-err-warn { background: var(--color-warning-light, #fef3c7); color: var(--color-warning-dark, #92400e); }

    /* ═══════ Detail Modal ═════════════════════════════════ */
    .maar-overlay {
      position: fixed; inset: 0;
      z-index: var(--z-modal, 1050);
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      padding: 1.5rem 1rem; overflow-y: auto;
      opacity: 0; transition: opacity 0.2s ease;
    }
    .maar-overlay.open { opacity: 1; }
    .maar-overlay.closing { opacity: 0; }
    .maar-modal {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 56rem;
      max-height: min(90vh, 42rem);
      display: flex;
      flex-direction: column;
      transform: translateY(-1rem) scale(0.97);
      transition: transform 0.2s ease;
    }
    .maar-overlay.open .maar-modal { transform: translateY(0) scale(1); }
    .maar-modal-head {
      flex-shrink: 0;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border-light, #e5e7eb);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .maar-modal-head-info { flex: 1; min-width: 0; }
    .maar-modal-title {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--color-text-primary, #1f2937);
    }
    .maar-modal-sub {
      margin: 0.2rem 0 0;
      font-size: 0.8125rem;
      color: var(--color-text-secondary, #6b7280);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .maar-modal-sub a { color: var(--maar-green-500, #059669); text-decoration: none; font-weight: 600; }
    .maar-modal-sub a:hover { text-decoration: underline; }
    .maar-modal-close {
      width: 2.25rem;
      height: 2.25rem;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: 1px solid var(--color-border-light, #e5e7eb);
      border-radius: var(--radius-md, 0.375rem);
      cursor: pointer;
      color: var(--color-text-secondary, #6b7280);
      transition: background 0.15s, color 0.15s;
    }
    .maar-modal-close:hover { background: var(--color-background-secondary, #f9fafb); color: var(--color-text-primary, #1f2937); }
    .maar-modal-close svg { width: 1.125rem; height: 1.125rem; }
    .maar-modal-body {
      padding: 1.25rem 1.5rem;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    .maar-modal-head-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    .maar-modal-expand-btn,
    .maar-modal-back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.8125rem;
      font-weight: 600;
      border-radius: var(--radius-md, 0.375rem);
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
      background: var(--maar-green-500, #059669);
      color: #fff;
      border: 1px solid var(--maar-green-600, #047857);
    }
    .maar-modal-expand-btn:hover,
    .maar-modal-back-btn:hover { background: var(--maar-green-600, #047857); color: #fff; }
    .maar-modal-back-btn {
      background: var(--color-background, #fff);
      color: var(--color-text-primary, #1f2937);
      border-color: var(--color-border-light, #e5e7eb);
    }
    .maar-modal-back-btn:hover { background: var(--color-background-secondary, #f9fafb); border-color: var(--maar-green-500, #059669); color: var(--maar-green-600, #047857); }
    .maar-modal-expand-btn.hidden,
    .maar-modal-back-btn.hidden { display: none; }
    .maar-modal.expanded { max-width: 96vw; max-height: 92vh; width: 96vw; }
    .maar-modal.expanded .maar-modal-body { padding: 0; overflow: hidden; display: flex; flex-direction: column; }
    .maar-modal-body-inner.expanded {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    .maar-expanded-left {
      flex: 0 0 42%;
      min-width: 16rem;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--color-border-light, #e5e7eb);
      background: var(--color-background-secondary, #f9fafb);
      overflow: hidden;
    }
    .maar-expanded-left .maar-expanded-conversation-wrap {
      flex: 1;
      min-height: 0;
      padding: 0.75rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .maar-expanded-left #maar-expanded-conversation-container {
      flex: 1;
      min-height: 20rem;
      border-radius: var(--radius-lg, 0.5rem);
      overflow: hidden;
      background: #fff;
      border: 1px solid var(--color-border-light, #e5e7eb);
    }
    .maar-expanded-splitter {
      width: 0.25rem;
      background: var(--color-border-light, #e5e7eb);
      flex-shrink: 0;
      cursor: col-resize;
    }
    .maar-expanded-right {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      padding: 1.25rem 1.5rem;
      background: var(--color-background, #fff);
    }

    /* ── Modal Score Cards ─────────────────────────────────── */
    .maar-modal-scores {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(8.5rem, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    .maar-modal-sc {
      background: var(--color-background-secondary, #f9fafb);
      border: 1px solid var(--color-border-light, #e5e7eb);
      border-radius: var(--radius-lg, 0.5rem);
      padding: 0.75rem;
      text-align: center;
    }
    .maar-modal-sc-label {
      font-size: 0.6875rem;
      color: var(--color-text-secondary, #6b7280);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      font-weight: 600;
      margin: 0 0 0.3rem;
    }
    .maar-modal-sc-val { font-size: 1.5rem; font-weight: 700; margin: 0; }

    /* ── Modal Error Counts ────────────────────────────────── */
    .maar-modal-errors {
      background: var(--color-success-light, #d1fae5);
      border-radius: var(--radius-lg, 0.5rem);
      padding: 0.875rem;
      margin-bottom: 1.25rem;
      border: 1px solid #a7f3d0;
    }
    .maar-modal-err-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(6.5rem, 1fr));
      gap: 0.75rem;
    }
    .maar-modal-err-label {
      font-size: 0.6875rem;
      color: var(--color-success-dark, #065f46);
      margin: 0 0 0.3rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .maar-modal-err-val {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text-primary, #374151);
      background: var(--color-background, #ffffff);
      border: 1px solid var(--color-border, #d1d5db);
      border-radius: var(--radius-sm, 0.25rem);
      padding: 0.3rem 0.5rem;
      text-align: center;
    }

    /* ── Modal Detail Section ──────────────────────────────── */
    .maar-modal-section {
      background: var(--color-background-secondary, #f9fafb);
      border-radius: var(--radius-lg, 0.5rem);
      padding: 0.875rem;
      border: 1px solid var(--color-border-light, #e5e7eb);
      margin-bottom: 1.25rem;
    }
    .maar-modal-section-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--maar-green-500, #059669);
      margin: 0 0 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .maar-modal-section-title svg { width: 1rem; height: 1rem; }
    .maar-param-wrap {
      background: var(--color-background, #ffffff);
      border-radius: var(--radius-lg, 0.5rem);
      box-shadow: var(--shadow-sm, 0 1px 2px rgba(0,0,0,0.05));
      overflow: hidden;
    }
    .maar-param-head {
      background: var(--color-background, #ffffff);
      padding: 0.65rem 0.875rem;
      border-bottom: 2px solid var(--color-border-light, #e5e7eb);
    }
    .maar-pgrid {
      display: grid;
      grid-template-columns: 1.5fr 0.6fr 0.75fr 0.6fr 3.5fr;
      gap: 0.75rem;
      align-items: center;
    }
    .maar-pgrid.hdr {
      font-weight: 700;
      font-size: 0.6875rem;
      color: var(--color-text-secondary, #6b7280);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .maar-prow { padding: 0.55rem 0.875rem; border-bottom: 1px solid var(--color-background-tertiary, #f3f4f6); }
    .maar-prow:last-child { border-bottom: none; }
    .maar-pname { font-size: 0.8125rem; color: var(--color-text-primary, #1f2937); font-weight: 600; min-width: 0; overflow: hidden; text-overflow: ellipsis; }
    .maar-ppoints { text-align: center; font-size: 0.8125rem; font-weight: 600; }
    .maar-sev-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.15rem 0.5rem;
      border-radius: var(--radius-sm, 0.25rem);
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      white-space: nowrap;
    }
    .maar-pstatus { text-align: center; font-size: 0.8125rem; font-weight: 700; }
    .maar-pfeedback {
      font-size: 0.8125rem;
      color: var(--color-text-secondary, #6b7280);
      line-height: 1.5;
      min-width: 0;
      word-wrap: break-word;
    }
    .maar-pfeedback ul { margin: 0; padding-left: 1.25rem; list-style: disc; }
    .maar-pfeedback li { margin-bottom: 0.2rem; }

    /* ── AI Notes ──────────────────────────────────────────── */
    .maar-ai-notes {
      background: var(--color-warning-light, #fffbeb);
      border: 1px solid #fde68a;
      border-radius: var(--radius-lg, 0.5rem);
      padding: 0.875rem 1rem;
      font-size: 0.8125rem;
      color: var(--color-warning-dark, #92400e);
      line-height: 1.6;
    }

    /* ── Loading / Empty ──────────────────────────────────── */
    .maar-loading, .maar-empty {
      padding: 4rem 2rem;
      text-align: center;
      color: var(--color-text-secondary, #6b7280);
    }
    /* Compact loading strip: fixed height so spinner placement never shifts */
    .maar-loading-strip {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-height: 3rem;
      padding: 0.75rem 1rem;
      color: var(--color-text-secondary, #6b7280);
      font-size: 0.8125rem;
    }
    .maar-loading-spinner {
      width: 2.5rem;
      height: 2.5rem;
      border: 3px solid var(--color-border-light, #e5e7eb);
      border-top-color: var(--maar-green-500, #059669);
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: maar-spin 0.8s linear infinite;
    }
    .maar-loading-strip .maar-loading-spinner {
      width: 1.25rem;
      height: 1.25rem;
      margin: 0;
      border-width: 2px;
    }
    @keyframes maar-spin { to { transform: rotate(360deg); } }
    .maar-empty-icon {
      width: 3.5rem;
      height: 3.5rem;
      margin: 0 auto 1rem;
      color: var(--color-text-tertiary, #d1d5db);
    }
    .maar-empty-title {
      margin: 0 0 0.5rem;
      font-size: 1.0625rem;
      font-weight: 600;
      color: var(--color-text-primary, #1f2937);
    }
    .maar-empty p { margin: 0; font-size: 0.875rem; color: var(--color-text-secondary, #6b7280); }

    /* ── View Transitions ────────────────────────────────── */
    .maar-view { display: none; }
    .maar-view.active { display: block; animation: maarFade 0.25s ease; }
    @keyframes maarFade { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    /* ── Responsive ──────────────────────────────────────── */
    @media (max-width: 768px) {
      .maar-page { padding: 1rem 0.875rem 2rem; }
      .maar-nav-bar { margin: -1rem -0.875rem 1rem; padding: 0.625rem 0.875rem; }
      .maar-batch-body { padding: 1rem; }
      .maar-agent { padding: 1rem; }
      .maar-agent-stats { grid-template-columns: repeat(2, 1fr); }
      .maar-toolbar { flex-direction: column; }
      .maar-search { min-width: 100%; }
      .maar-modal { max-width: 100%; }
      .maar-modal.expanded { width: 100%; max-width: 100%; }
      .maar-modal-body-inner.expanded { flex-direction: column; }
      .maar-expanded-left { flex: 0 0 auto; min-height: 18rem; border-right: none; border-bottom: 1px solid var(--color-border-light, #e5e7eb); }
      .maar-expanded-splitter { width: 100%; height: 0.25rem; cursor: default; }
      .maar-overlay { padding: 1rem 0.5rem; }
      .maar-pgrid { grid-template-columns: 1fr; gap: 0.35rem; }
      .maar-pgrid.hdr { display: none; }
      .maar-prow { padding: 0.75rem; }
      .maar-error-bar-label { width: 4.5rem; font-size: 0.6875rem; }
    }
  </style>
  <script type="importmap">
    {"imports":{"loglevel":"https://cdn.jsdelivr.net/npm/loglevel@1.9.1/+esm","@supabase/supabase-js":"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm","dompurify":"https://cdn.jsdelivr.net/npm/dompurify@3.3.1/+esm"}}
  </script>
</head>
<body class="home-page">
  <script type="module" src="/js/auth-checker.js"></script>
  <script type="module" src="/js/load-sidebar.js" defer></script>

  <main class="main-content" role="main">
    <div class="maar-page">

      <!-- Sticky Navigation Bar -->
      <div class="maar-nav-bar" id="maar-nav-bar">
        <button class="maar-back-btn" id="maar-back" title="Go back" aria-label="Go back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <nav class="maar-breadcrumb" id="maar-bc" aria-label="Breadcrumb"></nav>
      </div>

      <!-- Page Header -->
      <div class="maar-header">
        <div class="maar-header-left">
          <div class="maar-header-title-row">
            <h1 id="maar-title">Massive AI Audit</h1>
            <span id="maar-status-pill" class="maar-header-pill" style="display:none;"></span>
          </div>
          <p class="maar-header-desc" id="maar-desc">AI-powered bulk audit results, organized by batch.</p>
          <div class="maar-header-meta" id="maar-meta" style="display:none;"></div>
        </div>
      </div>

      <!-- Global Error -->
      <div id="maar-error" class="maar-error-banner"></div>

      <!-- Tab bar: Batches | Overview & trends -->
      <div class="maar-tab-bar" id="maar-tab-bar">
        <button type="button" class="maar-tab active" id="tab-batches" data-tab="batches" aria-selected="true">Batches</button>
        <button type="button" class="maar-tab" id="tab-overview" data-tab="overview" aria-selected="false">Overview &amp; trends</button>
      </div>

      <!-- Shared filters (used by both Batches and Overview) -->
      <div class="maar-filters-wrap" id="batches-filters" style="display:none;">
        <div class="maar-filters-bar">
          <div class="maar-filter-group">
            <label class="maar-filter-lbl" for="filter-created-by">Run by</label>
            <select class="maar-select" id="filter-created-by">
              <option value="">All</option>
            </select>
          </div>
          <div class="maar-filter-group">
            <label class="maar-filter-lbl" for="filter-status">Status</label>
            <select class="maar-select" id="filter-status">
              <option value="">All</option>
              <option value="queued">Queued</option>
              <option value="running">Running</option>
              <option value="scheduled">Scheduled</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="maar-filter-group">
            <label class="maar-filter-lbl" for="filter-scorecard">Scorecard</label>
            <select class="maar-select" id="filter-scorecard">
              <option value="">All</option>
            </select>
          </div>
          <div class="maar-filter-group maar-filter-group-dates">
            <label class="maar-filter-lbl" for="filter-from-date">From</label>
            <input type="date" class="maar-select maar-input-date" id="filter-from-date" />
          </div>
          <div class="maar-filter-group">
            <label class="maar-filter-lbl" for="filter-to-date">To</label>
            <input type="date" class="maar-select maar-input-date" id="filter-to-date" />
          </div>
          <div class="maar-filter-actions">
            <button type="button" class="maar-filter-btn" id="filter-apply"><span class="maar-btn-spinner"></span><span class="maar-btn-text">Apply</span></button>
            <button type="button" class="maar-filter-btn maar-filter-btn-secondary" id="filter-clear">Clear</button>
          </div>
        </div>
      </div>

      <!-- ═══════ VIEW: Batches ═══════════════════════════════ -->
      <div class="maar-view active" id="v-batches">
        <div id="batches-empty" class="maar-empty" style="display:none;">
          <div class="maar-empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </div>
          <p class="maar-empty-title">No audit batches yet</p>
          <p>Start a massive AI audit from Audit Distribution to see batches here.</p>
        </div>
        <div id="batches-loading" class="maar-loading-strip">
          <div class="maar-loading-spinner" aria-hidden="true"></div>
          <span>Loading batches&hellip;</span>
        </div>
        <div id="page-summary" class="maar-page-summary" style="display:none;"></div>
        <div id="batches-list" class="maar-batch-list" style="display:none;"></div>
      </div>

      <!-- ═══════ Global tooltip ═══════════════════════════════ -->
      <div id="maar-tooltip"></div>

      <!-- ═══════ VIEW: Overview & trends ═══════════════════════ -->
      <div class="maar-view" id="v-overview">
        <div id="overview-loading" class="maar-loading-strip" style="display:none;">
          <div class="maar-loading-spinner" aria-hidden="true"></div>
          <span>Loading overview&hellip;</span>
        </div>
        <div id="maar-insights" class="maar-insights">

          <!-- ── AT A GLANCE (always visible) ── -->
          <div id="maar-health-card" class="maar-health-card" style="display:none;"></div>
          <div id="maar-insights-summary" class="maar-insights-summary"></div>

          <!-- ── SMART INSIGHTS (auto-generated recommendations) ── -->
          <div id="maar-smart-insights" class="maar-smart-insights" style="display:none;"></div>

          <!-- ── SECONDARY INSIGHTS ROW (team health + compliance + focus) ── -->
          <div class="maar-chart-row" id="maar-secondary-row" style="display:none;">
            <div id="maar-team-health" class="maar-team-health" style="display:none;"></div>
            <div id="maar-compliance" class="maar-compliance" style="display:none;"></div>
          </div>
          <div id="maar-focus-areas" class="maar-focus-areas" style="display:none;"></div>

          <!-- ── QUALITY TREND ── -->
          <div class="maar-chart-card-full">
            <div class="maar-chart-hdr">
              <h4>Quality by conversation period</h4>
              <button class="maar-info-btn" data-tip="<div class='tip-title'>Reading this chart</div>Each data point represents the conversation period of an audit batch.<br>Solid line = pass rate. Dashed line = average score.<br><div class='tip-sub'>Hover the dots for details on each period.</div>" aria-label="Chart info">?</button>
            </div>
            <p class="maar-trend-desc">Based on when conversations took place, not when the audit ran. Hover data points for details.</p>
            <div id="maar-score-trend-chart" class="maar-trend-chart"></div>
            <div id="maar-score-trend-legend" class="maar-trend-legend"></div>
          </div>

          <!-- ── QUICK INSIGHTS ── -->
          <div class="maar-quick-row">
            <div class="maar-quick-box">
              <h4>Error breakdown by severity <button class="maar-info-btn" data-tip="Shows the proportion of errors across severity levels. Hover each slice for details." aria-label="Info">?</button></h4>
              <div id="maar-severity-donut-chart" style="min-height:180px;"></div>
            </div>
            <div class="maar-quick-box">
              <h4>Most common criteria issues <button class="maar-info-btn" data-tip="The 5 criteria with the highest failure rate, based on how often they are triggered relative to how often they are checked." aria-label="Info">?</button></h4>
              <ol class="maar-top5-list" id="maar-top5-criteria"></ol>
            </div>
          </div>

          <!-- ── EXPANDABLE DETAIL SECTIONS ── -->

          <details class="maar-detail-panel" id="panel-employees">
            <summary>
              <svg class="maar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
              Performance by agent
              <span class="maar-panel-desc">Individual breakdown per team member</span>
              <span class="maar-panel-badge" id="panel-emp-badge"></span>
            </summary>
            <div class="maar-panel-body">
              <p class="maar-trend-desc">Click any column header to sort. The mini bars show relative standing within the team.</p>
              <div class="maar-table-scroll" id="maar-employee-table-wrap"></div>
            </div>
          </details>

          <details class="maar-detail-panel" id="panel-scorecards">
            <summary>
              <svg class="maar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
              Scorecard comparison
              <span class="maar-panel-desc">Pass rate by audit criteria set</span>
              <span class="maar-panel-badge" id="panel-sc-badge"></span>
            </summary>
            <div class="maar-panel-body">
              <p class="maar-trend-desc">Each bar shows the pass rate for a scorecard. Hover for more detail.</p>
              <div id="maar-by-scorecard-chart" class="maar-bar-chart-wrap"></div>
            </div>
          </details>

          <details class="maar-detail-panel" id="panel-distributions">
            <summary>
              <svg class="maar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
              Distributions &amp; patterns
              <span class="maar-panel-desc">Score spread, error frequency, and criteria risk</span>
            </summary>
            <div class="maar-panel-body" style="padding-top:0.75rem;">
              <div class="maar-chart-row">
                <div>
                  <div class="maar-chart-hdr"><h4>Score distribution</h4><button class="maar-info-btn" data-tip="Each bar shows how many conversations scored in that range." aria-label="Info">?</button></div>
                  <div id="maar-score-dist-chart" style="min-height:200px;"></div>
                </div>
                <div>
                  <div class="maar-chart-hdr"><h4>Errors per conversation</h4><button class="maar-info-btn" data-tip="Shows how errors are distributed across conversations." aria-label="Info">?</button></div>
                  <div id="maar-error-dist-chart" style="min-height:200px;"></div>
                </div>
              </div>
              <div class="maar-chart-row" style="margin-top:0.5rem;">
                <div>
                  <div class="maar-chart-hdr"><h4>Priority matrix</h4><button class="maar-info-btn" data-tip="Each dot is a criteria. Position shows frequency vs. severity. Upper-right items have the highest combined impact." aria-label="Info">?</button></div>
                  <div id="maar-risk-matrix-chart" style="min-height:200px;"></div>
                </div>
                <div>
                  <div class="maar-chart-hdr"><h4>Daily error breakdown</h4><button class="maar-info-btn" data-tip="Each bar is one day. Colored segments represent different criteria." aria-label="Info">?</button></div>
                  <div id="maar-trend-chart" class="maar-trend-chart" style="min-height:200px;"></div>
                  <div id="maar-trend-legend" class="maar-trend-legend"></div>
                </div>
              </div>
            </div>
          </details>

          <details class="maar-detail-panel" id="panel-criteria">
            <summary>
              <svg class="maar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
              Criteria details
              <span class="maar-panel-desc">Failure rates, severity, and penalty breakdown</span>
              <span class="maar-panel-badge" id="panel-crit-badge"></span>
            </summary>
            <div class="maar-panel-body">
              <p class="maar-trend-desc">Click headers to sort. Failure rate shows how often a criteria is triggered relative to how often it is evaluated.</p>
              <div class="maar-table-scroll" id="maar-criteria-table-wrap"></div>
            </div>
          </details>

        </div>
        <div id="overview-empty" class="maar-empty" style="display:none;">
          <p class="maar-empty-title">No data for this filter</p>
          <p>Apply a date range and filters, then click Apply to see the overview.</p>
        </div>
      </div>

      <!-- ═══════ VIEW 2: Batch Detail ══════════════════════ -->
      <div class="maar-view" id="v-batch">
        <div id="batch-cancel-bar" style="display:none;"></div>
        <div id="batch-kpis" class="maar-kpi-grid"></div>
        <div id="batch-error-bar"></div>
        <div id="batch-agents-title" class="maar-section-title" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Agents
        </div>
        <div id="batch-agents" class="maar-agents-grid"></div>
        <div id="batch-loading" class="maar-loading" style="display:none;">
          <div class="maar-loading-spinner"></div>
          Loading batch data&hellip;
        </div>
      </div>

      <!-- ═══════ VIEW 3: Agent Conversations ═══════════════ -->
      <div class="maar-view" id="v-convos">
        <div id="convos-kpis" class="maar-kpi-grid"></div>
        <div class="maar-toolbar" id="convos-toolbar">
          <input type="text" class="maar-search" id="conv-search" placeholder="Search by conversation ID or notes...">
          <select class="maar-select" id="conv-pf">
            <option value="">All Results</option>
            <option value="passed">Passed Only</option>
            <option value="failed">Failed Only</option>
          </select>
          <select class="maar-select" id="conv-sort">
            <option value="errors-desc">Most Errors First</option>
            <option value="errors-asc">Least Errors First</option>
            <option value="score-asc">Lowest Score</option>
            <option value="score-desc">Highest Score</option>
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
          </select>
        </div>
        <div class="maar-table-card" id="conv-table-card">
          <table class="maar-table" id="conv-table">
            <thead>
              <tr>
                <th>Conversation</th>
                <th>Score</th>
                <th>Result</th>
                <th>Errors</th>
                <th>Critical</th>
                <th>Significant</th>
                <th>Major</th>
                <th>Minor</th>
                <th>Confidence</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="conv-tbody"></tbody>
          </table>
        </div>
        <div id="conv-empty" class="maar-empty" style="display:none;">
          <p class="maar-empty-title">No conversations match</p>
          <p>Adjust your filters or search terms.</p>
        </div>
      </div>

    </div>

    <!-- ═══════ Detail Modal ═══════════════════════════════ -->
    <div id="maar-overlay" class="maar-overlay" style="display:none;">
      <div class="maar-modal" id="maar-modal">
        <div class="maar-modal-head">
          <div class="maar-modal-head-info">
            <h2 class="maar-modal-title" id="modal-title">Audit Detail</h2>
            <div class="maar-modal-sub" id="modal-sub"></div>
          </div>
          <div class="maar-modal-head-actions">
            <button type="button" class="maar-modal-expand-btn hidden" id="modal-expand-btn" title="View with conversation">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              View with conversation
            </button>
            <button type="button" class="maar-modal-back-btn hidden" id="modal-back-btn" title="Back to summary">← Back to summary</button>
            <button class="maar-modal-close" id="modal-close" title="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
        </div>
        <div class="maar-modal-body" id="modal-body"></div>
      </div>
    </div>
  </main>

  <script type="module">
    (async function () {
      /* ═══════════════════════════════════════════════════════
       *  Utilities
       * ═══════════════════════════════════════════════════════ */
      const $ = id => document.getElementById(id);
      function esc(s) { if (s == null) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

      function pillClass(s) { return ({ queued:'maar-pill-queued', running:'maar-pill-running', completed:'maar-pill-completed', failed:'maar-pill-failed', cancelled:'maar-pill-cancelled', scheduled:'maar-pill-scheduled' })[s] || 'maar-pill-queued'; }
      function pfClass(pf) { if (pf === 'passed') return 'maar-pill-passed'; if (pf === 'failed') return 'maar-pill-failed-pf'; return 'maar-pill-na'; }
      function scoreClass(v) { const n = Number(v); if (n >= 80) return 'maar-score-high'; if (n >= 50) return 'maar-score-mid'; return 'maar-score-low'; }
      function scoreColor(v) { const n = Number(v); if (n >= 80) return '#166534'; if (n >= 50) return '#854d0e'; return '#b91c1c'; }
      function statusLabel(s) { return (s || 'queued').charAt(0).toUpperCase() + (s || 'queued').slice(1); }
      function fmtDate(d) { if (!d) return '\u2014'; try { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); } catch { return d; } }
      function fmtDateTime(d) { if (!d) return '\u2014'; try { return new Date(d).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }); } catch { return d; } }
      function truncId(id) { if (!id) return '\u2014'; if (id.length > 14) return id.slice(0, 6) + '\u2026' + id.slice(-6); return id; }
      function initials(name) { if (!name) return '?'; const p = name.trim().split(/\s+/); return p.length >= 2 ? (p[0][0] + p[1][0]).toUpperCase() : name.slice(0, 2).toUpperCase(); }
      function calcPct(j) { const ta = j.total_agents || 0, ca = j.completed_agents || 0; return ta > 0 ? Math.round((ca / ta) * 100) : 0; }

      function errorsFrom(params) {
        let t = 0, cf = 0, c = 0, s = 0, mj = 0, mn = 0;
        if (!Array.isArray(params)) return { total: t, criticalFail: cf, critical: c, significant: s, major: mj, minor: mn };
        params.forEach(p => {
          const m = Number(p.measurement) || 0;
          if (m > 0) {
            t += m;
            const cat = (p.error_category || '').toLowerCase();
            if (p.is_fail_all) cf += m;
            else if (cat.includes('critical')) c += m;
            else if (cat.includes('significant')) s += m;
            else if (cat.includes('major')) mj += m;
            else if (cat.includes('minor')) mn += m;
            else s += m;
          }
        });
        return { total: t, criticalFail: cf, critical: c, significant: s, major: mj, minor: mn };
      }

      /* ═══════════════════════════════════════════════════════
       *  Auth & API
       * ═══════════════════════════════════════════════════════ */
      const getToken = async (n) => {
        for (let i = 0; i < (n || 3); i++) {
          try {
            const { initSupabase, getSupabase } = await import('/js/utils/supabase-init.js');
            let sb = getSupabase(); if (!sb) { await initSupabase(); sb = getSupabase(); }
            if (!sb) { await new Promise(r => setTimeout(r, 1000 * (i + 1))); continue; }
            const { data: { session } } = await sb.auth.getSession();
            if (session?.access_token) return session.access_token;
            if (i < (n || 3) - 1) await new Promise(r => setTimeout(r, 1000 * (i + 1)));
          } catch (e) { console.warn('[MassiveAI] token attempt ' + (i + 1), e); if (i < (n || 3) - 1) await new Promise(r => setTimeout(r, 1500 * (i + 1))); }
        }
        return null;
      };
      const api = async (path) => {
        const tok = await getToken(3); if (!tok) throw new Error('Session expired. Please refresh.');
        const r = await fetch(path, { headers: { Authorization: 'Bearer ' + tok } });
        if (r.status === 401) throw new Error('Session expired. Please refresh.');
        if (r.status === 429) {
          const text = await r.text();
          let msg = 'Too many requests. Wait a moment and refresh.';
          try { const b = JSON.parse(text); msg = b.error || b.message || msg; } catch (_) { if (text) msg = text; }
          throw new Error(msg);
        }
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      };

      /** POST helper with CSRF token support */
      const apiPost = async (path, body) => {
        const tok = await getToken(3); if (!tok) throw new Error('Session expired. Please refresh.');
        const headers = { 'Content-Type': 'application/json', Authorization: 'Bearer ' + tok };
        // Fetch CSRF token from GET /api/csrf (token comes back in X-CSRF-Token response header)
        try {
          const csrfRes = await fetch('/api/csrf', { method: 'GET', headers: { Authorization: 'Bearer ' + tok } });
          const csrfToken = csrfRes.headers.get('X-CSRF-Token') || csrfRes.headers.get('x-csrf-token');
          if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
        } catch (e) { /* best-effort */ }
        const r = await fetch(path, { method: 'POST', headers, body: body ? JSON.stringify(body) : undefined });
        if (r.status === 429) {
          const text = await r.text();
          let msg = 'Too many requests. Wait a moment and try again, or schedule the audit for later.';
          try { const b = JSON.parse(text); msg = b.error || b.message || msg; } catch (_) { if (text) msg = text; }
          throw new Error(msg);
        }
        if (!r.ok) { const t = await r.text(); throw new Error(t || 'Request failed'); }
        return r.json();
      };

      /** Cancel a job (running/queued/scheduled) */
      async function cancelJob(jobId) {
        if (!confirm('Are you sure you want to cancel this audit batch? Already-processed conversations will be kept, but no new agents will be triggered.')) return false;
        try {
          await apiPost('/api/massive-ai-audit/jobs/' + encodeURIComponent(jobId) + '/cancel');
          return true;
        } catch (e) {
          alert('Failed to cancel: ' + (e.message || 'Unknown error'));
          return false;
        }
      }

      /** Mark a job as completed (running/queued) */
      async function completeJob(jobId) {
        if (!confirm('Mark this audit batch as complete? Progress will be frozen and the batch will show as completed.')) return false;
        try {
          await apiPost('/api/massive-ai-audit/jobs/' + encodeURIComponent(jobId) + '/complete');
          return true;
        } catch (e) {
          alert('Failed to mark complete: ' + (e.message || 'Unknown error'));
          return false;
        }
      }

      /* ═══════════════════════════════════════════════════════
       *  State
       * ═══════════════════════════════════════════════════════ */
      let allJobs = [], curJobId = null, curResults = [], curAgentKey = null, curAgentConvos = [], curAgentName = null;
      const cache = {};
      let navDepth = 0; // 0=batches, 1=batch detail, 2=agent convos
      let lastAnalytics = null; // cached for Overview tab
      /** Intercom admin email -> name (alias) from Intercom API */
      let intercomAdminByEmail = null;
      async function ensureIntercomAdmins() {
        if (intercomAdminByEmail !== null) return;
        intercomAdminByEmail = {};
        try {
          const tok = await getToken(1);
          const { getSupabase } = await import('/js/utils/supabase-init.js');
          const sb = getSupabase();
          const supabaseUrl = (sb && sb.supabaseUrl) ? sb.supabaseUrl : (window.SupabaseConfig && window.SupabaseConfig.url) ? window.SupabaseConfig.url : (window.env && window.env.SUPABASE_URL) ? window.env.SUPABASE_URL : '';
          if (!supabaseUrl || !tok) return;
          const url = `${supabaseUrl}/functions/v1/intercom-proxy?endpoint=admins`;
          const r = await fetch(url, { headers: { Authorization: 'Bearer ' + tok } });
          if (!r.ok) return;
          const data = await r.json();
          const admins = Array.isArray(data) ? data : (data.admins || data.data || []);
          admins.forEach(a => {
            const email = (a.email || '').trim().toLowerCase();
            const name = (a.name || '').trim();
            if (email && name) intercomAdminByEmail[email] = name;
          });
        } catch (e) { console.warn('[maar] Intercom admins fetch failed:', e); }
      }
      function getIntercomAlias(email) {
        if (!email || !intercomAdminByEmail) return null;
        return intercomAdminByEmail[(email + '').trim().toLowerCase()] || null;
      }
      let handlingPopstate = false;
      let resultCountsByJob = {}; // { jobId: { count, passed, failed, avgScore } } — from /results endpoint

      /* ═══════════════════════════════════════════════════════
       *  Scroll & Sticky Nav Bar
       * ═══════════════════════════════════════════════════════ */
      function scrollTop() {
        // Scroll both the window and .main-content (whichever is the scroll container)
        window.scrollTo({ top: 0, behavior: 'instant' });
        const mc = document.querySelector('.main-content');
        if (mc) mc.scrollTo({ top: 0, behavior: 'instant' });
      }

      // Add shadow to sticky nav when scrolled
      const navBar = $('maar-nav-bar');
      function checkNavScroll() {
        const mc = document.querySelector('.main-content');
        const scrollY = mc ? mc.scrollTop : window.scrollY;
        if (scrollY > 8) navBar.classList.add('scrolled');
        else navBar.classList.remove('scrolled');
      }
      window.addEventListener('scroll', checkNavScroll, { passive: true });
      const mc = document.querySelector('.main-content');
      if (mc) mc.addEventListener('scroll', checkNavScroll, { passive: true });

      /* ═══════════════════════════════════════════════════════
       *  Navigation
       * ═══════════════════════════════════════════════════════ */
      function showView(id) {
        document.querySelectorAll('.maar-view').forEach(v => v.classList.remove('active'));
        const t = $(id);
        if (t) t.classList.add('active');
      }

      function updateBackBtn() {
        const btn = $('maar-back');
        if (navDepth > 0) btn.classList.add('visible');
        else btn.classList.remove('visible');
      }

      function setBreadcrumb(parts) {
        const el = $('maar-bc');
        let h = '';
        parts.forEach((p, i) => {
          if (i > 0) h += '<span class="maar-bc-sep">/</span>';
          if (p.fn) h += '<button class="maar-bc-btn" data-bci="' + i + '">' + esc(p.label) + '</button>';
          else h += '<span class="maar-bc-current">' + esc(p.label) + '</span>';
        });
        el.innerHTML = h;
        el.querySelectorAll('.maar-bc-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = +btn.getAttribute('data-bci');
            if (parts[idx]?.fn) parts[idx].fn();
          });
        });
      }

      function pushState(state) {
        if (!handlingPopstate) {
          history.pushState(state, '', window.location.pathname + (state.jobId ? '?id=' + state.jobId : ''));
        }
      }

      function setBatchHeaderStatus(status) {
        const pill = $('maar-status-pill');
        const meta = $('maar-meta');
        if (!pill) return;
        if (!status) {
          pill.style.display = 'none';
          if (meta) meta.style.display = 'none';
          return;
        }
        pill.textContent = (status || '').charAt(0).toUpperCase() + (status || '').slice(1);
        pill.className = 'maar-header-pill ' + (status || '');
        pill.style.display = 'inline-flex';
      }

      function goToBatches(skipHistory) {
        curJobId = null; curAgentKey = null; curAgentName = null;
        navDepth = 0;
        showView('v-batches');
        setBreadcrumb([{ label: 'All Batches' }]);
        $('maar-title').textContent = 'Massive AI Audit';
        $('maar-desc').textContent = 'AI-powered bulk audit results, organized by batch.';
        $('maar-desc').style.display = '';
        setBatchHeaderStatus(null);
        if ($('maar-meta')) $('maar-meta').style.display = 'none';
        updateBackBtn();
        scrollTop();
        if (!skipHistory) pushState({ view: 'batches' });
      }

      async function goToBatch(jobId, skipHistory) {
        curJobId = jobId; curAgentKey = null; curAgentName = null;
        navDepth = 1;
        showView('v-batch');
        const job = allJobs.find(j => j.id === jobId);
        const lbl = 'Batch ' + (job ? job.id.slice(0, 8) : jobId.slice(0, 8)) + '\u2026';
        setBreadcrumb([{ label: 'All Batches', fn: () => goToBatches() }, { label: lbl }]);
        $('maar-title').textContent = lbl;
        $('maar-desc').textContent = '';
        $('maar-desc').style.display = 'none';
        setBatchHeaderStatus(job ? (job.status || 'queued') : null);
        const meta = $('maar-meta');
        if (meta && job) {
          meta.innerHTML = '<span class="maar-header-meta-item"><strong>Run by</strong> ' + esc(job.created_by || '\u2014') + '</span>'
            + '<span class="maar-header-meta-item"><strong>Audit period</strong> ' + esc(fmtDate(job.start_date)) + ' \u2013 ' + esc(fmtDate(job.end_date)) + '</span>';
          meta.style.display = 'flex';
        } else if (meta) meta.style.display = 'none';
        updateBackBtn();
        scrollTop();
        if (!skipHistory) pushState({ view: 'batch', jobId });
        await loadBatch(jobId);
      }

      async function goToAgent(key, name, skipHistory) {
        curAgentKey = key;
        curAgentName = name || 'Agent';
        navDepth = 2;
        showView('v-convos');
        const job = allJobs.find(j => j.id === curJobId);
        const bLbl = 'Batch ' + (job ? job.id.slice(0, 8) : '') + '\u2026';
        setBreadcrumb([
          { label: 'All Batches', fn: () => goToBatches() },
          { label: bLbl, fn: () => goToBatch(curJobId) },
          { label: name || 'Agent' }
        ]);
        $('maar-title').textContent = name || 'Agent';
        await ensureIntercomAdmins();
        const alias = getIntercomAlias(key);
        let desc = 'Conversations audited for ' + (name || 'this agent') + '.';
        if (alias && alias !== name) desc += ' Intercom: ' + alias;
        $('maar-desc').textContent = desc;
        $('maar-desc').style.display = '';
        setBatchHeaderStatus(null);
        if ($('maar-meta')) $('maar-meta').style.display = 'none';
        updateBackBtn();
        scrollTop();
        if (!skipHistory) pushState({ view: 'agent', jobId: curJobId, agentKey: key, agentName: name });
        renderConvos(key);
      }

      // Back button handler
      function goBack() {
        if (navDepth === 2) {
          goToBatch(curJobId);
        } else if (navDepth === 1) {
          goToBatches();
        }
      }
      $('maar-back').addEventListener('click', goBack);

      // Browser back/forward button support
      window.addEventListener('popstate', async (e) => {
        handlingPopstate = true;
        try {
          const state = e.state;
          if (!state || state.view === 'batches') {
            goToBatches(true);
          } else if (state.view === 'batch' && state.jobId) {
            await goToBatch(state.jobId, true);
          } else if (state.view === 'agent' && state.jobId && state.agentKey) {
            if (curJobId !== state.jobId) {
              curJobId = state.jobId;
              let res = cache[state.jobId];
              if (!res) { res = await api('/api/massive-ai-audit/jobs/' + encodeURIComponent(state.jobId) + '/assignments'); cache[state.jobId] = res; }
              curResults = res || [];
            }
            goToAgent(state.agentKey, state.agentName, true);
          } else {
            goToBatches(true);
          }
        } finally {
          handlingPopstate = false;
        }
      });

      /* ═══════════════════════════════════════════════════════
       *  SVG Icons
       * ═══════════════════════════════════════════════════════ */
      const icons = {
        users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        chat: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        target: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
        check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        alert: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        zap: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
        bar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
        shield: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
        calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',
        clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        done: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        trendDown: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>',
        trendUp: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
      };

      /* ═══════════════════════════════════════════════════════
       *  KPI Card Builder
       * ═══════════════════════════════════════════════════════ */
      function kpi(label, value, sub, accent, icon, valColor) {
        return '<div class="maar-kpi">'
          + '<div class="maar-kpi-accent" style="background:' + (accent || 'var(--maar-green-500, #059669)') + ';"></div>'
          + '<div class="maar-kpi-icon" style="background:' + (accent || 'var(--maar-green-500, #059669)') + '15; color:' + (accent || 'var(--maar-green-500, #059669)') + ';">' + (icon || '') + '</div>'
          + '<div class="maar-kpi-label">' + esc(label) + '</div>'
          + '<div class="maar-kpi-val"' + (valColor ? ' style="color:' + valColor + ';"' : '') + '>' + esc(String(value)) + '</div>'
          + (sub ? '<div class="maar-kpi-sub">' + esc(sub) + '</div>' : '')
          + '</div>';
      }

      /* ═══════════════════════════════════════════════════════
       *  VIEW 1: Batches List
       * ═══════════════════════════════════════════════════════ */
      function deriveStatus(job, realConvoCount) {
        const st = job.status || 'queued';
        if (st === 'completed' || st === 'failed' || st === 'cancelled' || st === 'scheduled') return st;
        if ((st === 'running' || st === 'queued') && realConvoCount && realConvoCount > 0) {
          const ta = job.total_agents || 0;
          const ca = job.completed_agents || 0;
          const tc = job.total_conversations;
          // Definitive: total_conversations is known and results >= total
          if (tc && realConvoCount >= tc) return 'completed';
          // Definitive: all agents marked complete by n8n callback
          if (ta > 0 && ca >= ta) return 'completed';
          // Heuristic: no total set and no new results in the last 60 minutes — likely stuck/done
          // Check the most recent result's created_at from cache
          const cached = cache[job.id];
          if (!tc && cached && cached.length > 0) {
            const newest = cached.reduce((latest, r) => {
              const t = new Date(r.created_at || 0).getTime();
              return t > latest ? t : latest;
            }, 0);
            const staleMins = (Date.now() - newest) / 60000;
            // Only mark as completed if no new results for 60+ minutes AND job is 3+ hours old
            const ageMs = Date.now() - new Date(job.created_at || 0).getTime();
            if (staleMins > 60 && ageMs > 3 * 60 * 60 * 1000) return 'completed';
          }
        }
        return st;
      }

      /* ── Page-level summary across all batches ─────────── */
      function renderPageSummary(jobs) {
        let totalConvos = 0, totalPassed = 0, totalFailed = 0, allScores = [], totalErrors = 0;
        jobs.forEach(job => {
          const rc = resultCountsByJob[job.id];
          if (rc) {
            totalConvos += rc.count;
            totalPassed += rc.passed;
            totalFailed += rc.failed;
            if (rc.avgScore != null) allScores.push(rc.avgScore);
          }
          (cache[job.id] || []).forEach(r => { totalErrors += errorsFrom(r.parameters_result).total; });
        });
        const overallAvg = allScores.length ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length) : null;
        const overallPassRate = totalConvos > 0 ? Math.round((totalPassed / totalConvos) * 100) : 0;

        const el = $('page-summary');
        if (totalConvos === 0) { el.style.display = 'none'; return; }
        el.style.display = 'grid';
        el.innerHTML =
          kpi('Total Batches', jobs.length, jobs.filter(j => deriveStatus(j, (resultCountsByJob[j.id]||{}).count) === 'completed').length + ' completed', '#059669', icons.bar)
          + kpi('All Conversations', totalConvos.toLocaleString(), totalPassed + ' passed \u00b7 ' + totalFailed + ' failed', '#3b82f6', icons.chat)
          + kpi('Overall Pass Rate', overallPassRate + '%', '', overallPassRate >= 80 ? '#10b981' : overallPassRate >= 50 ? '#f59e0b' : '#ef4444', icons.check, overallPassRate >= 80 ? '#166534' : overallPassRate >= 50 ? '#854d0e' : '#b91c1c')
          + kpi('Overall Avg Score', overallAvg != null ? overallAvg + '%' : '\u2014', totalErrors > 0 ? totalErrors.toLocaleString() + ' total errors' : '', '#10b981', icons.target, overallAvg != null ? scoreColor(overallAvg) : undefined);
      }

      function renderBatches(jobs) {
        allJobs = jobs;
        $('batches-loading').style.display = 'none';
        if (!jobs.length) { $('batches-empty').style.display = 'block'; $('batches-list').style.display = 'none'; $('page-summary').style.display = 'none'; return; }
        $('batches-empty').style.display = 'none';
        $('batches-list').style.display = 'flex';

        renderPageSummary(jobs);

        let h = '';
        jobs.forEach(job => {
          const ta = job.total_agents || 0, ca = job.completed_agents || 0;
          const tc = job.total_conversations;
          const cc = job.completed_conversations || 0;

          const rc = resultCountsByJob[job.id];
          const realConvoCount = rc ? rc.count : null;
          const realPassed = rc ? rc.passed : 0;
          const realFailed = rc ? rc.failed : 0;
          const realAvg = rc ? rc.avgScore : null;

          const st = deriveStatus(job, realConvoCount);
          const bestConvoCount = realConvoCount || tc || (cc > 0 ? cc : null);

          // Compute real agent count from cache when available
          const cachedResults = cache[job.id] || [];
          const realAgentCount = cachedResults.length > 0 ? (new Set(cachedResults.map(r => r.employee_email || r.employee_name))).size : ta;

          // Compute error totals from cached results
          let bErr = { total: 0, criticalFail: 0, critical: 0, significant: 0, major: 0, minor: 0 };
          cachedResults.forEach(r => { const e = errorsFrom(r.parameters_result); for (const k in bErr) bErr[k] += e[k]; });

          // Compute min/max score
          const scores = cachedResults.filter(r => r.final_score != null).map(r => Number(r.final_score));
          const minScore = scores.length ? Math.min(...scores) : null;
          const maxScore = scores.length ? Math.max(...scores) : null;

          // Pass rate
          const passRate = bestConvoCount && bestConvoCount > 0 ? ((realPassed / bestConvoCount) * 100) : 0;
          const passRateRounded = Math.round(passRate * 10) / 10;

          // Progress — multiple strategies to show meaningful progress
          let pct, pctLabel, pctIndeterminate = false;
          if (st === 'completed') {
            pct = 100;
            pctLabel = '100%';
          } else if (tc != null && tc > 0 && realConvoCount) {
            // Best case: we know the total and have real results
            pct = Math.min(Math.round((realConvoCount / tc) * 100), 99);
            pctLabel = pct + '%';
          } else if (tc != null && tc > 0 && cc > 0) {
            // total_conversations set and completed_conversations updating
            pct = Math.min(Math.round((cc / tc) * 100), 99);
            pctLabel = pct + '%';
          } else if (ta > 0 && ca > 0) {
            // Agent-based progress
            pct = Math.round((ca / ta) * 100);
            pctLabel = pct + '%';
          } else if (realConvoCount && realConvoCount > 0) {
            // We have results flowing in but no known total — show active progress
            pctIndeterminate = true;
            pct = 60; // visual width for the animated bar
            pctLabel = realConvoCount + ' processed';
          } else {
            pct = 0;
            // If job has been running for a while, show "Running…" so user knows it's not stuck (progress updates when each agent completes)
            const created = job.created_at ? new Date(job.created_at).getTime() : 0;
            const runningAwhile = created && (Date.now() - created > 90 * 1000);
            pctLabel = (st === 'running' && runningAwhile) ? 'Running\u2026' : 'Starting\u2026';
          }

          // Score ring data
          const ringRadius = 22, ringCirc = 2 * Math.PI * ringRadius;
          const ringPct = realAvg != null ? realAvg / 100 : 0;
          const ringDashOffset = ringCirc * (1 - ringPct);
          const ringColor = realAvg != null ? (realAvg >= 80 ? '#10b981' : realAvg >= 50 ? '#f59e0b' : '#ef4444') : '#d1d5db';

          h += '<div class="maar-batch" data-jid="' + esc(job.id) + '">';
          h += '<div class="maar-batch-accent maar-batch-accent-' + st + '"></div>';
          h += '<div class="maar-batch-body">';

          // ── 2-Column Layout ────────────────────────────
          h += '<div class="maar-batch-layout">';

          // LEFT: Info + Metrics + Pass/Fail Bar
          h += '<div class="maar-batch-main">';

          // Top: title + status + cancel (when active)
          h += '<div class="maar-batch-top">';
          h += '  <h3 class="maar-batch-title">Batch ' + esc(job.id.slice(0, 8)) + '\u2026</h3>';
          h += '  <div class="maar-batch-top-actions">';
          h += '    <span class="maar-pill ' + pillClass(st) + '">' + statusLabel(st) + '</span>';
          if (st === 'running' || st === 'queued' || st === 'scheduled') {
            h += '  <button type="button" class="maar-cancel-btn" data-cancel-jid="' + esc(job.id) + '">Cancel</button>';
            if (st === 'running' || st === 'queued') {
              h += '  <button type="button" class="maar-complete-btn" data-complete-jid="' + esc(job.id) + '">Mark complete</button>';
            }
          }
          h += '  </div>';
          h += '</div>';

          // Meta
          h += '<div class="maar-batch-meta">';
          h += '  <span class="maar-batch-meta-item">' + icons.users + 'Run by ' + esc(job.created_by || '') + '</span>';
          h += '  <span class="maar-batch-meta-item">' + icons.calendar + fmtDate(job.start_date) + ' \u2013 ' + fmtDate(job.end_date) + '</span>';
          h += '  <span class="maar-batch-meta-item">' + icons.clock + 'Created ' + fmtDateTime(job.created_at) + '</span>';
          if (job.completed_at) h += '  <span class="maar-batch-meta-item">' + icons.done + 'Completed ' + fmtDateTime(job.completed_at) + '</span>';
          h += '</div>';

          // Progress bar (for running/queued)
          if (st === 'running' || st === 'queued') {
            h += '<div class="maar-batch-progress-row">';
            h += '  <div class="maar-batch-progress-bar"><div class="maar-progress"><div class="maar-progress-fill' + (pctIndeterminate ? ' active' : '') + '" style="width:' + pct + '%;"></div></div></div>';
            h += '  <div class="maar-batch-progress-pct">' + esc(pctLabel) + '</div>';
            h += '</div>';
            if (st === 'running' && ca === 0 && ta > 0) {
              h += '<div style="margin-top:4px;font-size:0.7rem;color:var(--color-text-tertiary,#9ca3af);">Progress updates when each agent finishes; results appear as conversations are audited.</div>';
            }
          }

          // Scheduled info
          if (st === 'scheduled') {
            h += '<div style="margin:8px 0;padding:8px 12px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;display:flex;align-items:center;gap:8px;">';
            h += '  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
            h += '  <span style="font-size:0.78rem;color:#92400e;font-weight:500;">Queued \u2014 will start automatically when a running audit completes.</span>';
            h += '</div>';
          }

          // Metrics row with icons
          h += '<div class="maar-batch-metrics">';
          h += '  <div class="maar-bm"><div class="maar-bm-icon" style="background:#05966915; color:#059669;">' + icons.users + '</div><div class="maar-bm-text"><span class="maar-bm-val">' + realAgentCount + '</span><span class="maar-bm-lbl">Agents</span></div></div>';
          h += '  <div class="maar-bm"><div class="maar-bm-icon" style="background:#3b82f615; color:#3b82f6;">' + icons.chat + '</div><div class="maar-bm-text"><span class="maar-bm-val">' + (bestConvoCount != null ? bestConvoCount : '\u2014') + '</span><span class="maar-bm-lbl">Conversations</span></div></div>';
          if (realConvoCount && realConvoCount > 0) {
            h += '  <div class="maar-bm"><div class="maar-bm-icon" style="background:#10b98115; color:#10b981;">' + icons.check + '</div><div class="maar-bm-text"><span class="maar-bm-val" style="color:#166534;">' + realPassed + '</span><span class="maar-bm-lbl">Passed</span></div></div>';
            h += '  <div class="maar-bm"><div class="maar-bm-icon" style="background:#ef444415; color:#ef4444;">' + icons.alert + '</div><div class="maar-bm-text"><span class="maar-bm-val" style="color:' + (realFailed > 0 ? '#b91c1c' : '#166534') + ';">' + realFailed + '</span><span class="maar-bm-lbl">Failed</span></div></div>';
          } else {
            h += '  <div class="maar-bm"><div class="maar-bm-icon" style="background:#9ca3af15; color:#9ca3af;">' + icons.done + '</div><div class="maar-bm-text"><span class="maar-bm-val">' + ca + '/' + ta + '</span><span class="maar-bm-lbl">Agents Done</span></div></div>';
          }
          h += '</div>';

          // Pass/Fail distribution bar (only if we have results)
          if (realConvoCount && realConvoCount > 0) {
            const passW = passRate.toFixed(1);
            const failW = (100 - passRate).toFixed(1);
            h += '<div class="maar-pf-section">';
            h += '  <div class="maar-pf-header">';
            h += '    <span class="maar-pf-title">Pass / Fail Distribution</span>';
            h += '    <span class="maar-pf-rate" style="color:' + (passRateRounded >= 80 ? '#166534' : passRateRounded >= 50 ? '#854d0e' : '#b91c1c') + ';">' + passRateRounded + '% pass rate</span>';
            h += '  </div>';
            h += '  <div class="maar-pf-track">';
            h += '    <div class="maar-pf-seg-passed" style="width:' + passW + '%;"></div>';
            h += '    <div class="maar-pf-seg-failed" style="width:' + failW + '%;"></div>';
            h += '  </div>';
            h += '  <div class="maar-pf-legend">';
            h += '    <span class="maar-pf-legend-passed"><span class="maar-pf-legend-dot" style="background:#10b981;"></span> ' + realPassed + ' Passed</span>';
            h += '    <span class="maar-pf-legend-failed"><span class="maar-pf-legend-dot" style="background:#ef4444;"></span> ' + realFailed + ' Failed</span>';
            h += '  </div>';
            h += '</div>';
          }

          h += '</div>'; // end .maar-batch-main

          // RIGHT: Score Ring
          if (realAvg != null) {
            h += '<div class="maar-batch-score-col">';
            h += '  <div class="maar-batch-lg-ring">';
            h += '    <svg viewBox="0 0 52 52"><circle class="maar-batch-lg-ring-bg" cx="26" cy="26" r="' + ringRadius + '"/><circle class="maar-batch-lg-ring-fg" cx="26" cy="26" r="' + ringRadius + '" stroke="' + ringColor + '" stroke-dasharray="' + ringCirc.toFixed(2) + '" stroke-dashoffset="' + ringDashOffset.toFixed(2) + '"/></svg>';
            h += '    <div class="maar-batch-lg-ring-label"><span class="maar-batch-lg-ring-val" style="color:' + ringColor + ';">' + realAvg + '%</span><span class="maar-batch-lg-ring-lbl">Avg Score</span></div>';
            h += '  </div>';
            if (minScore != null && maxScore != null) {
              h += '  <div class="maar-batch-score-range">Min ' + minScore + '% \u00b7 Max ' + maxScore + '%</div>';
            }
            h += '</div>';
          }

          h += '</div>'; // end .maar-batch-layout

          // Error severity chips (if we have errors)
          if (bErr.total > 0) {
            h += '<div class="maar-batch-error-row">';
            h += '  <span class="maar-batch-err-title">' + icons.alert + ' ' + bErr.total + ' Errors:</span>';
            if (bErr.criticalFail > 0) h += '<span class="maar-error-pill maar-ep-cfail">' + bErr.criticalFail + ' Fail-All</span>';
            if (bErr.critical > 0) h += '<span class="maar-error-pill maar-ep-crit">' + bErr.critical + ' Critical</span>';
            if (bErr.significant > 0) h += '<span class="maar-error-pill maar-ep-sig">' + bErr.significant + ' Significant</span>';
            if (bErr.major > 0) h += '<span class="maar-error-pill maar-ep-maj">' + bErr.major + ' Major</span>';
            if (bErr.minor > 0) h += '<span class="maar-error-pill maar-ep-min">' + bErr.minor + ' Minor</span>';
            h += '</div>';
          }

          h += '</div></div>'; // end .maar-batch-body, .maar-batch
        });
        $('batches-list').innerHTML = h;

        $('batches-list').querySelectorAll('.maar-batch').forEach(card => {
          card.addEventListener('click', (e) => {
            // Don't navigate if cancel or complete button was clicked
            if (e.target.closest('.maar-cancel-btn') || e.target.closest('.maar-complete-btn')) return;
            goToBatch(card.getAttribute('data-jid'));
          });
        });

        // Cancel buttons
        $('batches-list').querySelectorAll('.maar-cancel-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const jid = btn.getAttribute('data-cancel-jid');
            if (!jid) return;
            const ok = await cancelJob(jid);
            if (ok) {
              $('batches-loading').style.display = 'flex';
              $('batches-loading').querySelector('span').textContent = 'Refreshing…';
              $('batches-list').style.display = 'none';
              try { await loadBatchesWithFilters(); } catch (ex) { console.error(ex); }
              $('batches-loading').style.display = 'none';
            }
          });
        });
        // Mark complete buttons
        $('batches-list').querySelectorAll('.maar-complete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const jid = btn.getAttribute('data-complete-jid');
            if (!jid) return;
            const ok = await completeJob(jid);
            if (ok) {
              $('batches-loading').style.display = 'flex';
              $('batches-loading').querySelector('span').textContent = 'Refreshing…';
              $('batches-list').style.display = 'none';
              try { await loadBatchesWithFilters(); } catch (ex) { console.error(ex); }
              $('batches-loading').style.display = 'none';
            }
          });
        });
      }

      /* ═══════════════════════════════════════════════════════
       *  VIEW 2: Batch Detail
       * ═══════════════════════════════════════════════════════ */
      async function loadBatch(jobId) {
        $('batch-kpis').innerHTML = '';
        $('batch-error-bar').innerHTML = '';
        $('batch-agents').innerHTML = '';
        $('batch-agents-title').style.display = 'none';
        $('batch-cancel-bar').style.display = 'none';
        $('batch-loading').style.display = 'block';

        try {
          let res = cache[jobId];
          if (!res) { res = await api('/api/massive-ai-audit/jobs/' + encodeURIComponent(jobId) + '/assignments'); cache[jobId] = res; }
          curResults = res || [];
          $('batch-loading').style.display = 'none';

          // Fetch full job detail (includes payload_snapshot for agent info)
          let jobDetail = allJobs.find(j => j.id === jobId);
          try {
            const full = await api('/api/massive-ai-audit/jobs/' + encodeURIComponent(jobId));
            if (full && full.id) jobDetail = full;
          } catch (_e) { /* fallback to allJobs entry */ }
          const job = jobDetail;
          const cancelBar = $('batch-cancel-bar');
          const resultCount = (curResults || []).length;
          const effectiveStatus = deriveStatus(job, resultCount);
          const showCancelBar = job && ['running', 'queued', 'scheduled'].includes(effectiveStatus);
          if (showCancelBar) {
            const statusMsg = job.status === 'scheduled'
              ? 'Queued — will start when a slot is free.'
              : effectiveStatus === 'running'
                ? 'Running. You can cancel to free a slot.'
                : 'Queued. You can cancel to free a slot.';
            const showComplete = effectiveStatus === 'running' || effectiveStatus === 'queued';
            cancelBar.innerHTML = '<div class="maar-cancel-bar-compact">'
              + '<span class="maar-cancel-bar-text">' + statusMsg + '</span>'
              + '<div style="display:flex;gap:0.5rem;">'
              + (showComplete ? '<button type="button" id="batch-complete-btn" class="maar-complete-bar-btn">Mark complete</button>' : '')
              + '<button type="button" id="batch-cancel-btn" class="maar-cancel-bar-btn">Cancel batch</button>'
              + '</div></div>';
            cancelBar.style.display = 'block';
            if (showComplete && $('batch-complete-btn')) {
              $('batch-complete-btn').addEventListener('click', async () => {
                const ok = await completeJob(jobId);
                if (ok) {
                  try {
                    const path = buildJobsUrl();
                    const fresh = await api(path);
                    allJobs = fresh || [];
                    await fetchAllJobResults(allJobs);
                  } catch (ex) { console.error(ex); }
                  cancelBar.style.display = 'none';
                  cancelBar.innerHTML = '';
                  await loadBatch(jobId);
                }
              });
            }
            $('batch-cancel-btn').addEventListener('click', async () => {
              const ok = await cancelJob(jobId);
              if (ok) {
                try {
                  const path = buildJobsUrl();
                  const fresh = await api(path);
                  allJobs = fresh || [];
                  await fetchAllJobResults(allJobs);
                } catch (ex) { console.error(ex); }
                cancelBar.style.display = 'none';
                cancelBar.innerHTML = '';
                await loadBatch(jobId);
              }
            });
          } else {
            cancelBar.style.display = 'none';
            cancelBar.innerHTML = '';
          }

          setBatchHeaderStatus(job ? effectiveStatus : null);

          await renderBatchDetail(curResults, job);
        } catch (e) {
          $('batch-loading').style.display = 'none';
          $('batch-agents').innerHTML = '<div class="maar-empty"><p class="maar-empty-title">Failed to load</p><p>' + esc(e.message) + '</p></div>';
        }
      }

      async function renderBatchDetail(results, job) {
        if (!results.length) {
          // No results yet — show agent cards from payload_snapshot if available
          const agents = job && job.payload_snapshot && Array.isArray(job.payload_snapshot.agents)
            ? job.payload_snapshot.agents : [];
          if (agents.length > 0) {
            $('batch-kpis').innerHTML = '';
            $('batch-agents-title').style.display = 'flex';
            let ah = '';
            agents.forEach(function(ag) {
              const name = ag.name || ag.email || 'Unknown';
              const email = ag.email || '';
              const ini = initials(name);
              ah += '<div class="maar-agent" style="opacity:0.85;cursor:default;">';
              ah += '  <div class="maar-agent-header">';
              ah += '    <div class="maar-agent-avatar" style="background:#f3f4f6;color:#9ca3af;">' + esc(ini) + '</div>';
              ah += '    <div class="maar-agent-info">';
              ah += '      <div class="maar-agent-name">' + esc(name) + '</div>';
              if (email) ah += '      <div class="maar-agent-email">' + esc(email) + '</div>';
              ah += '    </div>';
              ah += '  </div>';
              ah += '  <div class="maar-agent-stats">';
              ah += '    <div class="maar-agent-stat"><span class="maar-agent-stat-val">\u2014</span><span class="maar-agent-stat-lbl">Convos</span></div>';
              ah += '    <div class="maar-agent-stat"><span class="maar-agent-stat-val">\u2014</span><span class="maar-agent-stat-lbl">Avg Score</span></div>';
              ah += '    <div class="maar-agent-stat"><span class="maar-agent-stat-val">\u2014</span><span class="maar-agent-stat-lbl">Pass Rate</span></div>';
              ah += '    <div class="maar-agent-stat"><span class="maar-agent-stat-val">\u2014</span><span class="maar-agent-stat-lbl">Errors</span></div>';
              ah += '  </div>';
              const statusLabel = job.status === 'scheduled' ? 'Scheduled' : job.status === 'queued' ? 'Queued' : 'Pending';
              const statusColor = job.status === 'scheduled' ? '#d97706' : '#6b7280';
              ah += '  <div style="margin-top:8px;padding:6px 10px;background:#f9fafb;border-radius:6px;text-align:center;">';
              ah += '    <span style="font-size:0.72rem;font-weight:500;color:' + statusColor + ';">' + esc(statusLabel) + ' \u2014 waiting for audit to start</span>';
              ah += '  </div>';
              ah += '</div>';
            });
            $('batch-agents').innerHTML = ah;
            return;
          }
          $('batch-kpis').innerHTML = '';
          $('batch-agents').innerHTML = '<div class="maar-empty"><p class="maar-empty-title">No results yet</p><p>This batch hasn\'t produced results yet. Check back if it\'s still running.</p></div>';
          return;
        }

        // Group by agent (fetch Intercom admins for alias display)
        await ensureIntercomAdmins();
        const agentMap = {};
        results.forEach(r => {
          const k = r.employee_email || r.employee_name || 'unknown';
          if (!agentMap[k]) {
            const email = r.employee_email || '';
            agentMap[k] = {
              name: r.employee_name || r.employee_email || 'Unknown',
              email,
              alias: getIntercomAlias(email) || null,
              convos: []
            };
          }
          agentMap[k].convos.push(r);
        });

        // Batch stats
        const n = results.length;
        const passed = results.filter(r => r.pass_fail === 'passed').length;
        const failed = results.filter(r => r.pass_fail === 'failed').length;
        const passRate = n > 0 ? Math.round((passed / n) * 100) : 0;
        const scores = results.filter(r => r.final_score != null).map(r => Number(r.final_score));
        const avg = scores.length ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;
        const minScore = scores.length ? Math.min(...scores) : null;
        const maxScore = scores.length ? Math.max(...scores) : null;

        let bErr = { total: 0, criticalFail: 0, critical: 0, significant: 0, major: 0, minor: 0 };
        results.forEach(r => { const e = errorsFrom(r.parameters_result); for (const k in bErr) bErr[k] += e[k]; });

        // KPI row
        let kh = '';
        kh += kpi('Agents', Object.keys(agentMap).length, '', '#059669', icons.users);
        kh += kpi('Conversations', n, '', '#3b82f6', icons.chat);
        kh += kpi('Avg Score', avg != null ? avg + '%' : '\u2014', minScore != null ? 'Min ' + minScore + '% \u00b7 Max ' + maxScore + '%' : '', '#10b981', icons.target, avg != null ? scoreColor(avg) : undefined);
        kh += kpi('Pass Rate', passRate + '%', passed + ' passed \u00b7 ' + failed + ' failed', passRate >= 80 ? '#10b981' : passRate >= 50 ? '#f59e0b' : '#ef4444', icons.check, passRate >= 80 ? '#166534' : passRate >= 50 ? '#854d0e' : '#b91c1c');
        kh += kpi('Total Errors', bErr.total, '', '#ef4444', icons.alert);
        kh += kpi('Critical', bErr.criticalFail + bErr.critical, bErr.criticalFail > 0 ? bErr.criticalFail + ' auto-fail' : '', '#7f1d1d', icons.zap, '#b91c1c');
        $('batch-kpis').innerHTML = kh;

        // Error distribution bar chart
        const maxErr = Math.max(bErr.criticalFail, bErr.critical, bErr.significant, bErr.major, bErr.minor, 1);
        const barData = [
          { label: 'Critical Fail', val: bErr.criticalFail, color: '#7f1d1d' },
          { label: 'Critical', val: bErr.critical, color: '#991b1b' },
          { label: 'Significant', val: bErr.significant, color: '#c2410c' },
          { label: 'Major', val: bErr.major, color: '#b45309' },
          { label: 'Minor', val: bErr.minor, color: '#ca8a04' },
        ];
        if (bErr.total > 0) {
          let bh = '<div class="maar-error-bar-wrap"><div class="maar-error-bar-title">Error Distribution</div>';
          barData.forEach(b => {
            const w = b.val > 0 ? Math.max((b.val / maxErr) * 100, 5) : 0;
            bh += '<div class="maar-error-bar-row">';
            bh += '<div class="maar-error-bar-label">' + b.label + '</div>';
            bh += '<div class="maar-error-bar-track"><div class="maar-error-bar-fill" style="width:' + w + '%; background:' + b.color + ';">' + (b.val > 0 ? b.val : '') + '</div></div>';
            bh += '<div class="maar-error-bar-count">' + b.val + '</div>';
            bh += '</div>';
          });
          bh += '</div>';
          $('batch-error-bar').innerHTML = bh;
        } else {
          $('batch-error-bar').innerHTML = '';
        }

        // Agent cards
        $('batch-agents-title').style.display = 'flex';
        let ah = '';
        Object.keys(agentMap).forEach(key => {
          const ag = agentMap[key];
          const convos = ag.convos;
          const aScores = convos.filter(c => c.final_score != null).map(c => Number(c.final_score));
          const aAvg = aScores.length ? Math.round(aScores.reduce((a, b) => a + b, 0) / aScores.length) : null;
          const aPassed = convos.filter(c => c.pass_fail === 'passed').length;
          const aFailed = convos.filter(c => c.pass_fail === 'failed').length;
          const aPassRate = convos.length > 0 ? Math.round((aPassed / convos.length) * 100) : 0;

          let aE = { total: 0, criticalFail: 0, critical: 0, significant: 0, major: 0, minor: 0 };
          convos.forEach(c => { const e = errorsFrom(c.parameters_result); for (const k in aE) aE[k] += e[k]; });

          // Score ring
          const radius = 18, circ = 2 * Math.PI * radius;
          const ringPct = aAvg != null ? aAvg / 100 : 0;
          const dashOffset = circ * (1 - ringPct);
          const ringColor = aAvg != null ? (aAvg >= 80 ? '#10b981' : aAvg >= 50 ? '#f59e0b' : '#ef4444') : '#d1d5db';

          ah += '<div class="maar-agent" data-ak="' + esc(key) + '" data-an="' + esc(ag.name) + '">';
          ah += '<div class="maar-agent-top">';
          ah += '  <div class="maar-agent-avatar">' + esc(initials(ag.name)) + '</div>';
          ah += '  <div class="maar-agent-info">';
          ah += '    <p class="maar-agent-name">' + esc(ag.name) + '</p>';
          if (ag.email && ag.email !== ag.name) ah += '    <p class="maar-agent-email">' + esc(ag.email) + '</p>';
          if (ag.alias && ag.alias !== ag.name) ah += '    <p class="maar-agent-alias" title="Intercom display name">Intercom: ' + esc(ag.alias) + '</p>';
          ah += '  </div>';
          ah += '  <div class="maar-agent-score-ring">';
          ah += '    <svg viewBox="0 0 44 44"><circle class="maar-agent-score-ring-bg" cx="22" cy="22" r="' + radius + '"/><circle class="maar-agent-score-ring-fg" cx="22" cy="22" r="' + radius + '" stroke="' + ringColor + '" stroke-dasharray="' + circ.toFixed(2) + '" stroke-dashoffset="' + dashOffset.toFixed(2) + '"/></svg>';
          ah += '    <div class="maar-agent-score-label">' + (aAvg != null ? aAvg + '%' : '\u2014') + '</div>';
          ah += '  </div>';
          ah += '</div>';

          ah += '<div class="maar-agent-stats">';
          ah += '  <div class="maar-agent-stat"><div class="maar-agent-stat-val">' + convos.length + '</div><div class="maar-agent-stat-lbl">Convos</div></div>';
          ah += '  <div class="maar-agent-stat"><div class="maar-agent-stat-val" style="color:' + (aPassRate >= 80 ? '#166534' : aPassRate >= 50 ? '#854d0e' : '#b91c1c') + ';">' + aPassRate + '%</div><div class="maar-agent-stat-lbl">Pass Rate</div></div>';
          ah += '  <div class="maar-agent-stat"><div class="maar-agent-stat-val" style="color:' + (aE.total > 0 ? '#b91c1c' : '#166534') + ';">' + aE.total + '</div><div class="maar-agent-stat-lbl">Errors</div></div>';
          ah += '  <div class="maar-agent-stat"><div class="maar-agent-stat-val" style="color:' + (aE.criticalFail + aE.critical > 0 ? '#b91c1c' : '#166534') + ';">' + (aE.criticalFail + aE.critical) + '</div><div class="maar-agent-stat-lbl">Critical</div></div>';
          ah += '</div>';

          // Error pills
          let pills = '';
          if (aE.criticalFail > 0) pills += '<span class="maar-error-pill maar-ep-cfail">' + aE.criticalFail + ' Fail-All</span>';
          if (aE.critical > 0) pills += '<span class="maar-error-pill maar-ep-crit">' + aE.critical + ' Critical</span>';
          if (aE.significant > 0) pills += '<span class="maar-error-pill maar-ep-sig">' + aE.significant + ' Significant</span>';
          if (aE.major > 0) pills += '<span class="maar-error-pill maar-ep-maj">' + aE.major + ' Major</span>';
          if (aE.minor > 0) pills += '<span class="maar-error-pill maar-ep-min">' + aE.minor + ' Minor</span>';
          if (pills) ah += '<div class="maar-agent-pills">' + pills + '</div>';

          ah += '<div class="maar-agent-pf-row">';
          ah += '  <span class="maar-pill maar-pill-passed" style="font-size:0.625rem;">' + aPassed + ' Passed</span>';
          ah += '  <span class="maar-pill maar-pill-failed-pf" style="font-size:0.625rem;">' + aFailed + ' Failed</span>';
          ah += '</div>';
          ah += '</div>';
        });
        $('batch-agents').innerHTML = ah;

        $('batch-agents').querySelectorAll('.maar-agent').forEach(card => {
          card.addEventListener('click', () => goToAgent(card.getAttribute('data-ak'), card.getAttribute('data-an')));
        });
      }

      /* ═══════════════════════════════════════════════════════
       *  VIEW 3: Agent Conversations
       * ═══════════════════════════════════════════════════════ */
      function renderConvos(agentKey) {
        const convos = curResults.filter(r => (r.employee_email || r.employee_name || 'unknown') === agentKey);
        curAgentConvos = convos;

        // Agent KPIs
        const aScores = convos.filter(c => c.final_score != null).map(c => Number(c.final_score));
        const aAvg = aScores.length ? Math.round(aScores.reduce((a, b) => a + b, 0) / aScores.length) : null;
        const aMin = aScores.length ? Math.min(...aScores) : null;
        const aMax = aScores.length ? Math.max(...aScores) : null;
        const passed = convos.filter(c => c.pass_fail === 'passed').length;
        const failed = convos.filter(c => c.pass_fail === 'failed').length;
        const passRate = convos.length > 0 ? Math.round((passed / convos.length) * 100) : 0;
        let aE = { total: 0, criticalFail: 0, critical: 0, significant: 0, major: 0, minor: 0 };
        convos.forEach(c => { const e = errorsFrom(c.parameters_result); for (const k in aE) aE[k] += e[k]; });
        const avgErrors = convos.length > 0 ? (aE.total / convos.length).toFixed(1) : '0';

        let kh = '';
        kh += kpi('Conversations', convos.length, '', '#3b82f6', icons.chat);
        kh += kpi('Avg Score', aAvg != null ? aAvg + '%' : '\u2014', aMin != null ? 'Min ' + aMin + '% \u00b7 Max ' + aMax + '%' : '', '#10b981', icons.target, aAvg != null ? scoreColor(aAvg) : undefined);
        kh += kpi('Pass Rate', passRate + '%', passed + ' passed \u00b7 ' + failed + ' failed', passRate >= 80 ? '#10b981' : passRate >= 50 ? '#f59e0b' : '#ef4444', icons.check, passRate >= 80 ? '#166534' : passRate >= 50 ? '#854d0e' : '#b91c1c');
        kh += kpi('Total Errors', aE.total, 'Avg ' + avgErrors + ' per conversation', '#ef4444', icons.alert);
        kh += kpi('Critical', aE.criticalFail + aE.critical, aE.criticalFail > 0 ? aE.criticalFail + ' auto-fail' : '', '#7f1d1d', icons.zap, '#b91c1c');
        kh += kpi('Significant+', aE.significant + aE.major + aE.minor, aE.significant + ' sig \u00b7 ' + aE.major + ' maj \u00b7 ' + aE.minor + ' min', '#c2410c', icons.bar);
        $('convos-kpis').innerHTML = kh;

        $('conv-search').value = '';
        $('conv-pf').value = '';
        $('conv-sort').value = 'errors-desc';
        renderConvoTable();
      }

      function renderConvoTable() {
        const search = $('conv-search').value.toLowerCase().trim();
        const pf = $('conv-pf').value;
        const sort = $('conv-sort').value;

        let list = curAgentConvos.slice();
        if (search) list = list.filter(c => (c.conversation_id || '').toLowerCase().includes(search) || (c.ai_notes || '').toLowerCase().includes(search));
        if (pf) list = list.filter(c => c.pass_fail === pf);

        list.sort((a, b) => {
          const ae = errorsFrom(a.parameters_result).total, be = errorsFrom(b.parameters_result).total;
          const as = a.final_score != null ? Number(a.final_score) : -1, bs = b.final_score != null ? Number(b.final_score) : -1;
          const ad = new Date(a.created_at || 0).getTime(), bd = new Date(b.created_at || 0).getTime();
          switch (sort) {
            case 'errors-desc': return be - ae;
            case 'errors-asc': return ae - be;
            case 'score-asc': return as - bs;
            case 'score-desc': return bs - as;
            case 'date-desc': return bd - ad;
            case 'date-asc': return ad - bd;
            default: return be - ae;
          }
        });

        const tbody = $('conv-tbody');
        const tableCard = $('conv-table-card');
        const emptyEl = $('conv-empty');

        if (!list.length) { tbody.innerHTML = ''; tableCard.style.display = 'none'; emptyEl.style.display = 'block'; return; }
        tableCard.style.display = 'block';
        emptyEl.style.display = 'none';

        let rh = '';
        list.forEach((r, i) => {
          const e = errorsFrom(r.parameters_result);
          const sc = r.final_score != null ? Number(r.final_score) : null;
          const scHtml = sc != null ? '<span class="maar-score ' + scoreClass(sc) + '">' + sc + '%</span>' : '\u2014';
          const rpf = r.pass_fail || 'n/a';
          const conf = r.confidence_score != null ? Number(r.confidence_score) + '%' : '\u2014';
          const cid = r.conversation_id || '';

          function errBadge(val, type) {
            if (val === 0) return '<span class="maar-err-num maar-err-zero">0</span>';
            if (type === 'crit') return '<span class="maar-err-num maar-err-some">' + val + '</span>';
            return '<span class="maar-err-num maar-err-warn">' + val + '</span>';
          }

          rh += '<tr data-ci="' + i + '">';
          rh += '<td><span class="maar-conv-id">' + esc(truncId(cid)) + '</span></td>';
          rh += '<td>' + scHtml + '</td>';
          rh += '<td><span class="maar-pill ' + pfClass(rpf) + '">' + esc(rpf.toUpperCase()) + '</span></td>';
          rh += '<td>' + errBadge(e.total, e.total > 3 ? 'crit' : 'warn') + '</td>';
          rh += '<td>' + errBadge(e.criticalFail + e.critical, 'crit') + '</td>';
          rh += '<td>' + errBadge(e.significant, 'warn') + '</td>';
          rh += '<td>' + errBadge(e.major, 'warn') + '</td>';
          rh += '<td>' + errBadge(e.minor, 'warn') + '</td>';
          rh += '<td>' + esc(conf) + '</td>';
          rh += '<td style="white-space:nowrap;">' + esc(fmtDate(r.audit_date || r.created_at)) + '</td>';
          rh += '</tr>';
        });
        tbody.innerHTML = rh;
        tbody._data = list;

        tbody.querySelectorAll('tr[data-ci]').forEach(tr => {
          tr.addEventListener('click', () => {
            const i = +tr.getAttribute('data-ci');
            if (tbody._data?.[i]) openModal(tbody._data[i]);
          });
        });
      }

      $('conv-search').addEventListener('input', renderConvoTable);
      $('conv-pf').addEventListener('change', renderConvoTable);
      $('conv-sort').addEventListener('change', renderConvoTable);

      /* ═══════════════════════════════════════════════════════
       *  Detail Modal
       * ═══════════════════════════════════════════════════════ */
      const overlay = $('maar-overlay');

      async function openModal(result) {
        await ensureIntercomAdmins();
        const agent = result.employee_name || result.employee_email || 'Unknown';
        const alias = getIntercomAlias(result.employee_email || '');
        $('modal-title').textContent = 'Conversation ' + (result.conversation_id ? truncId(result.conversation_id) : '');

        const cid = result.conversation_id || '';
        const cLink = cid ? '<a href="https://app.intercom.com/a/inbox/_/inbox/conversation/' + encodeURIComponent(cid) + '" target="_blank" rel="noopener">Open in Intercom</a>' : '';
        let sp = ['Agent: <strong>' + esc(agent) + '</strong>'];
        if (alias && alias !== agent) sp.push('Intercom: <strong>' + esc(alias) + '</strong>');
        if (cLink) sp.push(cLink);
        sp.push('Date: ' + esc(fmtDate(result.audit_date || result.created_at)));
        $('modal-sub').innerHTML = sp.join('<span style="color:var(--color-text-tertiary,#9ca3af); margin:0 0.4rem;">\u00b7</span>');

        let h = '';

        // Score cards
        const sc = result.final_score != null ? Number(result.final_score) : null;
        const conf = result.confidence_score != null ? Number(result.confidence_score) : null;
        const pf = result.pass_fail || 'n/a';

        h += '<div class="maar-modal-scores">';
        h += '<div class="maar-modal-sc"><p class="maar-modal-sc-label">Score</p><p class="maar-modal-sc-val" style="color:' + (sc != null ? scoreColor(sc) : '#374151') + ';">' + (sc != null ? sc + '%' : '\u2014') + '</p></div>';
        h += '<div class="maar-modal-sc"><p class="maar-modal-sc-label">Result</p><p class="maar-modal-sc-val"><span class="maar-pill ' + pfClass(pf) + '" style="font-size:1rem;">' + esc(pf.toUpperCase()) + '</span></p></div>';
        h += '<div class="maar-modal-sc"><p class="maar-modal-sc-label">Confidence</p><p class="maar-modal-sc-val" style="color:#374151;">' + (conf != null ? (conf > 1 ? conf + '%' : (conf * 100).toFixed(0) + '%') : '\u2014') + '</p></div>';
        h += '<div class="maar-modal-sc"><p class="maar-modal-sc-label">Status</p><p class="maar-modal-sc-val"><span class="maar-pill ' + pillClass(result.status || 'completed') + '" style="font-size:0.8125rem;">' + statusLabel(result.status || 'completed') + '</span></p></div>';
        h += '</div>';

        // Error counts
        const params = Array.isArray(result.parameters_result) ? result.parameters_result : [];
        const e = errorsFrom(params);
        h += '<div class="maar-modal-errors"><div class="maar-modal-err-grid">';
        [['Total Errors', e.total], ['Critical Fail', e.criticalFail], ['Critical', e.critical], ['Significant', e.significant], ['Major', e.major], ['Minor', e.minor]].forEach(([l, v]) => {
          h += '<div><p class="maar-modal-err-label">' + l + '</p><div class="maar-modal-err-val">' + v + '</div></div>';
        });
        h += '</div></div>';

        // Param rows
        if (params.length > 0) {
          h += '<div class="maar-modal-section"><div class="maar-modal-section-title">' + icons.alert + ' Error Details</div>';
          h += '<div class="maar-param-wrap"><div class="maar-param-head"><div class="maar-pgrid hdr"><div>Error Type</div><div style="text-align:center;">Points</div><div style="text-align:center;">Severity</div><div style="text-align:center;">Status</div><div>Feedback</div></div></div>';
          h += '<div style="padding:0 0.875rem 0.875rem;">';
          params.forEach(p => h += renderParam(p));
          h += '</div></div></div>';
        }

        // Scorecard data fallback
        const sd = result.scorecard_data;
        if (sd && typeof sd === 'object' && Object.keys(sd).length > 0 && params.length === 0) {
          h += '<div class="maar-modal-section"><div class="maar-modal-section-title">' + icons.bar + ' Scorecard Data</div>';
          h += '<div class="maar-param-wrap"><div style="padding:0.875rem;">';
          Object.keys(sd).forEach(k => {
            if (k.startsWith('feedback_')) return;
            h += '<div style="display:flex; gap:1rem; padding:0.4rem 0; border-bottom:1px solid var(--color-background-tertiary,#f3f4f6); font-size:0.8125rem;">';
            h += '<div style="font-weight:600; color:var(--color-text-primary,#1f2937); min-width:10rem;">' + esc(k) + '</div>';
            h += '<div style="color:var(--color-text-secondary,#374151);">' + esc(String(sd[k])) + '</div></div>';
          });
          h += '</div></div></div>';
        }

        // AI notes
        if (result.ai_notes) {
          h += '<div class="maar-modal-section"><div class="maar-modal-section-title">' + icons.zap + ' AI Notes</div>';
          h += '<div class="maar-ai-notes">' + esc(result.ai_notes) + '</div></div>';
        }

        _currentModalResult = result;
        _currentModalBodyHtml = h;
        const modalEl = $('maar-modal');
        modalEl.classList.remove('expanded');
        $('modal-body').innerHTML = h;
        const expandBtn = $('modal-expand-btn');
        const backBtn = $('modal-back-btn');
        if (cid) { expandBtn.classList.remove('hidden'); expandBtn.disabled = false; } else { expandBtn.classList.add('hidden'); }
        backBtn.classList.add('hidden');
        overlay.style.display = 'flex';
        requestAnimationFrame(() => requestAnimationFrame(() => overlay.classList.add('open')));
      }

      let _currentModalResult = null;
      let _currentModalBodyHtml = '';

      async function expandModal() {
        const result = _currentModalResult;
        const cid = result?.conversation_id || '';
        if (!cid || !_currentModalBodyHtml) return;
        const modalEl = $('maar-modal');
        modalEl.classList.add('expanded');
        $('modal-body').innerHTML =
          '<div class="maar-modal-body-inner expanded">' +
          '<div class="maar-expanded-left">' +
          '<div class="maar-expanded-conversation-wrap">' +
          '<div style="font-size:0.75rem; font-weight:600; color:var(--color-text-secondary,#6b7280); margin-bottom:0.5rem;">Conversation</div>' +
          '<div id="maar-expanded-conversation-container"></div>' +
          '</div></div>' +
          '<div class="maar-expanded-splitter"></div>' +
          '<div class="maar-expanded-right">' + _currentModalBodyHtml + '</div>' +
          '</div>';
        $('modal-expand-btn').classList.add('hidden');
        $('modal-back-btn').classList.remove('hidden');
        try {
          const { ConversationPanel } = await import('/js/features/audit-form/presentation/components/conversation-panel.js');
          const panel = new ConversationPanel({
            containerId: 'maar-expanded-conversation-container',
            showInfoGrid: false,
            showAttributes: false
          });
          await panel.init();
          await panel.loadConversation(cid);
        } catch (err) {
          console.error('[maar] Failed to load conversation panel:', err);
          const wrap = document.querySelector('.maar-expanded-left .maar-expanded-conversation-wrap');
          if (wrap) {
            const container = document.getElementById('maar-expanded-conversation-container');
            if (container) container.innerHTML = '<div style="padding:1rem; color:#b91c1c; font-size:0.875rem;">Failed to load conversation. Check console.</div>';
          }
        }
      }

      function collapseModal() {
        const modalEl = $('maar-modal');
        modalEl.classList.remove('expanded');
        $('modal-body').innerHTML = _currentModalBodyHtml;
        $('modal-expand-btn').classList.remove('hidden');
        $('modal-back-btn').classList.add('hidden');
      }

      function closeModal() {
        const modalEl = $('maar-modal');
        if (modalEl.classList.contains('expanded')) collapseModal();
        overlay.classList.remove('open');
        overlay.classList.add('closing');
        setTimeout(() => { overlay.style.display = 'none'; overlay.classList.remove('closing'); }, 200);
      }

      $('modal-close').addEventListener('click', closeModal);
      $('modal-expand-btn').addEventListener('click', () => expandModal());
      $('modal-back-btn').addEventListener('click', collapseModal);
      overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape' && overlay.style.display !== 'none') closeModal(); });

      function sevStyle(cat, isFail) {
        const c = (cat || '').toLowerCase();
        if (isFail || c.includes('fail')) return { bg: '#7f1d1d', fg: '#fff', lbl: 'CRITICAL FAIL' };
        if (c.includes('critical')) return { bg: '#991b1b', fg: '#fff', lbl: 'CRITICAL' };
        if (c.includes('significant')) return { bg: '#c2410c', fg: '#fff', lbl: 'SIGNIFICANT' };
        if (c.includes('major')) return { bg: '#b45309', fg: '#fff', lbl: 'MAJOR' };
        if (c.includes('minor')) return { bg: '#ca8a04', fg: '#fff', lbl: 'MINOR' };
        return { bg: '#b91c1c', fg: '#fff', lbl: (cat || 'ERROR').toUpperCase() };
      }

      function renderParam(p) {
        const m = Number(p.measurement) || 0;
        const s = sevStyle(p.error_category, p.is_fail_all);
        const has = m > 0;
        const stHtml = has
          ? '<span style="color:#ef4444; font-weight:700;">' + m + ' \u2716</span>'
          : '<span style="color:#10b981; font-weight:700;">\u2714</span>';
        const fb = Array.isArray(p.feedback) ? p.feedback : [];
        const fbHtml = fb.length > 0 ? '<ul>' + fb.map(f => '<li>' + esc(String(f)) + '</li>').join('') + '</ul>' : '<span style="color:var(--color-text-tertiary,#9ca3af); font-style:italic;">No feedback</span>';

        return '<div class="maar-prow"><div class="maar-pgrid">'
          + '<div class="maar-pname"><span style="font-weight:700; color:' + (has ? '#ef4444' : '#10b981') + ';">' + (has ? '\u2212' : '+') + '</span> ' + esc(p.error_name || 'Parameter') + '</div>'
          + '<div class="maar-ppoints">' + (p.penalty_points || 0) + '</div>'
          + '<div style="text-align:center;"><span class="maar-sev-badge" style="background:' + s.bg + '; color:' + s.fg + ';">' + s.lbl + '</span></div>'
          + '<div class="maar-pstatus">' + stHtml + '</div>'
          + '<div class="maar-pfeedback">' + fbHtml + '</div>'
          + '</div></div>';
      }

      /* ═══════════════════════════════════════════════════════
       *  Keyboard Navigation
       * ═══════════════════════════════════════════════════════ */
      document.addEventListener('keydown', (e) => {
        // Alt+Left or Backspace (when not focused on input) = go back
        if (e.altKey && e.key === 'ArrowLeft') { e.preventDefault(); goBack(); return; }
        if (e.key === 'Backspace' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) {
          e.preventDefault();
          goBack();
        }
      });

      /* ═══════════════════════════════════════════════════════
       *  Init
       * ═══════════════════════════════════════════════════════ */
      // Build result counts per job from the results array
      function buildResultCounts(results) {
        const map = {};
        (results || []).forEach(r => {
          const jid = r.job_id;
          if (!jid) return;
          if (!map[jid]) map[jid] = { count: 0, passed: 0, failed: 0, scores: [] };
          map[jid].count++;
          if (r.pass_fail === 'passed') map[jid].passed++;
          if (r.pass_fail === 'failed') map[jid].failed++;
          if (r.final_score != null) map[jid].scores.push(Number(r.final_score));
        });
        // Calculate averages
        for (const jid in map) {
          const s = map[jid].scores;
          map[jid].avgScore = s.length > 0 ? Math.round(s.reduce((a, b) => a + b, 0) / s.length) : null;
          delete map[jid].scores; // free memory
        }
        return map;
      }

      // Fetch all results per-job using /assignments endpoint (no row limit)
      async function fetchAllJobResults(jobs) {
        const results = await Promise.all(
          (jobs || []).map(j =>
            api('/api/massive-ai-audit/jobs/' + encodeURIComponent(j.id) + '/assignments')
              .then(res => ({ jobId: j.id, results: res || [] }))
              .catch(() => ({ jobId: j.id, results: [] }))
          )
        );
        // Populate cache and build flat array for buildResultCounts
        const allFlat = [];
        results.forEach(({ jobId, results: res }) => {
          cache[jobId] = res;
          res.forEach(r => { r.job_id = jobId; allFlat.push(r); });
        });
        resultCountsByJob = buildResultCounts(allFlat);
      }

      function getFilterParams() {
        const createdBy = ($('filter-created-by') && $('filter-created-by').value) ? $('filter-created-by').value.trim() : '';
        const status = ($('filter-status') && $('filter-status').value) ? $('filter-status').value.trim() : '';
        const scorecardId = ($('filter-scorecard') && $('filter-scorecard').value) ? $('filter-scorecard').value.trim() : '';
        const fromDate = ($('filter-from-date') && $('filter-from-date').value) ? $('filter-from-date').value.trim() : '';
        const toDate = ($('filter-to-date') && $('filter-to-date').value) ? $('filter-to-date').value.trim() : '';
        return { createdBy, status, scorecardId, fromDate, toDate };
      }

      function buildJobsUrl() {
        const p = getFilterParams();
        const params = new URLSearchParams();
        if (p.createdBy) params.set('created_by', p.createdBy);
        if (p.status) params.set('status', p.status);
        if (p.scorecardId) params.set('scorecard_id', p.scorecardId);
        if (p.fromDate && /^\d{4}-\d{2}-\d{2}$/.test(p.fromDate)) params.set('from_date', p.fromDate);
        if (p.toDate && /^\d{4}-\d{2}-\d{2}$/.test(p.toDate)) params.set('to_date', p.toDate);
        const q = params.toString();
        return '/api/massive-ai-audit/jobs' + (q ? '?' + q : '');
      }

      function buildAnalyticsUrl() {
        const p = getFilterParams();
        const params = new URLSearchParams();
        if (p.createdBy) params.set('created_by', p.createdBy);
        if (p.status) params.set('status', p.status);
        if (p.scorecardId) params.set('scorecard_id', p.scorecardId);
        if (p.fromDate && /^\d{4}-\d{2}-\d{2}$/.test(p.fromDate)) params.set('from_date', p.fromDate);
        if (p.toDate && /^\d{4}-\d{2}-\d{2}$/.test(p.toDate)) params.set('to_date', p.toDate);
        const q = params.toString();
        return '/api/massive-ai-audit/analytics' + (q ? '?' + q : '');
      }

      async function loadBatchesWithFilters() {
        const path = buildJobsUrl();
        const jobs = await api(path);
        allJobs = jobs || [];
        await fetchAllJobResults(allJobs);
        renderBatches(allJobs);
        $('batches-filters').style.display = 'flex';
        try {
          const analyticsPath = buildAnalyticsUrl();
          const analytics = await api(analyticsPath);
          lastAnalytics = analytics;
          renderInsights(analytics);
        } catch (e) { console.warn('[MassiveAI] Analytics fetch failed', e); lastAnalytics = null; renderInsights(null); }
      }

      async function loadOverview() {
        const loadingEl = $('overview-loading');
        const emptyEl = $('overview-empty');
        if (loadingEl) loadingEl.style.display = 'flex';
        if (emptyEl) emptyEl.style.display = 'none';
        try {
          const analytics = await api(buildAnalyticsUrl());
          lastAnalytics = analytics;
          renderInsights(analytics);
        } catch (e) { console.warn('[MassiveAI] Overview fetch failed', e); lastAnalytics = null; renderInsights(null); }
        if (loadingEl) loadingEl.style.display = 'none';
      }

      function switchTab(tabName) {
        const tabBatches = $('tab-batches');
        const tabOverview = $('tab-overview');
        if (tabName === 'overview') {
          showView('v-overview');
          if (tabBatches) { tabBatches.classList.remove('active'); tabBatches.setAttribute('aria-selected', 'false'); }
          if (tabOverview) { tabOverview.classList.add('active'); tabOverview.setAttribute('aria-selected', 'true'); }
          if (!lastAnalytics) loadOverview();
          scrollTop();
        } else {
          goToBatches(true);
          if (tabOverview) { tabOverview.classList.remove('active'); tabOverview.setAttribute('aria-selected', 'false'); }
          if (tabBatches) { tabBatches.classList.add('active'); tabBatches.setAttribute('aria-selected', 'true'); }
        }
      }

      /* ═══════════════════════════════════════════════════════
       *  Tooltip system
       * ═══════════════════════════════════════════════════════ */
      var _tipEl = $('maar-tooltip');
      function showTip(html, e) {
        if (!_tipEl || !html) return;
        _tipEl.innerHTML = html;
        _tipEl.classList.add('visible');
        moveTip(e);
      }
      function moveTip(e) {
        if (!_tipEl) return;
        var x = e.clientX + 12, y = e.clientY + 12;
        var tw = _tipEl.offsetWidth, th = _tipEl.offsetHeight;
        if (x + tw > window.innerWidth - 8) x = e.clientX - tw - 12;
        if (y + th > window.innerHeight - 8) y = e.clientY - th - 12;
        _tipEl.style.left = x + 'px'; _tipEl.style.top = y + 'px';
      }
      function hideTip() { if (_tipEl) _tipEl.classList.remove('visible'); }

      document.addEventListener('mouseover', function(e) {
        var el = e.target.closest('[data-tip]');
        if (el) showTip(el.getAttribute('data-tip'), e);
      });
      document.addEventListener('mousemove', function(e) {
        if (_tipEl && _tipEl.classList.contains('visible')) moveTip(e);
      });
      document.addEventListener('mouseout', function(e) {
        var el = e.target.closest('[data-tip]');
        if (el) hideTip();
      });

      /* ═══════════════════════════════════════════════════════
       *  Number formatting
       * ═══════════════════════════════════════════════════════ */
      function fmtN(n) { if (n == null) return '\u2014'; return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

      /* ═══════════════════════════════════════════════════════
       *  Overview render functions
       * ═══════════════════════════════════════════════════════ */
      var _empSortCol = 'failed', _empSortAsc = false;
      var _critSortCol = 'failureRatePct', _critSortAsc = false;
      var _lastInsightsData = null;

      var _panelRendered = {};

      function renderInsights(data) {
        _lastInsightsData = data;
        _panelRendered = {};
        var block = $('maar-insights');
        var summaryEl = $('maar-insights-summary');
        var healthCard = $('maar-health-card');
        var overviewEmpty = $('overview-empty');
        if (!data || !data.summary) { block.classList.remove('visible'); if (overviewEmpty) overviewEmpty.style.display = 'block'; return; }
        var s = data.summary;
        if (s.totalConversations === 0) { block.classList.remove('visible'); if (overviewEmpty) overviewEmpty.style.display = 'block'; return; }
        block.classList.add('visible');
        if (overviewEmpty) overviewEmpty.style.display = 'none';

        /* ── Health card (professional gauge + metrics) ── */
        var pct = s.passRatePct || 0;
        var hLevel = 'strong', hCls = 'health-strong', hTitle = 'Strong Performance', hNote = 'Quality levels are on track. Continuing regular monitoring is recommended.';
        if (pct < 50 || (s.avgScore != null && s.avgScore < 50)) {
          hLevel = 'developing'; hCls = 'health-developing'; hTitle = 'Developing';
          hNote = 'There is opportunity to strengthen quality further. The details below can help identify focus areas.';
        } else if (pct < 80 || (s.avgScore != null && s.avgScore < 70)) {
          hLevel = 'moderate'; hCls = 'health-moderate'; hTitle = 'Moderate';
          hNote = 'Quality is at an acceptable level with room for growth. Review the trends and breakdowns for specifics.';
        }
        var gaugeColor = hLevel === 'strong' ? '#10b981' : hLevel === 'moderate' ? '#f59e0b' : '#6366f1';
        if (healthCard) {
          healthCard.style.display = 'flex';
          healthCard.className = 'maar-health-card ' + hCls;
          healthCard.innerHTML = ''
            + '<div class="maar-health-left">'
            + '<svg class="maar-health-gauge" viewBox="0 0 80 80">'
            + '<circle cx="40" cy="40" r="32" fill="none" stroke="#e5e7eb" stroke-width="7"/>'
            + '<circle cx="40" cy="40" r="32" fill="none" stroke="' + gaugeColor + '" stroke-width="7" stroke-linecap="round" stroke-dasharray="' + (pct / 100 * 201.1).toFixed(1) + ' 201.1" transform="rotate(-90 40 40)" style="transition:stroke-dasharray 0.6s ease;"/>'
            + '<text x="40" y="37" text-anchor="middle" font-size="15" font-weight="700" fill="#111827">' + pct + '%</text>'
            + '<text x="40" y="49" text-anchor="middle" font-size="7.5" fill="#9ca3af" font-weight="500">pass rate</text>'
            + '</svg></div>'
            + '<div class="maar-health-center">'
            + '<p class="maar-health-title">' + esc(hTitle) + '</p>'
            + '<p class="maar-health-subtitle">' + esc(hNote) + '</p>'
            + '<div class="maar-health-metrics">'
            + '<div class="maar-health-metric"><span class="maar-health-metric-val">' + fmtN(s.totalConversations) + '</span><span class="maar-health-metric-label">Audited</span></div>'
            + '<div class="maar-health-metric"><span class="maar-health-metric-val">' + (s.avgScore != null ? s.avgScore + '%' : '\u2014') + '</span><span class="maar-health-metric-label">Avg score</span></div>'
            + '<div class="maar-health-metric"><span class="maar-health-metric-val">' + fmtN(s.totalErrors) + '</span><span class="maar-health-metric-label">Total issues</span></div>'
            + '<div class="maar-health-metric"><span class="maar-health-metric-val">' + fmtN(s.passed) + '</span><span class="maar-health-metric-label">Passed</span></div>'
            + '</div></div>';
        }

        /* ── Period comparison from trend data ── */
        var trendArr = data.trend || [];
        var halfIdx = Math.floor(trendArr.length / 2);
        var prevHalf = trendArr.slice(0, halfIdx);
        var currHalf = trendArr.slice(halfIdx);
        function avgOfArr(arr, key) {
          if (!arr.length) return null;
          var sum = 0, cnt = 0;
          arr.forEach(function(t) { if (t[key] != null) { sum += t[key]; cnt++; } });
          return cnt > 0 ? Math.round(sum / cnt) : null;
        }
        function sumOfArr(arr, key) { return arr.reduce(function(s, t) { return s + (t[key] || 0); }, 0); }
        var prevPR = avgOfArr(prevHalf, 'passRatePct');
        var currPR = avgOfArr(currHalf, 'passRatePct');
        var prevAS = avgOfArr(prevHalf, 'avgScore');
        var currAS = avgOfArr(currHalf, 'avgScore');
        var prevErrs = sumOfArr(prevHalf, 'totalErrors');
        var currErrs = sumOfArr(currHalf, 'totalErrors');
        var prevTotal = sumOfArr(prevHalf, 'total');
        var currTotal = sumOfArr(currHalf, 'total');
        var hasDelta = trendArr.length >= 4;

        function deltaHtml(curr, prev, suffix, invertColor) {
          if (!hasDelta || curr == null || prev == null) return '';
          var diff = curr - prev;
          if (diff === 0) return '<div class="maar-kpi-delta neutral">\u2014 no change</div>';
          var isGood = invertColor ? diff < 0 : diff > 0;
          var cls = isGood ? 'up' : 'down';
          var arrow = diff > 0 ? '\u25B2' : '\u25BC';
          return '<div class="maar-kpi-delta ' + cls + '">' + arrow + ' ' + Math.abs(diff) + (suffix || '') + ' vs prior period</div>';
        }

        /* ── KPI cards ── */
        function kpi(label, val, sub, tip, deltaStr) {
          return '<div class="maar-kpi" data-tip="' + esc(tip || '') + '"><div class="maar-kpi-label">' + esc(label) + '</div><div class="maar-kpi-value">' + esc(String(val)) + '</div>' + (sub ? '<div class="maar-kpi-sublabel">' + esc(sub) + '</div>' : '') + (deltaStr || '') + '</div>';
        }
        summaryEl.innerHTML = ''
          + kpi('Conversations', fmtN(s.totalConversations), fmtN(s.passed) + ' passed, ' + fmtN(s.failed) + ' did not pass', 'Total conversations audited in the selected date range.', deltaHtml(currTotal, prevTotal, ''))
          + kpi('Pass rate', s.passRatePct + '%', 'of all audited', 'Percentage of conversations that met all criteria thresholds.', deltaHtml(currPR, prevPR, '%'))
          + kpi('Avg score', s.avgScore != null ? s.avgScore + '%' : '\u2014', 'across all results', 'Average quality score across all audited conversations.', deltaHtml(currAS, prevAS, '%'))
          + kpi('Total issues', fmtN(s.totalErrors), fmtN(s.criticalFail + s.critical) + ' critical \u00b7 ' + fmtN(s.significant + s.major + s.minor) + ' other', 'Total quality issues identified across all conversations.', deltaHtml(currErrs, prevErrs, '', true));

        /* ── Always-visible charts ── */
        renderScoreTrendLines($('maar-score-trend-chart'), data.trend || []);
        renderSeverityDonut($('maar-severity-donut-chart'), data.severityBreakdown || {});

        /* ── Top 5 criteria list ── */
        var top5El = $('maar-top5-criteria');
        var cd = data.criteriaDetails || [];
        var top5 = cd.filter(function(c) { return c.timesFailed > 0; }).sort(function(a, b) { return b.failureRatePct - a.failureRatePct; }).slice(0, 5);
        if (top5.length === 0) {
          top5El.innerHTML = '<li style="color:#9ca3af;padding:0.5rem 0;">No criteria issues identified in this range.</li>';
        } else {
          top5El.innerHTML = top5.map(function(c, i) {
            return '<li data-tip="' + esc(c.errorName + ': triggered in ' + c.failureRatePct + '% of evaluations (' + fmtN(c.timesFailed) + ' of ' + fmtN(c.timesEvaluated) + '). Severity: ' + (c.severity || 'unclassified')) + '">'
              + '<span class="maar-top5-rank">' + (i + 1) + '</span>'
              + '<span class="maar-top5-name">' + esc(c.errorName) + '</span>'
              + '<span class="maar-top5-val">' + c.failureRatePct + '%</span>'
              + '</li>';
          }).join('');
        }

        /* ── Panel badges ── */
        var empBadge = $('panel-emp-badge');
        if (empBadge && data.byEmployee) empBadge.textContent = data.byEmployee.length + ' agents';
        var scBadge = $('panel-sc-badge');
        if (scBadge && data.byScorecard) scBadge.textContent = data.byScorecard.length + ' scorecards';
        var critBadge = $('panel-crit-badge');
        if (critBadge && cd.length) critBadge.textContent = cd.length + ' criteria';

        /* ── Smart Insights (auto-generated) ── */
        renderSmartInsights(data, s, cd, trendArr);

        /* ── Team Health Distribution ── */
        renderTeamHealth(data.byEmployee || []);

        /* ── Compliance Dashboard ── */
        renderComplianceDash(data.failAllStats || {}, s, data.byEmployee || []);

        /* ── Top Focus Areas ── */
        renderFocusAreas(cd, s);

        var secRow = $('maar-secondary-row');
        if (secRow) secRow.style.display = 'grid';

        /* ── Lazy-render panels ── */
        renderPanelIfOpen('panel-employees');
        renderPanelIfOpen('panel-scorecards');
        renderPanelIfOpen('panel-distributions');
        renderPanelIfOpen('panel-criteria');
      }

      function renderPanelIfOpen(panelId) {
        var panel = $(panelId);
        if (!panel || !panel.open || _panelRendered[panelId]) return;
        _panelRendered[panelId] = true;
        var data = _lastInsightsData;
        if (!data) return;
        if (panelId === 'panel-employees') renderEmployeeTable($('maar-employee-table-wrap'), data.byEmployee || []);
        if (panelId === 'panel-scorecards') renderByScorecardChart($('maar-by-scorecard-chart'), data.byScorecard || []);
        if (panelId === 'panel-distributions') {
          renderScoreDistribution($('maar-score-dist-chart'), data.scoreDistribution || []);
          renderErrorCountDistribution($('maar-error-dist-chart'), data.errorCountDistribution || []);
          renderRiskMatrix($('maar-risk-matrix-chart'), data.riskMatrix || []);
          renderTrendChart($('maar-trend-chart'), data.trend || []);
        }
        if (panelId === 'panel-criteria') renderCriteriaTable($('maar-criteria-table-wrap'), data.criteriaDetails || []);
      }

      // Listen for panel opens to lazy-render
      ['panel-employees', 'panel-scorecards', 'panel-distributions', 'panel-criteria'].forEach(function(id) {
        var el = $(id);
        if (el) el.addEventListener('toggle', function() { renderPanelIfOpen(id); });
      });

      /* ════ NEW: Smart Insights Engine ════ */
      function renderSmartInsights(data, s, cd, trendArr) {
        var el = $('maar-smart-insights');
        if (!el) return;
        var insights = [];
        var iconWarn = '<svg class="si-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="#92400e" stroke-width="1.5"><circle cx="8" cy="8" r="6.5"/><line x1="8" y1="5" x2="8" y2="8.5"/><circle cx="8" cy="11" r="0.5" fill="#92400e"/></svg>';
        var iconOk = '<svg class="si-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="#065f46" stroke-width="1.5"><circle cx="8" cy="8" r="6.5"/><polyline points="5.5,8 7.5,10 10.5,6"/></svg>';
        var iconInfo = '<svg class="si-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="#92400e" stroke-width="1.5"><circle cx="8" cy="8" r="6.5"/><line x1="8" y1="7.5" x2="8" y2="11"/><circle cx="8" cy="5.5" r="0.5" fill="#92400e"/></svg>';
        var isPositive = true;

        if (s.passRatePct < 50) {
          insights.push(iconWarn + '<span>Pass rate is at <strong>' + s.passRatePct + '%</strong>. Review the criteria breakdown below to identify primary drivers.</span>');
          isPositive = false;
        } else if (s.passRatePct < 70) {
          insights.push(iconInfo + '<span>Pass rate of <strong>' + s.passRatePct + '%</strong> has room for growth. The focus areas below highlight where to concentrate effort.</span>');
          isPositive = false;
        }

        var emps = data.byEmployee || [];
        var lowEmps = emps.filter(function(e) { return e.total >= 3 && e.passRatePct < 50; });
        if (lowEmps.length > 0) {
          insights.push(iconWarn + '<span><strong>' + lowEmps.length + ' agent' + (lowEmps.length > 1 ? 's' : '') + '</strong> ' + (lowEmps.length > 1 ? 'have' : 'has') + ' a pass rate below 50%. Targeted coaching may help.</span>');
          isPositive = false;
        }

        var failAll = data.failAllStats || {};
        if (failAll.failAllRatePct > 10) {
          insights.push(iconWarn + '<span>Compliance violation rate is <strong>' + failAll.failAllRatePct + '%</strong>. Review auto-fail criteria in the compliance section.</span>');
          isPositive = false;
        }

        if (cd.length > 0) {
          var topCrit = cd.filter(function(c) { return c.timesFailed > 0; }).sort(function(a, b) { return b.timesFailed - a.timesFailed; });
          if (topCrit.length > 0) {
            var totalFails = topCrit.reduce(function(s, c) { return s + c.timesFailed; }, 0);
            var top1Pct = totalFails > 0 ? Math.round(topCrit[0].timesFailed / totalFails * 100) : 0;
            if (top1Pct >= 25) {
              insights.push(iconInfo + '<span>"<strong>' + esc(topCrit[0].errorName) + '</strong>" accounts for ' + top1Pct + '% of all issues. Addressing this could meaningfully improve quality.</span>');
              isPositive = false;
            }
          }
        }

        if (trendArr.length >= 4) {
          var halfIdx = Math.floor(trendArr.length / 2);
          var earlyAvg = 0, lateAvg = 0, eC = 0, lC = 0;
          trendArr.forEach(function(t, i) {
            if (t.passRatePct != null) {
              if (i < halfIdx) { earlyAvg += t.passRatePct; eC++; }
              else { lateAvg += t.passRatePct; lC++; }
            }
          });
          earlyAvg = eC > 0 ? earlyAvg / eC : 0;
          lateAvg = lC > 0 ? lateAvg / lC : 0;
          var trendDiff = Math.round(lateAvg - earlyAvg);
          if (trendDiff >= 5) {
            insights.push(iconOk + '<span>Quality is <strong>trending upward</strong> (+' + trendDiff + '% pass rate in the recent period).</span>');
          } else if (trendDiff <= -5) {
            insights.push(iconWarn + '<span>Quality has <strong>declined</strong> (' + trendDiff + '% pass rate) in the recent period. Consider reviewing recent changes.</span>');
            isPositive = false;
          }
        }

        if (s.passRatePct >= 80 && insights.length === 0) {
          insights.push(iconOk + '<span>Quality is strong at <strong>' + s.passRatePct + '%</strong> pass rate. Continue regular monitoring.</span>');
        }

        if (insights.length === 0) { el.style.display = 'none'; return; }
        el.style.display = 'block';
        el.className = 'maar-smart-insights' + (isPositive ? ' type-positive' : '');
        el.innerHTML = '<div class="maar-smart-insights-title">'
          + (isPositive ? iconOk : iconWarn)
          + ' Insights</div>'
          + '<ul class="maar-smart-insights-list">' + insights.map(function(t) { return '<li>' + t + '</li>'; }).join('') + '</ul>';
      }

      /* ════ NEW: Team Health Distribution ════ */
      function renderTeamHealth(byEmployee) {
        var el = $('maar-team-health');
        if (!el) return;
        var qualified = byEmployee.filter(function(e) { return e.total >= 2; });
        if (qualified.length < 2) { el.style.display = 'none'; return; }
        var top = 0, avg = 0, low = 0;
        qualified.forEach(function(e) {
          var pr = e.passRatePct != null ? e.passRatePct : 0;
          if (pr >= 80) top++;
          else if (pr >= 50) avg++;
          else low++;
        });
        var total = qualified.length;
        var topPct = Math.round(top / total * 100);
        var avgPct = Math.round(avg / total * 100);
        var lowPct = 100 - topPct - avgPct;

        el.style.display = 'block';
        el.innerHTML = '<h4>'
          + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
          + 'Team health (' + total + ' agents)'
          + '<button class="maar-info-btn" data-tip="Shows how agents are distributed across performance tiers based on pass rate. Top: \u226580%, Average: 50-79%, Needs coaching: &lt;50%." aria-label="Info">?</button>'
          + '</h4>'
          + '<div class="maar-team-bar">'
          + (topPct > 0 ? '<div class="maar-team-bar-seg top" style="width:' + topPct + '%;">' + (topPct >= 12 ? top : '') + '</div>' : '')
          + (avgPct > 0 ? '<div class="maar-team-bar-seg avg" style="width:' + avgPct + '%;">' + (avgPct >= 12 ? avg : '') + '</div>' : '')
          + (lowPct > 0 ? '<div class="maar-team-bar-seg low" style="width:' + lowPct + '%;">' + (lowPct >= 12 ? low : '') + '</div>' : '')
          + '</div>'
          + '<div class="maar-team-bar-legend">'
          + '<span><span class="dot" style="background:#059669;"></span>Top performers: ' + top + ' (' + topPct + '%)</span>'
          + '<span><span class="dot" style="background:#f59e0b;"></span>Average: ' + avg + ' (' + avgPct + '%)</span>'
          + '<span><span class="dot" style="background:#ef4444;"></span>Needs coaching: ' + low + ' (' + lowPct + '%)</span>'
          + '</div>';
      }

      /* ════ NEW: Compliance Dashboard ════ */
      function renderComplianceDash(failAllStats, s, byEmployee) {
        var el = $('maar-compliance');
        if (!el) return;
        var fa = failAllStats;
        if (!fa || !fa.failAllCriteria || fa.failAllCriteria.length === 0) {
          if (s.totalConversations > 0) {
            el.style.display = 'block';
            el.innerHTML = '<h4>'
              + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9,12 11,14 15,10"/></svg>'
              + 'Compliance status</h4>'
              + '<p style="font-size:0.8rem;color:#059669;font-weight:600;margin:0;">No compliance violations detected in this period.</p>';
            return;
          }
          el.style.display = 'none';
          return;
        }
        var violationRate = fa.failAllRatePct || 0;
        var violationColor = violationRate > 10 ? '#dc2626' : violationRate > 5 ? '#f59e0b' : '#059669';

        var topAgents = byEmployee.filter(function(e) { return e.failAllCount > 0; })
          .sort(function(a, b) { return b.failAllCount - a.failAllCount; })
          .slice(0, 3);

        el.style.display = 'block';
        var h = '<h4>'
          + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="' + violationColor + '" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>'
          + 'Compliance status'
          + '<button class="maar-info-btn" data-tip="Compliance criteria trigger an automatic fail. This section shows how often they occur and which criteria are involved." aria-label="Info">?</button>'
          + '</h4>';
        h += '<div class="maar-compliance-stats">';
        h += '<div class="maar-compliance-stat"><span class="maar-compliance-stat-val" style="color:' + violationColor + ';">' + violationRate + '%</span><span class="maar-compliance-stat-label">Violation rate</span></div>';
        h += '<div class="maar-compliance-stat"><span class="maar-compliance-stat-val">' + fmtN(fa.totalConversationsWithFailAll) + '</span><span class="maar-compliance-stat-label">Affected conversations</span></div>';
        h += '</div>';

        if (fa.failAllCriteria.length > 0) {
          h += '<ul class="maar-compliance-list">';
          fa.failAllCriteria.slice(0, 5).forEach(function(c) {
            h += '<li><span class="c-name">' + esc(c.errorName) + '</span><span class="c-count">' + fmtN(c.count) + ' triggers</span></li>';
          });
          h += '</ul>';
        }
        if (topAgents.length > 0) {
          h += '<div style="margin-top:0.6rem;padding-top:0.5rem;border-top:1px solid #f3f4f6;">';
          h += '<div style="font-size:0.7rem;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.03em;margin-bottom:0.35rem;">Most affected agents</div>';
          h += '<ul class="maar-compliance-list">';
          topAgents.forEach(function(a) {
            h += '<li><span class="c-name">' + esc((a.employeeName || a.employeeKey || '').slice(0, 30)) + '</span><span class="c-count">' + a.failAllCount + ' violations</span></li>';
          });
          h += '</ul></div>';
        }
        el.innerHTML = h;
      }

      /* ════ NEW: Top Focus Areas ════ */
      function renderFocusAreas(criteriaDetails, s) {
        var el = $('maar-focus-areas');
        if (!el) return;
        var cd = (criteriaDetails || []).filter(function(c) { return c.timesFailed > 0 && c.timesEvaluated > 0; });
        if (cd.length < 1) { el.style.display = 'none'; return; }

        var totalFails = cd.reduce(function(s, c) { return s + c.timesFailed; }, 0);
        var sorted = cd.slice().sort(function(a, b) {
          return (b.timesFailed * (b.avgPenaltyPoints || 1)) - (a.timesFailed * (a.avgPenaltyPoints || 1));
        });
        var top3 = sorted.slice(0, 3);
        var top3Fails = top3.reduce(function(s, c) { return s + c.timesFailed; }, 0);
        var top3Pct = totalFails > 0 ? Math.round(top3Fails / totalFails * 100) : 0;

        el.style.display = 'block';
        var h = '<h4>'
          + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
          + 'Priority focus areas'
          + '<button class="maar-info-btn" data-tip="Criteria ranked by combined impact (frequency \u00d7 penalty). Addressing these will have the biggest effect on overall quality." aria-label="Info">?</button>'
          + '</h4>';
        h += '<p class="maar-focus-areas-desc">These ' + top3.length + ' criteria account for <strong>' + top3Pct + '%</strong> of all triggered issues. Addressing them could meaningfully improve pass rates.</p>';
        top3.forEach(function(c, i) {
          var impactPct = totalFails > 0 ? Math.round(c.timesFailed / totalFails * 100) : 0;
          var barColor = i === 0 ? '#ef4444' : i === 1 ? '#f59e0b' : '#6b7280';
          h += '<div class="maar-focus-item">';
          h += '<div class="maar-focus-num' + (i === 1 ? ' n2' : i === 2 ? ' n3' : '') + '">' + (i + 1) + '</div>';
          h += '<div class="maar-focus-body">';
          h += '<div class="maar-focus-name">' + esc(c.errorName) + '</div>';
          h += '<div class="maar-focus-detail">Triggered ' + fmtN(c.timesFailed) + ' times (' + c.failureRatePct + '% failure rate) \u00b7 ' + impactPct + '% of total issues \u00b7 Severity: ' + esc(c.severity || 'unclassified') + '</div>';
          h += '<div class="maar-focus-bar"><div class="maar-focus-bar-fill" style="width:' + impactPct + '%;background:' + barColor + ';"></div></div>';
          h += '</div></div>';
        });
        el.innerHTML = h;
      }

      /* 3. Score + Pass Rate Trend Lines with hover dots */
      function renderScoreTrendLines(container, trend) {
        if (!container) return;
        var legendEl = $('maar-score-trend-legend');
        if (!trend || trend.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No trend data available yet.</p>'; if (legendEl) legendEl.innerHTML = ''; return; }
        var pad = { top: 20, right: 20, bottom: 36, left: 48 };
        var w = Math.max(300, (container.clientWidth || 600) - pad.left - pad.right);
        var h = Math.max(160, 220);
        function toY(v) { return pad.top + h - (v / 100) * h; }
        var pathPR = '', pathAS = '';
        var dots = [];
        trend.forEach(function(t, i) {
          var x = pad.left + (trend.length === 1 ? w / 2 : (i / (trend.length - 1)) * w);
          pathPR += (i === 0 ? 'M' : 'L') + x.toFixed(1) + ',' + toY(t.passRatePct).toFixed(1);
          if (t.avgScore != null) pathAS += (pathAS ? 'L' : 'M') + x.toFixed(1) + ',' + toY(t.avgScore).toFixed(1);
          var dateLabel = t.date ? t.date.slice(5, 7) + '/' + t.date.slice(8, 10) : '';
          dots.push({ x: x, t: t, dateLabel: dateLabel });
        });
        var totalW = pad.left + w + pad.right, totalH = pad.top + h + pad.bottom;
        var svg = '<svg width="100%" height="' + totalH + '" viewBox="0 0 ' + totalW + ' ' + totalH + '">';
        svg += '<defs><linearGradient id="gradPR" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#10b981" stop-opacity="0.12"/><stop offset="100%" stop-color="#10b981" stop-opacity="0.01"/></linearGradient></defs>';
        for (var i = 0; i <= 4; i++) {
          var y = pad.top + h - (i / 4) * h;
          svg += '<line x1="' + pad.left + '" y1="' + y + '" x2="' + (pad.left + w) + '" y2="' + y + '" stroke="#e2e8f0" stroke-width="1"/>';
          svg += '<text x="' + (pad.left - 8) + '" y="' + (y + 4) + '" text-anchor="end" font-size="11" fill="#94a3b8" font-weight="500">' + (i * 25) + '%</text>';
        }
        svg += '<line x1="' + pad.left + '" y1="' + (pad.top + h) + '" x2="' + (pad.left + w) + '" y2="' + (pad.top + h) + '" stroke="#e5e7eb"/>';
        trend.forEach(function(t, i) { var x = pad.left + (trend.length === 1 ? w / 2 : (i / (trend.length - 1)) * w); var l = t.date ? (t.date.slice(5, 7) + '/' + t.date.slice(8, 10)) : ''; if (l && (trend.length < 20 || i % Math.ceil(trend.length / 15) === 0)) svg += '<text x="' + x + '" y="' + (pad.top + h + 22) + '" text-anchor="middle" font-size="10" fill="#9ca3af">' + l + '</text>'; });
        var firstX = dots.length > 0 ? dots[0].x : pad.left;
        var lastX = dots.length > 0 ? dots[dots.length - 1].x : pad.left + w;
        if (pathPR) svg += '<path d="' + pathPR + 'L' + lastX.toFixed(1) + ',' + (pad.top + h) + 'L' + firstX.toFixed(1) + ',' + (pad.top + h) + 'Z" fill="url(#gradPR)"/>';
        svg += '<path d="' + pathPR + '" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
        if (pathAS) svg += '<path d="' + pathAS + '" fill="none" stroke="#6366f1" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="5,3"/>';
        dots.forEach(function(d) {
          var tipPR = "<div class='tip-title'>" + esc(d.dateLabel) + "</div><div class='tip-val'>Pass rate: " + d.t.passRatePct + "%</div><div class='tip-sub'>Avg score: " + (d.t.avgScore != null ? d.t.avgScore + '%' : '\u2014') + " \u00b7 " + fmtN(d.t.total) + " conversations \u00b7 " + fmtN(d.t.totalErrors) + " issues</div>";
          svg += '<circle class="maar-hover-dot" cx="' + d.x.toFixed(1) + '" cy="' + toY(d.t.passRatePct).toFixed(1) + '" r="5" fill="#fff" stroke="#10b981" stroke-width="2" data-tip="' + esc(tipPR) + '"/>';
          if (d.t.avgScore != null) svg += '<circle class="maar-hover-dot" cx="' + d.x.toFixed(1) + '" cy="' + toY(d.t.avgScore).toFixed(1) + '" r="4" fill="#fff" stroke="#6366f1" stroke-width="2" data-tip="' + esc(tipPR) + '"/>';
        });
        svg += '</svg>';
        container.innerHTML = svg;
        if (legendEl) legendEl.innerHTML = '<span><span style="display:inline-block;width:14px;height:2px;background:#10b981;border-radius:1px;"></span> Pass rate</span><span><span style="display:inline-block;width:14px;height:0;border-bottom:1.5px dashed #6366f1;"></span> Avg score</span>';
      }

      /* 4a. Score Distribution Histogram */
      function renderScoreDistribution(container, dist) {
        if (!container) return;
        if (!dist || dist.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No score data available.</p>'; return; }
        var totalConv = dist.reduce(function(s, d) { return s + d.count; }, 0);
        var maxCount = Math.max(1, Math.max.apply(null, dist.map(function(d) { return d.count; })));
        var pad = { top: 14, right: 10, bottom: 32, left: 36 };
        var barGap = 4;
        var n = dist.length;
        var barW = Math.max(16, ((container.clientWidth || 300) - pad.left - pad.right - (n - 1) * barGap) / n);
        var w = pad.left + n * barW + (n - 1) * barGap + pad.right;
        var h = 160;
        var baseY = pad.top + h;
        var svg = '<svg width="100%" height="' + (baseY + pad.bottom) + '" viewBox="0 0 ' + w + ' ' + (baseY + pad.bottom) + '">';
        svg += '<line x1="' + pad.left + '" y1="' + baseY + '" x2="' + (w - pad.right) + '" y2="' + baseY + '" stroke="#e5e7eb"/>';
        for (var si = 0; si <= 4; si++) { var v = Math.round((si / 4) * maxCount); var y = baseY - (v / maxCount) * h; svg += '<text x="' + (pad.left - 4) + '" y="' + (y + 4) + '" text-anchor="end" font-size="9" fill="#9ca3af">' + v + '</text>'; }
        var labels = ['0-10', '10-20', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90', '90-100'];
        var barPalette = ['#ef4444','#ef4444','#f87171','#fb923c','#fbbf24','#facc15','#a3e635','#4ade80','#34d399','#10b981'];
        dist.forEach(function(d, i) {
          var x = pad.left + i * (barW + barGap);
          var barH = (d.count / maxCount) * h;
          var color = barPalette[i] || '#93c5fd';
          var pctOfTotal = totalConv > 0 ? Math.round(d.count / totalConv * 100) : 0;
          var tip = "<div class='tip-title'>Score range: " + (labels[i] || d.bucket) + "%</div><div class='tip-val'>" + fmtN(d.count) + " conversations</div><div class='tip-sub'>" + pctOfTotal + "% of total</div>";
          svg += '<rect x="' + x.toFixed(1) + '" y="' + (baseY - barH).toFixed(1) + '" width="' + barW.toFixed(1) + '" height="' + Math.max(1, barH).toFixed(1) + '" fill="' + color + '" rx="3" data-tip="' + esc(tip) + '"/>';
          svg += '<text x="' + (x + barW / 2) + '" y="' + (baseY + 14) + '" text-anchor="middle" font-size="8" fill="#9ca3af">' + (labels[i] || d.bucket) + '</text>';
          if (d.count > 0) svg += '<text x="' + (x + barW / 2) + '" y="' + (baseY - barH - 3) + '" text-anchor="middle" font-size="9" fill="#374151" font-weight="600">' + d.count + '</text>';
        });
        svg += '</svg>';
        container.innerHTML = svg;
      }

      /* 4b. Severity Breakdown Donut */
      function renderSeverityDonut(container, sev) {
        if (!container) return;
        var items = [
          { label: 'Fail-all', value: sev.criticalFail || 0, color: '#991b1b', desc: 'Automatic failures due to compliance criteria' },
          { label: 'Critical', value: sev.critical || 0, color: '#dc2626', desc: 'High-priority quality concerns' },
          { label: 'Significant', value: sev.significant || 0, color: '#f97316', desc: 'Important areas that benefit from attention' },
          { label: 'Major', value: sev.major || 0, color: '#f59e0b', desc: 'Moderate-priority quality items' },
          { label: 'Minor', value: sev.minor || 0, color: '#10b981', desc: 'Low-priority observations' }
        ];
        var total = items.reduce(function(s, i) { return s + i.value; }, 0);
        if (total === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No issues identified in this range.</p>'; return; }
        var cx = 100, cy = 90, r = 70, ir = 45;
        var svg = '<svg width="100%" height="200" viewBox="0 0 200 200">';
        var angle = -90;
        items.forEach(function(item) {
          if (item.value === 0) return;
          var sweep = (item.value / total) * 360;
          var startRad = angle * Math.PI / 180;
          var endRad = (angle + sweep) * Math.PI / 180;
          var largeArc = sweep > 180 ? 1 : 0;
          var x1 = cx + r * Math.cos(startRad), y1 = cy + r * Math.sin(startRad);
          var x2 = cx + r * Math.cos(endRad), y2 = cy + r * Math.sin(endRad);
          var ix1 = cx + ir * Math.cos(endRad), iy1 = cy + ir * Math.sin(endRad);
          var ix2 = cx + ir * Math.cos(startRad), iy2 = cy + ir * Math.sin(startRad);
          var pct = Math.round(item.value / total * 100);
          var tip = "<div class='tip-title'>" + esc(item.label) + "</div><div class='tip-val'>" + fmtN(item.value) + " (" + pct + "%)</div><div class='tip-sub'>" + esc(item.desc) + "</div>";
          svg += '<path d="M' + x1.toFixed(2) + ',' + y1.toFixed(2) + ' A' + r + ',' + r + ' 0 ' + largeArc + ',1 ' + x2.toFixed(2) + ',' + y2.toFixed(2) + ' L' + ix1.toFixed(2) + ',' + iy1.toFixed(2) + ' A' + ir + ',' + ir + ' 0 ' + largeArc + ',0 ' + ix2.toFixed(2) + ',' + iy2.toFixed(2) + 'Z" fill="' + item.color + '" data-tip="' + esc(tip) + '"/>';
          angle += sweep;
        });
        svg += '<text x="' + cx + '" y="' + (cy - 4) + '" text-anchor="middle" font-size="18" font-weight="700" fill="#111827">' + fmtN(total) + '</text>';
        svg += '<text x="' + cx + '" y="' + (cy + 12) + '" text-anchor="middle" font-size="9" fill="#9ca3af">total issues</text>';
        svg += '</svg>';
        var legend = '<div style="display:flex;flex-wrap:wrap;gap:0.4rem 1rem;margin-top:0.5rem;font-size:0.75rem;">';
        items.forEach(function(item) { if (item.value > 0) legend += '<span style="display:inline-flex;align-items:center;gap:0.3rem;" data-tip="' + esc(item.desc) + '"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:' + item.color + ';"></span>' + esc(item.label) + ': ' + fmtN(item.value) + '</span>'; });
        legend += '</div>';
        container.innerHTML = svg + legend;
      }

      /* 5a. Error Count Distribution */
      function renderErrorCountDistribution(container, dist) {
        if (!container) return;
        if (!dist || dist.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No data available.</p>'; return; }
        var totalConv = dist.reduce(function(s, d) { return s + d.count; }, 0);
        var maxCount = Math.max(1, Math.max.apply(null, dist.map(function(d) { return d.count; })));
        var pad = { top: 14, right: 10, bottom: 36, left: 36 };
        var barGap = 10;
        var n = dist.length;
        var barW = Math.max(28, ((container.clientWidth || 300) - pad.left - pad.right - (n - 1) * barGap) / n);
        var w = pad.left + n * barW + (n - 1) * barGap + pad.right;
        var h = 160;
        var baseY = pad.top + h;
        var svg = '<svg width="100%" height="' + (baseY + pad.bottom) + '" viewBox="0 0 ' + w + ' ' + (baseY + pad.bottom) + '">';
        svg += '<line x1="' + pad.left + '" y1="' + baseY + '" x2="' + (w - pad.right) + '" y2="' + baseY + '" stroke="#e5e7eb"/>';
        var errLabels = ['No issues', '1 issue', '2 issues', '3 issues', '4 issues', '5+ issues'];
        var barColors = ['#10b981', '#4ade80', '#fbbf24', '#fb923c', '#ef4444', '#dc2626'];
        dist.forEach(function(d, i) {
          var x = pad.left + i * (barW + barGap);
          var barH = (d.count / maxCount) * h;
          var color = barColors[i] || '#c4b5fd';
          var pctOfTotal = totalConv > 0 ? Math.round(d.count / totalConv * 100) : 0;
          var tip = "<div class='tip-title'>" + (errLabels[i] || d.errors + ' issues') + "</div><div class='tip-val'>" + fmtN(d.count) + " conversations (" + pctOfTotal + "%)</div>";
          svg += '<rect x="' + x.toFixed(1) + '" y="' + (baseY - barH).toFixed(1) + '" width="' + barW.toFixed(1) + '" height="' + Math.max(1, barH).toFixed(1) + '" fill="' + color + '" rx="3" data-tip="' + esc(tip) + '"/>';
          svg += '<text x="' + (x + barW / 2) + '" y="' + (baseY + 14) + '" text-anchor="middle" font-size="10" font-weight="600" fill="#374151">' + d.errors + '</text>';
          if (d.count > 0) svg += '<text x="' + (x + barW / 2) + '" y="' + (baseY - barH - 4) + '" text-anchor="middle" font-size="10" fill="#374151" font-weight="600">' + d.count + '</text>';
        });
        svg += '<text x="' + (pad.left + (n * (barW + barGap)) / 2) + '" y="' + (baseY + 30) + '" text-anchor="middle" font-size="9" fill="#9ca3af">issues per conversation</text>';
        svg += '</svg>';
        container.innerHTML = svg;
      }

      /* 5b. Priority Matrix scatter */
      function renderRiskMatrix(container, riskMatrix) {
        if (!container) return;
        if (!riskMatrix || riskMatrix.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No criteria data available.</p>'; return; }
        var maxFreq = Math.max(1, Math.max.apply(null, riskMatrix.map(function(r) { return r.frequency; })));
        var maxPen = Math.max(1, Math.max.apply(null, riskMatrix.map(function(r) { return r.avgPenaltyPoints || 0; })));
        var pad = { top: 20, right: 16, bottom: 32, left: 44 };
        var w = Math.max(200, (container.clientWidth || 300) - pad.left - pad.right);
        var h = 160;
        var baseY = pad.top + h;
        var svg = '<svg width="100%" height="' + (baseY + pad.bottom) + '" viewBox="0 0 ' + (pad.left + w + pad.right) + ' ' + (baseY + pad.bottom) + '">';
        var midX = pad.left + w / 2, midY = pad.top + h / 2;
        svg += '<rect x="' + midX + '" y="' + pad.top + '" width="' + (w / 2) + '" height="' + (h / 2) + '" fill="#fef2f2" rx="4"/>';
        svg += '<rect x="' + pad.left + '" y="' + midY + '" width="' + (w / 2) + '" height="' + (h / 2) + '" fill="#f0fdf4" rx="4"/>';
        svg += '<line x1="' + pad.left + '" y1="' + baseY + '" x2="' + (pad.left + w) + '" y2="' + baseY + '" stroke="#d1d5db"/>';
        svg += '<line x1="' + pad.left + '" y1="' + pad.top + '" x2="' + pad.left + '" y2="' + baseY + '" stroke="#d1d5db"/>';
        svg += '<line x1="' + midX + '" y1="' + pad.top + '" x2="' + midX + '" y2="' + baseY + '" stroke="#e5e7eb" stroke-dasharray="4,3"/>';
        svg += '<line x1="' + pad.left + '" y1="' + midY + '" x2="' + (pad.left + w) + '" y2="' + midY + '" stroke="#e5e7eb" stroke-dasharray="4,3"/>';
        svg += '<text x="' + (pad.left + w - 2) + '" y="' + (baseY + 16) + '" text-anchor="end" font-size="9" fill="#9ca3af">Frequency \u2192</text>';
        svg += '<text x="' + (pad.left + 2) + '" y="' + (pad.top + 10) + '" font-size="9" fill="#9ca3af">\u2191 Impact</text>';
        svg += '<text x="' + (pad.left + w - 4) + '" y="' + (pad.top + 14) + '" text-anchor="end" font-size="8" fill="#dc2626">Higher combined impact</text>';
        svg += '<text x="' + (pad.left + 4) + '" y="' + (baseY - 4) + '" font-size="8" fill="#10b981">Lower combined impact</text>';
        var sevColor = { critical: '#dc2626', significant: '#f97316', major: '#f59e0b', minor: '#10b981' };
        var sevLabel = { critical: 'Critical', significant: 'Significant', major: 'Major', minor: 'Minor' };
        riskMatrix.forEach(function(r) {
          var x = pad.left + (r.frequency / maxFreq) * w * 0.9 + w * 0.05;
          var p = r.avgPenaltyPoints || 0;
          var y = baseY - (p / maxPen) * h * 0.9 - h * 0.05;
          var color = sevColor[r.severity] || '#94a3b8';
          var radius = Math.min(12, Math.max(5, 5 + r.frequency / maxFreq * 7));
          var tip = "<div class='tip-title'>" + esc(r.errorName) + "</div><div class='tip-val'>Occurs " + fmtN(r.frequency) + " times \u00b7 " + p + " penalty pts</div><div class='tip-sub'>Severity: " + esc(sevLabel[r.severity] || r.severity) + "</div>";
          svg += '<circle cx="' + x.toFixed(1) + '" cy="' + y.toFixed(1) + '" r="' + radius.toFixed(1) + '" fill="' + color + '" fill-opacity="0.5" stroke="' + color + '" stroke-width="1.5" data-tip="' + esc(tip) + '"/>';
        });
        svg += '</svg>';
        container.innerHTML = svg;
      }

      /* 6. Stacked bar daily error breakdown */
      function renderTrendChart(container, trend) {
        if (!container) return;
        var legendEl = $('maar-trend-legend');
        if (!trend || trend.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No trend data available.</p>'; if (legendEl) legendEl.innerHTML = ''; return; }
        var maxErrors = Math.max(1, Math.max.apply(null, trend.map(function(t) { return t.totalErrors || 0; })));
        var padding = { top: 12, right: 12, bottom: 36, left: 44 };
        var barGap = 6, n = trend.length;
        var barW = n ? Math.max(8, ((container.clientWidth || 400) - padding.left - padding.right - (n - 1) * barGap) / n) : 20;
        var w = padding.left + n * barW + (n - 1) * barGap + padding.right;
        var h = Math.max(140, 170);
        var baseY = padding.top + h;
        function yForErrors(err) { return baseY - (err / maxErrors) * h; }
        var criteriaTotals = {};
        trend.forEach(function(t) { (t.criteria || []).forEach(function(c) { criteriaTotals[c.errorName] = (criteriaTotals[c.errorName] || 0) + c.count; }); });
        var criteriaOrder = Object.keys(criteriaTotals).sort(function(a, b) { return (criteriaTotals[b] || 0) - (criteriaTotals[a] || 0); });
        var palette = ['#ef4444','#f97316','#f59e0b','#10b981','#0ea5e9','#6366f1','#8b5cf6','#ec4899','#14b8a6','#06b6d4','#94a3b8'];
        var colorByCriteria = {};
        criteriaOrder.forEach(function(name, i) { colorByCriteria[name] = palette[i % palette.length]; });
        var svg = '<svg class="maar-trend-chart" width="100%" height="100%" viewBox="0 0 ' + w + ' ' + (padding.top + h + padding.bottom) + '">';
        svg += '<line x1="' + padding.left + '" y1="' + baseY + '" x2="' + (w - padding.right) + '" y2="' + baseY + '" stroke="#e2e8f0"/>';
        svg += '<line x1="' + padding.left + '" y1="' + padding.top + '" x2="' + padding.left + '" y2="' + baseY + '" stroke="#e2e8f0"/>';
        var ySteps = maxErrors <= 5 ? Math.ceil(maxErrors) : 5;
        for (var si = 0; si <= ySteps; si++) { var step = Math.round((si / ySteps) * maxErrors); svg += '<text x="' + (padding.left - 6) + '" y="' + (yForErrors(step) + 4) + '" text-anchor="end" font-size="10" fill="#94a3b8">' + step + '</text>'; }
        trend.forEach(function(t, i) {
          var x = padding.left + i * (barW + barGap);
          var label = t.date ? (t.date.slice(5, 7) + '/' + t.date.slice(8, 10)) : '';
          if (label && (n < 20 || i % Math.ceil(n / 15) === 0)) svg += '<text x="' + (x + barW / 2) + '" y="' + (baseY + 18) + '" text-anchor="middle" font-size="10" fill="#9ca3af">' + label + '</text>';
          var acc = 0;
          (t.criteria || []).forEach(function(c) {
            var segH = (c.count / maxErrors) * h; if (segH < 0.5) return;
            var y = baseY - acc - segH; acc += segH;
            var color = colorByCriteria[c.errorName] || '#94a3b8';
            var tip = "<div class='tip-title'>" + (label || 'Day') + " \u2014 " + esc(c.errorName) + "</div><div class='tip-val'>" + c.count + " occurrences</div>";
            svg += '<rect x="' + x.toFixed(1) + '" y="' + y.toFixed(1) + '" width="' + barW.toFixed(1) + '" height="' + Math.max(1, segH).toFixed(1) + '" fill="' + color + '" rx="3" data-tip="' + esc(tip) + '"/>';
          });
          if (t.totalErrors > 0 && (!t.criteria || t.criteria.length === 0)) { var segH = (t.totalErrors / maxErrors) * h; svg += '<rect x="' + x.toFixed(1) + '" y="' + (baseY - segH).toFixed(1) + '" width="' + barW.toFixed(1) + '" height="' + Math.max(1, segH).toFixed(1) + '" fill="#94a3b8" data-tip="' + esc(label + ': ' + t.totalErrors + ' issues') + '"/>'; }
        });
        svg += '</svg>';
        container.innerHTML = svg;
        if (legendEl && criteriaOrder.length > 0) legendEl.innerHTML = criteriaOrder.slice(0, 12).map(function(name) { return '<span data-tip="' + esc(name) + '"><span style="display:inline-block;width:8px;height:8px;background:' + (colorByCriteria[name] || '#94a3b8') + ';border-radius:2px;vertical-align:middle;"></span> ' + esc(name.length > 24 ? name.slice(0, 24) + '\u2026' : name) + '</span>'; }).join('');
        else if (legendEl) legendEl.innerHTML = '';
      }

      /* 7. Employee Performance Table */
      function renderEmployeeTable(container, byEmployee) {
        if (!container) return;
        if (!byEmployee || byEmployee.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No agent data in this range.</p>'; return; }
        var sorted = byEmployee.slice().sort(function(a, b) {
          var av = a[_empSortCol], bv = b[_empSortCol];
          if (av == null) av = -Infinity; if (bv == null) bv = -Infinity;
          return _empSortAsc ? (av > bv ? 1 : av < bv ? -1 : 0) : (bv > av ? 1 : bv < av ? -1 : 0);
        });
        function arrow(col) { return '<span class="maar-sort-arrow' + (_empSortCol === col ? ' active' : '') + '">' + (_empSortCol === col ? (_empSortAsc ? '\u25B2' : '\u25BC') : '\u25BC') + '</span>'; }
        function pctClass(v) { return v >= 80 ? 'maar-cell-hi' : v >= 50 ? 'maar-cell-mid' : 'maar-cell-lo'; }
        function miniBar(pct, color) { return '<span class="maar-cell-bar-wrap"><span class="maar-cell-minibar" style="width:' + Math.max(2, pct * 0.6) + 'px;background:' + color + ';"></span></span>'; }
        var colTips = {
          employeeName: 'Agent name',
          total: 'Total conversations audited',
          passRatePct: 'Percentage of conversations that met all criteria thresholds',
          avgScore: 'Average quality score across all audited conversations',
          totalErrors: 'Total quality issues identified',
          avgErrorsPerConvo: 'Average issues per conversation',
          failAllCount: 'Conversations with automatic compliance flags'
        };
        var h = '<table class="maar-sortable-table" id="maar-emp-table"><thead><tr>';
        h += '<th data-col="employeeName" data-tip="' + esc(colTips.employeeName) + '">Agent ' + arrow('employeeName') + '</th>';
        h += '<th data-col="total" data-tip="' + esc(colTips.total) + '">Audited ' + arrow('total') + '</th>';
        h += '<th data-col="passRatePct" data-tip="' + esc(colTips.passRatePct) + '">Pass rate ' + arrow('passRatePct') + '</th>';
        h += '<th data-col="avgScore" data-tip="' + esc(colTips.avgScore) + '">Avg score ' + arrow('avgScore') + '</th>';
        h += '<th data-col="totalErrors" data-tip="' + esc(colTips.totalErrors) + '">Issues ' + arrow('totalErrors') + '</th>';
        h += '<th data-col="avgErrorsPerConvo" data-tip="' + esc(colTips.avgErrorsPerConvo) + '">Issues/convo ' + arrow('avgErrorsPerConvo') + '</th>';
        h += '<th data-col="failAllCount" data-tip="' + esc(colTips.failAllCount) + '">Auto-flags ' + arrow('failAllCount') + '</th>';
        h += '</tr></thead><tbody>';
        sorted.forEach(function(emp, idx) {
          var pr = emp.passRatePct != null ? emp.passRatePct : 0;
          var as = emp.avgScore != null ? emp.avgScore : 0;
          var prColor = pr >= 80 ? '#10b981' : pr >= 50 ? '#f59e0b' : '#ef4444';
          var asColor = as >= 80 ? '#10b981' : as >= 50 ? '#f59e0b' : '#ef4444';
          h += '<tr>';
          h += '<td>' + (idx + 1) + '. ' + esc((emp.employeeName || emp.employeeKey || '').slice(0, 30)) + '</td>';
          h += '<td class="maar-cell-num">' + fmtN(emp.total) + '</td>';
          h += '<td class="maar-cell-num ' + pctClass(pr) + '">' + miniBar(pr, prColor) + ' ' + pr + '%</td>';
          h += '<td class="maar-cell-num ' + pctClass(as) + '">' + miniBar(as, asColor) + ' ' + (emp.avgScore != null ? as + '%' : '\u2014') + '</td>';
          h += '<td class="maar-cell-num">' + fmtN(emp.totalErrors) + '</td>';
          h += '<td class="maar-cell-num">' + (emp.avgErrorsPerConvo || 0) + '</td>';
          h += '<td class="maar-cell-num' + (emp.failAllCount > 0 ? ' maar-cell-flag' : '') + '">' + (emp.failAllCount || 0) + '</td>';
          h += '</tr>';
        });
        h += '</tbody></table>';
        container.innerHTML = h;
        container.querySelectorAll('th[data-col]').forEach(function(th) {
          th.addEventListener('click', function() {
            var col = th.getAttribute('data-col');
            if (_empSortCol === col) _empSortAsc = !_empSortAsc; else { _empSortCol = col; _empSortAsc = false; }
            renderEmployeeTable(container, byEmployee);
          });
        });
      }

      /* 8. Scorecard comparison bar chart */
      function renderByScorecardChart(container, byScorecard) {
        if (!container) return;
        if (!byScorecard || byScorecard.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No scorecard data available.</p>'; return; }
        var rowH = 28, labelW = 160;
        var barW = Math.max(120, (container.clientWidth || 300) - labelW - 100);
        var h = byScorecard.length * rowH + 10;
        var svg = '<svg width="100%" height="' + Math.max(h, 120) + '" viewBox="0 0 ' + (labelW + barW + 100) + ' ' + h + '" preserveAspectRatio="xMinYMin meet" style="overflow:visible;">';
        byScorecard.forEach(function(sc, i) {
          var y = 8 + i * rowH;
          var pct = sc.passRatePct != null ? sc.passRatePct : 0;
          var barLen = (pct / 100) * barW;
          var color = pct >= 80 ? '#10b981' : pct >= 50 ? '#f59e0b' : '#ef4444';
          var name = (sc.scorecardName || sc.scorecardId || '').slice(0, 28);
          if ((sc.scorecardName || sc.scorecardId || '').length > 28) name += '\u2026';
          var tip = "<div class='tip-title'>" + esc(sc.scorecardName || sc.scorecardId) + "</div><div class='tip-val'>" + pct + "% pass rate</div><div class='tip-sub'>" + fmtN(sc.total) + " conversations \u00b7 " + fmtN(sc.passed) + " passed \u00b7 " + fmtN(sc.failed) + " did not pass \u00b7 " + fmtN(sc.totalErrors) + " issues</div>";
          svg += '<text x="0" y="' + (y + 14) + '" font-size="11" fill="#374151">' + esc(name) + '</text>';
          svg += '<rect x="' + labelW + '" y="' + (y - 6) + '" width="' + barW + '" height="16" fill="#f3f4f6" rx="3"/>';
          svg += '<rect x="' + labelW + '" y="' + (y - 6) + '" width="' + Math.max(0, barLen) + '" height="16" fill="' + color + '" rx="3" data-tip="' + esc(tip) + '"/>';
          svg += '<text x="' + (labelW + barW + 6) + '" y="' + (y + 5) + '" font-size="10" fill="#6b7280">' + pct + '%</text>';
        });
        svg += '</svg>';
        container.innerHTML = svg;
      }

      /* 9. Criteria Details Table */
      function renderCriteriaTable(container, criteriaDetails) {
        if (!container) return;
        if (!criteriaDetails || criteriaDetails.length === 0) { container.innerHTML = '<p style="color:#9ca3af;font-size:0.875rem;">No criteria data available.</p>'; return; }
        var sorted = criteriaDetails.slice().sort(function(a, b) {
          var av = a[_critSortCol], bv = b[_critSortCol];
          if (av == null) av = -Infinity; if (bv == null) bv = -Infinity;
          return _critSortAsc ? (av > bv ? 1 : av < bv ? -1 : 0) : (bv > av ? 1 : bv < av ? -1 : 0);
        });
        function arrow(col) { return '<span class="maar-sort-arrow' + (_critSortCol === col ? ' active' : '') + '">' + (_critSortCol === col ? (_critSortAsc ? '\u25B2' : '\u25BC') : '\u25BC') + '</span>'; }
        var sevColors = { critical: '#dc2626', significant: '#f97316', major: '#f59e0b', minor: '#10b981' };
        var sevBg = { critical: '#fef2f2', significant: '#fff7ed', major: '#fffbeb', minor: '#ecfdf5' };
        var sevLabel = { critical: 'Critical', significant: 'Significant', major: 'Major', minor: 'Minor', unknown: 'Unclassified' };
        var colTips = {
          errorName: 'Name of the quality criteria being evaluated',
          timesEvaluated: 'Total times this criteria was checked across all conversations',
          timesFailed: 'Number of times this criteria was triggered',
          failureRatePct: 'Trigger rate = times triggered / times evaluated',
          avgPenaltyPoints: 'Average penalty points when this criteria is triggered',
          severity: 'Severity category of this criteria'
        };
        var h = '<table class="maar-sortable-table" id="maar-crit-table"><thead><tr>';
        h += '<th data-col="errorName" data-tip="' + esc(colTips.errorName) + '">Criteria ' + arrow('errorName') + '</th>';
        h += '<th data-col="timesEvaluated" data-tip="' + esc(colTips.timesEvaluated) + '">Evaluated ' + arrow('timesEvaluated') + '</th>';
        h += '<th data-col="timesFailed" data-tip="' + esc(colTips.timesFailed) + '">Triggered ' + arrow('timesFailed') + '</th>';
        h += '<th data-col="failureRatePct" data-tip="' + esc(colTips.failureRatePct) + '">Rate ' + arrow('failureRatePct') + '</th>';
        h += '<th data-col="avgPenaltyPoints" data-tip="' + esc(colTips.avgPenaltyPoints) + '">Avg penalty ' + arrow('avgPenaltyPoints') + '</th>';
        h += '<th data-col="severity" data-tip="' + esc(colTips.severity) + '">Severity ' + arrow('severity') + '</th>';
        h += '</tr></thead><tbody>';
        sorted.forEach(function(c) {
          var rateClass = c.failureRatePct >= 30 ? 'maar-cell-lo' : c.failureRatePct >= 10 ? 'maar-cell-mid' : 'maar-cell-hi';
          var barColor = c.failureRatePct >= 30 ? '#ef4444' : c.failureRatePct >= 10 ? '#f59e0b' : '#10b981';
          var sColor = sevColors[c.severity] || '#94a3b8';
          var sBg = sevBg[c.severity] || '#f3f4f6';
          h += '<tr>';
          h += '<td>' + esc(c.errorName.slice(0, 50)) + '</td>';
          h += '<td class="maar-cell-num">' + fmtN(c.timesEvaluated) + '</td>';
          h += '<td class="maar-cell-num">' + fmtN(c.timesFailed) + '</td>';
          h += '<td class="maar-cell-num ' + rateClass + '"><span class="maar-cell-bar-wrap"><span class="maar-cell-minibar" style="width:' + Math.max(2, c.failureRatePct * 0.5) + 'px;background:' + barColor + ';"></span></span> ' + c.failureRatePct + '%</td>';
          h += '<td class="maar-cell-num">' + c.avgPenaltyPoints + '</td>';
          h += '<td><span style="display:inline-block;padding:0.15rem 0.5rem;border-radius:6px;font-size:0.7rem;font-weight:600;color:' + sColor + ';background:' + sBg + ';">' + esc(sevLabel[c.severity] || c.severity || 'Unclassified') + '</span></td>';
          h += '</tr>';
        });
        h += '</tbody></table>';
        container.innerHTML = h;
        container.querySelectorAll('th[data-col]').forEach(function(th) {
          th.addEventListener('click', function() {
            var col = th.getAttribute('data-col');
            if (_critSortCol === col) _critSortAsc = !_critSortAsc; else { _critSortCol = col; _critSortAsc = false; }
            renderCriteriaTable(container, criteriaDetails);
          });
        });
      }

      const errEl = $('maar-error');
      try {
        // 0. Fetch creators and scorecards for filters
        try {
          const { creators } = await api('/api/massive-ai-audit/creators');
          const sel = $('filter-created-by');
          if (sel && Array.isArray(creators)) {
            creators.forEach(email => {
              const opt = document.createElement('option');
              opt.value = email;
              opt.textContent = email;
              sel.appendChild(opt);
            });
          }
        } catch (e) { console.warn('[MassiveAI] Creators fetch failed', e); }
        try {
          const scorecards = await api('/api/massive-ai-audit/scorecards');
          const scSel = $('filter-scorecard');
          if (scSel && Array.isArray(scorecards)) {
            scorecards.forEach(sc => {
              const opt = document.createElement('option');
              opt.value = sc.id;
              opt.textContent = sc.name || sc.id;
              scSel.appendChild(opt);
            });
          }
        } catch (e) { console.warn('[MassiveAI] Scorecards fetch failed', e); }

        // 1. Fetch jobs list (with optional filters from URL or defaults)
        await loadBatchesWithFilters();

        $('batches-loading').style.display = 'none';
        setBreadcrumb([{ label: 'All Batches' }]);
        updateBackBtn();

        // Set initial history state
        history.replaceState({ view: 'batches' }, '', window.location.pathname + window.location.search);

        // URL param: jump to batch
        const urlParams = new URLSearchParams(window.location.search);
        const jid = urlParams.get('id');
        if (jid) await goToBatch(jid);

        // Filter Apply / Clear — use button loading state + compact loading strip (fixed placement)
        function setFilterLoading(loading) {
          const applyBtn = $('filter-apply');
          const clearBtn = $('filter-clear');
          if (applyBtn) {
            applyBtn.classList.toggle('is-loading', loading);
            applyBtn.disabled = loading;
            const text = applyBtn.querySelector('.maar-btn-text');
            if (text) text.textContent = loading ? 'Applying…' : 'Apply';
          }
          if (clearBtn) clearBtn.disabled = loading;
          const strip = $('batches-loading');
          if (strip) {
            strip.style.display = loading ? 'flex' : 'none';
            const stripText = strip.querySelector('span');
            if (stripText) stripText.textContent = loading ? 'Loading…' : 'Loading batches…';
          }
          if (!loading) return;
          $('batches-list').style.display = 'none';
          $('page-summary').style.display = 'none';
        }
        if ($('filter-apply')) {
          $('filter-apply').addEventListener('click', async () => {
            setFilterLoading(true);
            try {
              await loadBatchesWithFilters();
            } catch (e) {
              errEl.textContent = e?.message || 'Filter failed';
              errEl.style.display = 'block';
            }
            setFilterLoading(false);
          });
        }
        if ($('filter-clear')) {
          $('filter-clear').addEventListener('click', async () => {
            if ($('filter-created-by')) $('filter-created-by').value = '';
            if ($('filter-status')) $('filter-status').value = '';
            if ($('filter-scorecard')) $('filter-scorecard').value = '';
            if ($('filter-from-date')) $('filter-from-date').value = '';
            if ($('filter-to-date')) $('filter-to-date').value = '';
            setFilterLoading(true);
            try {
              await loadBatchesWithFilters();
            } catch (e) {
              errEl.textContent = e?.message || 'Failed to load';
              errEl.style.display = 'block';
            }
            setFilterLoading(false);
          });
        }

        if ($('tab-batches')) $('tab-batches').addEventListener('click', () => switchTab('batches'));
        if ($('tab-overview')) $('tab-overview').addEventListener('click', () => switchTab('overview'));

        // Poll running/queued/scheduled jobs — use derived status to detect truly active jobs; refetch with current filters
        function hasActiveJobs(jobs) {
          return jobs.some(j => {
            const rc = resultCountsByJob[j.id];
            const st = deriveStatus(j, rc ? rc.count : null);
            return st === 'running' || st === 'queued' || st === 'scheduled';
          });
        }
        if (hasActiveJobs(allJobs)) {
          let timer = setInterval(async () => {
            try {
              const path = buildJobsUrl();
              const fresh = await api(path);
              allJobs = fresh || [];
              await fetchAllJobResults(allJobs);

              if ($('v-batches').classList.contains('active')) renderBatches(allJobs);
              if (curJobId && $('v-batch').classList.contains('active')) { await loadBatch(curJobId); }
              if (!hasActiveJobs(allJobs)) { clearInterval(timer); console.log('[MassiveAI] Poll stopped — all jobs completed'); }
            } catch (e) { console.error('Poll error', e); }
          }, 15000);
        }
      } catch (e) {
        $('batches-loading').style.display = 'none';
        errEl.textContent = e?.message || 'Failed to load data';
        errEl.style.display = 'block';
      }
    })();
  </script>
</body>
</html>
