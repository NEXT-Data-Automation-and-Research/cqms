<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - CQMS</title>
  <!-- Global Styles -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/theme.css">
  <link rel="stylesheet" href="/sidebar.css">
  <!-- User Management Styles (for consistent styling) -->
  <link rel="stylesheet" href="/src/features/settings/user-management/presentation/user-management.css">
  <link rel="stylesheet" href="/src/features/settings/user-management/presentation/user-management-table.css">
  <link rel="stylesheet" href="/src/features/settings/user-management/presentation/user-management-modal.css">
  <!-- User Profile Page Specific Styles -->
  <link rel="stylesheet" href="/src/features/audit-distribution/presentation/styles/user-profile-page.css">
  
  <!-- Import map for npm packages in browser -->
  <script type="importmap">
  {
    "imports": {
      "loglevel": "https://cdn.jsdelivr.net/npm/loglevel@1.9.1/+esm",
      "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm",
      "dompurify": "https://cdn.jsdelivr.net/npm/dompurify@3.3.1/+esm"
    }
  }
  </script>
</head>

<body>
  <!-- Sidebar will be loaded dynamically by load-sidebar.js -->
  <main class="main-content" role="main">
    <!-- Page Heading -->
  <h1 class="page-heading-global">User Profile</h1>
  <div style="margin-bottom: 1.125rem;"></div>

  <!-- Main Content Container -->
  <div class="user-management-container" style="margin-top: 2rem;">
    <div id="user-profile-container">
      <!-- Content will be loaded by user-profile-loader -->
    </div>
  </div>
  </main>

  <!-- Authentication Guard -->
  <script type="module" src="/js/auth-checker.js"></script>
  
  <!-- Initialize Supabase FIRST before any components load -->
  <script type="module">
    import { initSupabase } from '/js/utils/supabase-init.js';
    
    // Initialize Supabase immediately when page loads
    (async function initSupabaseFirst() {
      try {
        await initSupabase();
        console.log('âœ“ Supabase initialized before components');
        // Signal that Supabase is ready
        window.supabaseReady = true;
        window.dispatchEvent(new CustomEvent('supabaseReady'));
      } catch (error) {
        console.error('Failed to initialize Supabase:', error);
      }
    })();
  </script>
  
  <!-- Sidebar Loader -->
  <script type="module" src="/js/load-sidebar.js" defer></script>
  
  <!-- Initialize Supabase Client for DatabaseFactory (like homepage) - MUST run before loader -->
  <script type="module">
    import { initSupabase } from '/js/utils/supabase-init.js';
    import { getAuthenticatedSupabase } from '/js/utils/authenticated-supabase.js';
    
    async function initSecureClient() {
      try {
        // Initialize base Supabase client first (this sets up the API key)
        const baseClient = await initSupabase();
        if (!baseClient) {
          throw new Error('Failed to initialize Supabase client - check that SUPABASE_URL and SUPABASE_ANON_KEY are configured');
        }
        
        // Store base client for DatabaseFactory (required by DatabaseFactory.createClient())
        window.supabaseClient = baseClient;
        
        // Signal that supabaseClient is ready
        window.supabaseClientReady = true;
        window.dispatchEvent(new CustomEvent('supabaseClientReady'));
        
        // For database operations, use getAuthenticatedSupabase() which will verify auth
        try {
          await getAuthenticatedSupabase();
          console.log('Authenticated Supabase client verified');
        } catch (authError) {
          // If not authenticated, redirect to login
          if (authError?.code === 'AUTH_REQUIRED') {
            console.log('User not authenticated, redirecting to login...');
            window.location.href = '/src/auth/presentation/auth-page.html';
            return;
          }
          console.warn('Auth verification failed, but base client is available:', authError);
        }
      } catch (error) {
        console.error('Error initializing Supabase client:', error);
        throw error;
      }
    }
    
    // Initialize immediately (no DOMContentLoaded wait - needs to run ASAP)
    initSecureClient().catch(error => {
      console.error('Failed to initialize secure client:', error);
    });
  </script>
  
  <!-- User Profile Loader - Waits for supabaseClientReady -->
  <script type="module">
    // Wait for supabaseClient to be set before loading
    async function waitForSupabaseClient() {
      if (window.supabaseClientReady && window.supabaseClient) {
        return;
      }
      
      return new Promise((resolve) => {
        if (window.supabaseClientReady && window.supabaseClient) {
          resolve();
          return;
        }
        window.addEventListener('supabaseClientReady', resolve, { once: true });
      });
    }
    
    // Wait for supabaseClient, then load the profile loader
    waitForSupabaseClient().then(() => {
      import('/js/features/audit-distribution/presentation/user-profile-loader.js').then(module => {
        const loader = new module.UserProfileLoader();
        loader.init();
      });
    });
  </script>
  
</body>
</html>

